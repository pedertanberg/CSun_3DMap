import{r as _,N as z,iN as B,iO as q,P as n,Q as y,iP as Z,a7 as W,G as L,a6 as C,a3 as K,R as N,cZ as U,iQ as X,g as J,eF as Y,gN as ee,iR as te,x as re,v as se,iS as ie,iT as ae,U as oe,is as ne,iU as le,a0 as pe,bD as ue,s as V,_ as ye,iV as he,iW as ce,cO as de,e as me,W as fe,hC as ge,et as we,aj as be,c3 as xe,eu as ve}from"./index.347f2ee6.js";import{F as $e}from"./DynamicLayerView3D.f6630392.js";import{c as Pe}from"./ExportImageParameters.1114027d.js";import{n as j}from"./floorFilterUtils.05eb8c6a.js";import{s as T}from"./clickToleranceUtils.974405a9.js";import{i as Fe}from"./sublayerUtils.31d4b536.js";import{a as Ee}from"./drapedUtils.8f9216e3.js";import"./LayerView3D.f1da0554.js";import"./projectExtentUtils.4964cd94.js";import"./ImageMaterial.d515ca27.js";import"./LayerView.936aa3b6.js";import"./RefreshableLayerView.7541f643.js";const A=o=>o.spatialReference.wkid||JSON.stringify(o.spatialReference);function Ie(o,s){const{dpi:r,gdbVersion:t,geometry:e,geometryPrecision:i,height:c,layerOption:u,mapExtent:a,maxAllowableOffset:l,returnFieldName:p,returnGeometry:h,returnUnformattedValues:g,returnZ:P,spatialReference:v,timeExtent:$,tolerance:m,width:E}=o.toJSON(),{dynamicLayers:w,layerDefs:f,layerIds:b}=_e(o),G=s&&_(s.geometry)?s.geometry:null,x={geometryPrecision:i,maxAllowableOffset:l,returnFieldName:p,returnGeometry:h,returnUnformattedValues:g,returnZ:P,tolerance:m},I=G&&G.toJSON()||e;if(x.imageDisplay=`${E},${c},${r}`,t&&(x.gdbVersion=t),I&&(delete I.spatialReference,x.geometry=JSON.stringify(I),x.geometryType=z(I)),v?x.sr=v.wkid||JSON.stringify(v):I&&I.spatialReference?x.sr=A(I):a&&a.spatialReference&&(x.sr=A(a)),x.time=$?[$.start,$.end].join(","):null,a){const{xmin:Q,ymin:H,xmax:D,ymax:k}=a;x.mapExtent=`${Q},${H},${D},${k}`}return f&&(x.layerDefs=f),w&&!f&&(x.dynamicLayers=w),x.layers=u==="popup"?"visible":u,b&&!w&&(x.layers+=`:${b.join(",")}`),x}function _e(o){var v,$;const{mapExtent:s,floors:r,width:t,sublayers:e,layerIds:i,layerOption:c,gdbVersion:u}=o,a=($=(v=e==null?void 0:e.find(m=>m.layer!=null))==null?void 0:v.layer)==null?void 0:$.serviceSublayers,l=c==="popup",p={},h=B({extent:s,width:t,spatialReference:s==null?void 0:s.spatialReference}),g=[],P=m=>{const E=h===0,w=m.minScale===0||h<=m.minScale,f=m.maxScale===0||h>=m.maxScale;if(m.visible&&(E||w&&f))if(m.sublayers)m.sublayers.forEach(P);else{if((i==null?void 0:i.includes(m.id))===!1||l&&(!m.popupTemplate||!m.popupEnabled))return;g.unshift(m)}};if(e==null||e.forEach(P),e&&!g.length)p.layerIds=[];else{const m=Fe(g,a,u),E=g.map(w=>{const f=j(r,w);return w.toExportImageJSON(f)});if(m)p.dynamicLayers=JSON.stringify(E);else{if(e){let f=g.map(({id:b})=>b);i&&(f=f.filter(b=>i.includes(b))),p.layerIds=f}else i!=null&&i.length&&(p.layerIds=i);const w=Ne(r,g);if(_(w)&&w.length){const f={};for(const b of w)b.definitionExpression&&(f[b.id]=b.definitionExpression);Object.keys(f).length&&(p.layerDefs=JSON.stringify(f))}}}return p}function Ne(o,s){const r=!!(o!=null&&o.length),t=s.filter(e=>e.definitionExpression!=null||r&&e.floorInfo!=null);return t.length?t.map(e=>{const i=j(o,e),c=q(i,e.definitionExpression);return{id:e.id,definitionExpression:c}}):null}var O;let d=O=class extends U{constructor(o){super(o),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(o){return X(O,o)}};n([y({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),n([y()],d.prototype,"floors",void 0),n([y({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),n([y({types:Z,json:{read:W,write:!0}})],d.prototype,"geometry",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"height",void 0),n([y({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),n([y({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),n([y({type:L,json:{write:!0}})],d.prototype,"mapExtent",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),n([y({type:C,json:{write:!0}})],d.prototype,"spatialReference",void 0),n([y()],d.prototype,"sublayers",void 0),n([y({type:K,json:{write:!0}})],d.prototype,"timeExtent",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=O=n([N("esri.rest.support.IdentifyParameters")],d);const M=d;let F=class extends U{constructor(o){super(o),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(o,s){return J.fromJSON({attributes:{...s.attributes},geometry:{...s.geometry}})}writeFeature(o,s){if(!o)return;const{attributes:r,geometry:t}=o;r&&(s.attributes={...r}),_(t)&&(s.geometry=t.toJSON(),s.geometryType=te.toJSON(t.type))}};n([y({type:String,json:{write:!0}})],F.prototype,"displayFieldName",void 0),n([y({type:J})],F.prototype,"feature",void 0),n([Y("feature",["attributes","geometry"])],F.prototype,"readFeature",null),n([ee("feature")],F.prototype,"writeFeature",null),n([y({type:Number,json:{write:!0}})],F.prototype,"layerId",void 0),n([y({type:String,json:{write:!0}})],F.prototype,"layerName",void 0),F=n([N("esri.rest.support.IdentifyResult")],F);const Re=F;async function Oe(o,s,r){const t=(s=je(s)).geometry?[s.geometry]:[],e=re(o);return e.path+="/identify",se(t).then(i=>{const c=Ie(s,{geometry:i&&i[0]}),u=ie({...e.query,f:"json",...c}),a=ae(u,r);return oe(e.path,a).then(Se).then(l=>Ge(l,s.sublayers))})}function Se(o){const s=o.data;return s.results=s.results||[],s.exceededTransferLimit=Boolean(s.exceededTransferLimit),s.results=s.results.map(r=>Re.fromJSON(r)),s}function je(o){return o=M.from(o)}function Ge(o,s){if(!(s!=null&&s.length))return o;const r=new Map;function t(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(t)}s.forEach(t);for(const e of o.results)e.feature.sourceLayer=r.get(e.layerId);return o}let R=null;const Ve=o=>{let s=class extends o{constructor(){super(...arguments),this._featuresResolutions=new WeakMap,this.highlightGraphics=new le,this.updateHighlightedFeatures=pe(async r=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(r).catch(()=>{}))})}initialize(){this.exportImageParameters=new Pe({layer:this.layer}),this.handles.add([ue(()=>this.highlightGraphics,"change",r=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(r.added).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var r;return(r=this.exportImageParameters)==null||r.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(r,t){var c,u,a,l,p,h;const{layer:e}=this;if(!r)throw new V("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:e});const i=(a=(u=(c=this.layer.capabilities)==null?void 0:c.operations)==null?void 0:u.supportsQuery)!=null?a:!0;if(!(((h=(p=(l=this.layer.capabilities)==null?void 0:l.operations)==null?void 0:p.supportsIdentify)!=null?h:!0)&&this.layer.version>=10.5)&&!i)throw new V("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:e});return i?this._fetchPopupFeaturesUsingQueries(r,t):this._fetchPopupFeaturesUsingIdentify(r,t)}canResume(){var r;return!!super.canResume()&&!((r=this.timeExtent)!=null&&r.isEmpty)}async _updateHighlightedFeaturesSymbols(r){for(const t of r){const e="renderer"in t.sourceLayer&&t.sourceLayer.renderer;"geometryType"in t.sourceLayer&&t.sourceLayer.geometryType==="point"&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(t).then(async i=>{var a;let c="width"in i&&"height"in i&&i.width!=null&&i.height!=null?Math.max(i.width,i.height):"size"in i?i.size:null;const u="visualVariables"in e&&((a=e.visualVariables)==null?void 0:a.find(l=>l.type==="size"));u&&(R||(R=(await ye(()=>import("./index.347f2ee6.js").then(l=>l.ug),["assets/index.347f2ee6.js","assets/index.a651de9c.css"])).getSize),c=R(u,t,{view:this.view.type,scale:this.view.scale,shape:i.type==="simple-marker"?i.style:null})),this.highlightGraphics.includes(t)&&(t.symbol=new he({style:"square",size:c,xoffset:"xoffset"in i?i.xoffset:0,yoffset:"yoffset"in i?i.yoffset:0}),t.visible=!0,this.highlightGraphicUpdated(t,"symbol"))})}}async _updateHighlightedFeaturesGeometries(r){this._highlightGeometriesResolution=r;const t=this.highlightGraphics;if(!t.length||!this.layer.capabilities.operations.supportsQuery)return;const e=this._getTargetResolution(r),i=new Map;for(const a of t)if(!this._featuresResolutions.has(a)||this._featuresResolutions.get(a)>e){const l=a.sourceLayer;ce(i,l,()=>new Map).set(a.getObjectId(),a)}const c=Array.from(i,([a,l])=>{const p=a.createQuery();return p.objectIds=[...l.keys()],p.outFields=[a.objectIdField],p.returnGeometry=!0,p.maxAllowableOffset=e,p.outSpatialReference=this.view.spatialReference,a.queryFeatures(p)}),u=await Promise.all(c);if(!this.destroyed)for(const{features:a}of u)for(const l of a){const p=l.sourceLayer,h=i.get(p).get(l.getObjectId());h&&this.highlightGraphics.includes(h)&&(h.geometry=l.geometry,this.highlightGraphicUpdated(h,"geometry"),this._featuresResolutions.set(h,e))}}_getTargetResolution(r){const t=r*de(this.view.spatialReference),e=t/16;return e<=10?0:r/t*e}async _fetchPopupFeaturesUsingIdentify(r,t){const e=await this._createIdentifyParameters(r,t);if(me(e))return[];const{results:i}=await Oe(this.layer.parsedUrl,e);return i.map(c=>c.feature)}async _createIdentifyParameters(r,t){const{floors:e,spatialReference:i,scale:c}=this.view,u=_(t)?t.event:null,a=await this._collectPopupProviders(this.layer.sublayers,c,t);if(!a.length)return null;await Promise.all(a.map(({sublayer:v})=>v.load().catch(()=>{})));const l=Math.min(fe("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((v,$)=>$.renderer?T({renderer:$.renderer,event:u}):v,2)),p=this.createFetchPopupFeaturesQueryGeometry(r,l),h=ge(c,i),g=Math.round(p.width/h),P=new L({xmin:p.center.x-h*g,ymin:p.center.y-h*g,xmax:p.center.x+h*g,ymax:p.center.y+h*g,spatialReference:p.spatialReference});return new M({floors:e,gdbVersion:this.layer.gdbVersion,geometry:r,height:g,layerOption:"popup",mapExtent:P,returnGeometry:!0,spatialReference:i,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:l,width:g})}async _fetchPopupFeaturesUsingQueries(r,t){const e=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,t),i=_(t)?t.event:null,c=e.map(async({sublayer:u,popupTemplate:a})=>{var E,w;await u.load().catch(()=>{});const l=u.createQuery(),p=T({renderer:u.renderer,event:i}),h=this.createFetchPopupFeaturesQueryGeometry(r,p);if(l.geometry=h,l.outFields=await we(u,a),l.timeExtent=this.timeExtent,"floors"in this.view){const f=(w=(E=this.view)==null?void 0:E.floors)==null?void 0:w.clone(),b=j(f,u);_(b)&&(l.where=l.where?`(${l.where}) AND (${b})`:b)}const g=this._getTargetResolution(h.width/p),P=await this._loadArcadeModules(a),v=u.geometryType==="point"||P&&P.arcadeUtils.hasGeometryOperations(a);v||(l.maxAllowableOffset=g);const{features:$}=await u.queryFeatures(l),m=v?0:g;for(const f of $)this._featuresResolutions.set(f,m);return $});return(await be(c)).reverse().reduce((u,a)=>a.value?[...u,...a.value]:u,[]).filter(u=>u!=null)}async _collectPopupProviders(r,t,e){const i=[],c=async a=>{const l=a.minScale===0||t<=a.minScale,p=a.maxScale===0||t>=a.maxScale;if(a.visible&&l&&p){if(a.sublayers)a.sublayers.forEach(c);else if(a.popupEnabled){const h=ve(a,{...e,defaultPopupTemplateEnabled:!1});_(h)&&i.unshift({sublayer:a,popupTemplate:h})}}},u=r.toArray().reverse().map(c);return await Promise.all(u),i}_loadArcadeModules(r){var t;if(((t=r.expressionInfos)==null?void 0:t.length)||Array.isArray(r.content)&&r.content.some(e=>e.type==="expression"))return xe()}};return n([y()],s.prototype,"highlightGraphics",void 0),n([y()],s.prototype,"exportImageParameters",void 0),n([y({readOnly:!0})],s.prototype,"exportImageVersion",null),n([y()],s.prototype,"layer",void 0),n([y()],s.prototype,"suspended",void 0),n([y(ne)],s.prototype,"timeExtent",void 0),s=n([N("esri.views.layers.MapImageLayerView")],s),s};let S=class extends Ve($e){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(()=>this.exportImageVersion,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(o,s){return Ee(o,s,this.view)}highlight(o){return{remove:()=>{}}}highlightGraphicUpdated(o,s){}getFetchOptions(){return{timeExtent:this.timeExtent}}};S=n([N("esri.views.3d.layers.MapImageLayerView3D")],S);const qe=S;export{qe as default};
