import{kw as Qs,kv as Pt,tw as lt,tx as Js,ty as Se,tz as ss,hs as ht,tA as At,tB as ge,tC as be,P as R,Q as D,R as ke,T as ti,aC as ei,kQ as si,kg as ii,s as ft,fl as Rt,e as W,r as $,tD as Be,hX as Oe,a2 as he,hB as x,rL as ki,ad as Ct,g1 as ri,tE as Bi,bj as se,b7 as Oi,d0 as Di,oy as Gi,bc as ot,oK as Ni,oE as ni,oF as ai,al as Ki,L as Zi,oz as Ui,oA as qi,oB as Xi,oC as Hi,tF as is,tG as rs,tH as ns,aI as De,d2 as as,oq as Yi,_ as oi,pC as ji,qX as Qi,aH as Ji,pB as os,a6 as tr,w as er}from"./index.347f2ee6.js";import{g as sr,h as hi,j as ir,k as rr,l as xe,n as nr,q as li,u as ci,v as Te,w as ar,x as or,y as hr,f as lr,d as Zt,T as cr}from"./cimAnalyzer.07c3575e.js";import{l as ui,f as ur,G as Ie,e as fr,t as dr,p as fi}from"./Pipeline.e5b86b67.js";import{E as w,S as A,A as N,_ as Ut}from"./TileInfoView.2ed0d6a8.js";import{s as Le,t as _r,o as gt,v as mr,x as di,r as G,z as F,D as pr,E as yr,F as gr,G as pt,H as xr,I as vr,J as P,f as qt,L as _i,X as Mr,e as hs,M as wr,Q as mi,V as le,W as pi}from"./enums.6b5e3ac2.js";import{l as Sr,p as br}from"./tileUtils.1cefcafb.js";import{n as yi,r as Tr,c as Ir,i as Lr}from"./TileClipper.b43beef6.js";import{x as V,w as M}from"./number.30628ef2.js";import{t as zr,M as ze}from"./GeometryUtils.12948ca8.js";import{s as gi}from"./Geometry.d049a63c.js";function E(r){if(!r)return 0;const{r:t,g:e,b:s,a:i}=r;return V(t*i,e*i,s*i,255*i)}function et(r){if(!r)return 0;const[t,e,s,i]=r;return V(t*(i/255),e*(i/255),s*(i/255),i)}class yt{constructor(t,e,s,i){this.center=Qs(t,e),this.centerT=Pt(),this.halfWidth=s/2,this.halfHeight=i/2,this.width=s,this.height=i}get x(){return this.center[0]}get y(){return this.center[1]}get blX(){return this.center[0]+this.halfWidth}get blY(){return this.center[1]+this.halfHeight}get trX(){return this.center[0]-this.halfWidth}get trY(){return this.center[1]-this.halfHeight}get xmin(){return this.x-this.halfWidth}get xmax(){return this.x+this.halfWidth}get ymin(){return this.y-this.halfHeight}get ymax(){return this.y+this.halfHeight}set x(t){this.center[0]=t}set y(t){this.center[1]=t}clone(){return new yt(this.x,this.y,this.width,this.height)}serialize(t){return t.writeF32(this.center[0]),t.writeF32(this.center[1]),t.push(this.width),t.push(this.height),t}findCollisionDelta(t,e=4){const s=Math.abs(t.centerT[0]-this.centerT[0]),i=Math.abs(t.centerT[1]-this.centerT[1]),n=(t.halfWidth+this.halfWidth+e)/s,a=(t.halfHeight+this.halfHeight+e)/i,o=Math.min(n,a);return Math.log2(o)}extend(t){const e=Math.min(this.xmin,t.xmin),s=Math.min(this.ymin,t.ymin),i=Math.max(this.xmax,t.xmax)-e,n=Math.max(this.ymax,t.ymax)-s,a=e+i/2,o=s+n/2;this.width=i,this.height=n,this.halfWidth=i/2,this.halfHeight=n/2,this.x=a,this.y=o}static deserialize(t){const e=t.readF32(),s=t.readF32(),i=t.readInt32(),n=t.readInt32();return new yt(e,s,i,n)}}const Ge=26,xi=4,Pr=Ge+xi,$r=Ge-6,ls=3,rt=8,Er=Math.PI/180;class vi{constructor(t,e,s,i){this._rotationT=lt(),this._xBounds=0,this._yBounds=0,this.minZoom=0,this.maxZoom=255,this._bounds=null;const n=s.rect,a=new Float32Array(8);t*=i,e*=i;const o=s.code?n.width*i:s.metrics.width,h=s.code?n.height*i:s.metrics.height;a[0]=t,a[1]=e,a[2]=t+o,a[3]=e,a[4]=t,a[5]=e+h,a[6]=t+o,a[7]=e+h,this._data=a,this._setTextureCoords(n),this._scale=i,this._mosaic=s,this.x=t,this.y=e,this.maxOffset=Math.max(t+o,e+h)}get width(){return this._mosaic.metrics.width*this._scale}get mosaic(){return this._mosaic}set angle(t){this._angle=t,Js(this._rotationT,-t),this._setOffsets(this._data)}get angle(){return this._angle}get xTopLeft(){return this._data[0]}get yTopLeft(){return this._data[1]}get xBottomRight(){return this._data[6]}get yBottomRight(){return this._data[7]}get texcoords(){return this._texcoords}get textureBinding(){return this._mosaic.textureBinding}get offsets(){return this._offsets||this._setOffsets(this._data),this._offsets}get char(){return String.fromCharCode(this._mosaic.code)}get code(){return this._mosaic.code}get bounds(){if(!this._bounds){const{height:t,width:e}=this._mosaic.metrics,s=e*this._scale,i=Math.abs(t)*this._scale,n=new Float32Array(8);n[0]=this.x,n[1]=this.y,n[2]=this.x+s,n[3]=this.y,n[4]=this.x,n[5]=this.y+i,n[6]=this.x+s,n[7]=this.y+i;const a=Se(lt(),this._rotationT,this._transform);ss(n,n,a);let o=1/0,h=1/0,l=0,c=0;for(let _=0;_<4;_++){const p=n[2*_],y=n[2*_+1];o=Math.min(o,p),h=Math.min(h,y),l=Math.max(l,p),c=Math.max(c,y)}const u=l-o,d=c-h,f=o+u/2,m=h+d/2;this._bounds=new yt(f,m,u,d)}return this._bounds}setTransform(t){this._transform=t,this._offsets=null}_setOffsets(t){this._offsets||(this._offsets={upperLeft:0,upperRight:0,lowerLeft:0,lowerRight:0});const e=this._offsets,s=new Float32Array(8),i=Se(lt(),this._rotationT,this._transform);ss(s,t,i),e.upperLeft=M(s[0]*rt,s[1]*rt),e.upperRight=M(s[2]*rt,s[3]*rt),e.lowerLeft=M(s[4]*rt,s[5]*rt),e.lowerRight=M(s[6]*rt,s[7]*rt)}_setTextureCoords({x:t,y:e,width:s,height:i}){this._texcoords={upperLeft:M(t,e),upperRight:M(t+s,e),lowerLeft:M(t,e+i),lowerRight:M(t+s,e+i)}}}const Cr=(r,t)=>({code:0,page:0,sdf:!0,rect:new zr(0,0,11,8),textureBinding:t,metrics:{advance:0,height:4,width:r,left:0,top:0}});class Vr{constructor(t,e,s){this._rotation=0,this._decorate(t,e,s),this.glyphs=t,this.bounds=this._createBounds(t),this.isMultiline=e.length>1,this._hasRotation=s.angle!==0,this._transform=this._createGlyphTransform(this.bounds,s);for(const i of t)i.setTransform(this._transform)}setRotation(t){if(t===0&&this._rotation===0)return;this._rotation=t;const e=this._transform,s=Js(lt(),t);Se(e,s,e);for(const i of this.glyphs)i.setTransform(this._transform)}_decorate(t,e,s){if(!s.decoration||s.decoration==="none"||!t.length)return;const i=s.scale,n=s.decoration==="underline"?Pr:$r,a=t[0].textureBinding;for(const o of e){const h=o.startX*i,l=o.startY*i,c=(o.width+o.glyphWidthEnd)*i;t.push(new vi(h,l+n*i,Cr(c,a),1))}}get boundsT(){const t=this.bounds,e=ht(Pt(),t.x,t.y);if(At(e,e,this._transform),this._hasRotation){const s=Math.max(t.width,t.height);return new yt(e[0],e[1],s,s)}return new yt(e[0],e[1],t.width,t.height)}_createBounds(t){let e=1/0,s=1/0,i=0,n=0;for(const h of t)e=Math.min(e,h.xTopLeft),s=Math.min(s,h.yTopLeft),i=Math.max(i,h.xTopLeft+h.width),n=Math.max(n,h.yBottomRight);const a=i-e,o=n-s;return new yt(e+a/2,s+o/2,a,o)}_createGlyphTransform(t,e){const s=Er*e.angle,i=lt(),n=Pt();return ge(i,i,ht(n,e.xOffset,-e.yOffset)),e.isCIM?be(i,i,s):(ge(i,i,ht(n,t.x,t.y)),be(i,i,s),ge(i,i,ht(n,-t.x,-t.y))),i}}class Xt{constructor(t,e,s,i,n,a){this.glyphWidthEnd=0,this.startX=0,this.startY=0,this.start=Math.max(0,Math.min(e,s)),this.end=Math.max(0,Math.max(e,s)),this.end<t.length&&(this.glyphWidthEnd=t[this.end].metrics.width),this.width=i,this.yMin=n,this.yMax=a}}const Pe=r=>r===10,cs=r=>r===32;function Ar(r,t,e){const s=new Array,i=1/e.scale,n=e.maxLineWidth*i,a=t?r.length-1:0,o=t?-1:r.length,h=t?-1:1;let l=a,c=0,u=0,d=l,f=d,m=0,_=1/0,p=0;for(;l!==o;){const{code:g,metrics:v}=r[l],S=Math.abs(v.top);if(Pe(g)||cs(g)||(_=Math.min(_,S),p=Math.max(p,S+v.height)),Pe(g))l!==a&&(s.push(new Xt(r,d,l-h,c,_,p)),_=1/0,p=0),c=0,d=l+h,f=l+h,u=0;else if(cs(g))f=l+h,u=0,m=v.advance,c+=v.advance;else if(c>n){if(f!==d){const I=f-2*h;c-=m,s.push(new Xt(r,d,I,c-u,_,p)),_=1/0,p=0,d=f,c=u}else s.push(new Xt(r,d,l-h,c,_,p)),_=1/0,p=0,d=l,f=l,c=0;c+=v.advance,u+=v.advance}else c+=v.advance,u+=v.advance;l+=h}const y=new Xt(r,d,l-h,c,_,p);return y.start>=0&&y.end<r.length&&s.push(y),s}function Fr(r,t){let e=0;for(let n=0;n<r.length;n++){const{width:a}=r[n];e=Math.max(a,e)}const s=t.decoration==="underline"?xi:0,i=r[0].yMin;return{x:0,y:i,height:r[r.length-1].yMax+t.lineHeight*(r.length-1)+s-i,width:e}}function Rr(r,t,e){const s=e.scale,i=new Array,n=Ar(r,t,e),a=Fr(n,e),{vAlign:o,hAlign:h}=e,l=o===sr.Baseline?1:0,c=l?0:o-1,u=(1-l)*-a.y+c*(a.height/2)+(l?1:0)*-Ge;for(let d=0;d<n.length;d++){const{start:f,end:m,width:_}=n[d];let p=-1*(h+1)*(_/2)-ls;const y=d*e.lineHeight+u-ls;n[d].startX=p,n[d].startY=y;for(let g=f;g<=m;g++){const v=r[g];if(Pe(v.code))continue;const S=new vi(p+v.metrics.left,y-v.metrics.top,v,s);p+=v.metrics.advance,i.push(S)}}return new Vr(i,n,e)}function Wr(r,t){return r.length=0,t.forEach(e=>r.push(e)),r}const ve=new Set,Ht=[],wt=new Map,us=[0,0];let nt=class extends ti{constructor(r){super(r),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:r,process:t}=this;this._queue=new ui({concurrency:r,process:(e,s)=>{const i=this._keyToItem.get(e);return t(i,{signal:s})},peeker:e=>e.values().next().value})}destroy(){this.clear(),this._queue=ei(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(r){const t=typeof r=="string"?r:r.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(r){return typeof r=="string"?this._keyToItem.has(r):this._keyToItem.has(r.id)}isOngoing(r){const t=typeof r=="string"?r:r.id;return this.has(t)&&this._queue.isOngoing(t)}pause(){this._queue.pause()}push(r,t){const e=r.key.id+"-"+t;if(this.has(e))return this.get(e);const s=this._queue.push(e),i=()=>{this._keyToItem.delete(e),this.notifyChange("updating")};return this._keyToItem.set(e,r),s.then(i,i),this.notifyChange("updating"),s}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView;let e=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;r.forEach(l=>{const c=this._keyToItem.get(l),u=this.tileInfoView.getTileScale(c.key);wt.has(u)||(wt.set(u,[]),e=Math.max(u,e),s=Math.min(u,s)),wt.get(u).push(c.key),ve.add(u)});let i=this.state.scale;wt.has(i)||(Wr(Ht,ve),Ht.sort((l,c)=>l-c),i=Ht.reduce((l,c)=>Math.abs(c-i)<Math.abs(l-i)?c:l,Ht[0])),i=Math.min(i,e),i=Math.max(i,s);const n=wt.get(i),a=t.getClosestInfoForScale(i),o=a.getColumnForX(this.state.center[0]),h=a.getRowForY(this.state.center[1]);return n.sort((l,c)=>{const u=a.denormalizeCol(l.col,l.world),d=a.denormalizeCol(c.col,c.world);return Math.sqrt((o-u)*(o-u)+(h-l.row)*(h-l.row))-Math.sqrt((o-d)*(o-d)+(h-c.row)*(h-c.row))}),ve.clear(),wt.clear(),n[0].id}_peekByCenterFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView,e=this.state.center;let s,i=Number.POSITIVE_INFINITY;return r.forEach(n=>{const a=this._keyToItem.get(n);t.getTileCoords(us,a.key);const o=si(us,e);o<i&&(i=o,s=a.key)}),s.id}};R([D({constructOnly:!0})],nt.prototype,"concurrency",void 0),R([D({constructOnly:!0})],nt.prototype,"process",void 0),R([D()],nt.prototype,"state",void 0),R([D({constructOnly:!0})],nt.prototype,"strategy",void 0),R([D({constructOnly:!0})],nt.prototype,"tileInfoView",void 0),R([D({readOnly:!0})],nt.prototype,"updating",null),nt=R([ke("esri.views.2d.tiling.PagedTileQueue")],nt);function kr(r,t){return r.length=0,t.forEach(e=>r.push(e)),r}const Me=new Set,Yt=[],St=new Map,fs=[0,0];let at=class extends ti{constructor(r){super(r),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:r,process:t,strategy:e}=this;this._queue=new ui({concurrency:r,process:(s,i)=>{const n=this._keyToItem.get(s);return t(n,{signal:i})},peeker:e==="scale-first"?s=>this._peekByScaleFirst(s):s=>this._peekByCenterFirst(s)})}destroy(){this.clear(),this._queue=ei(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(r){const t=typeof r=="string"?r:r.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(r){return typeof r=="string"?this._keyToItem.has(r):this._keyToItem.has(r.id)}isOngoing(r){const t=typeof r=="string"?r:r.id;return this.has(t)&&this._queue.isOngoing(t)}pause(){this._queue.pause()}push(r){const t=r.key.id;if(this._queue.has(t))return this._queue.get(t);const e=this._queue.push(t),s=()=>{this._keyToItem.delete(t),this.notifyChange("updating")};return this._keyToItem.set(t,r),e.then(s,s),this.notifyChange("updating"),e}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView;let e=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;r.forEach(l=>{const c=this._keyToItem.get(l),u=this.tileInfoView.getTileScale(c.key);St.has(u)||(St.set(u,[]),e=Math.max(u,e),s=Math.min(u,s)),St.get(u).push(c.key),Me.add(u)});let i=this.state.scale;St.has(i)||(kr(Yt,Me),Yt.sort((l,c)=>l-c),i=Yt.reduce((l,c)=>Math.abs(c-i)<Math.abs(l-i)?c:l,Yt[0])),i=Math.min(i,e),i=Math.max(i,s);const n=St.get(i),a=t.getClosestInfoForScale(i),o=a.getColumnForX(this.state.center[0]),h=a.getRowForY(this.state.center[1]);return n.sort((l,c)=>{const u=a.denormalizeCol(l.col,l.world),d=a.denormalizeCol(c.col,c.world);return Math.sqrt((o-u)*(o-u)+(h-l.row)*(h-l.row))-Math.sqrt((o-d)*(o-d)+(h-c.row)*(h-c.row))}),Me.clear(),St.clear(),n[0].id}_peekByCenterFirst(r){if(!this.state)return r.values().next().value;const t=this.tileInfoView,e=this.state.center;let s,i=Number.POSITIVE_INFINITY;return r.forEach(n=>{const a=this._keyToItem.get(n);t.getTileCoords(fs,a.key);const o=si(fs,e);o<i&&(i=o,s=a.key)}),s.id}};R([D({constructOnly:!0})],at.prototype,"concurrency",void 0),R([D({constructOnly:!0})],at.prototype,"process",void 0),R([D()],at.prototype,"state",void 0),R([D({constructOnly:!0})],at.prototype,"strategy",void 0),R([D({constructOnly:!0})],at.prototype,"tileInfoView",void 0),R([D({readOnly:!0})],at.prototype,"updating",null),at=R([ke("esri.views.2d.tiling.TileQueue")],at);new ii(0,0,0,0);const Lt=new Map;function Br(r,t,e){const{indicesPerRecord:s,multiplier:i,verticesPerRecord:n}=Lt.get(r);return{recordBytes:e*Le*Uint32Array.BYTES_PER_ELEMENT,indexBytes:i*s*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:i*n*e*t}}Lt.set(w.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),Lt.set(w.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),Lt.set(w.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),Lt.set(w.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),Lt.set(w.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});const Or=1.25;class jt{constructor(t,e){this._pos=0;const s=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(s),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(t,e){const s=Math.round(t);return s+(e-s%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*Or,this._buffer.BYTES_PER_ELEMENT),s=new ArrayBuffer(e),i=new this._ctor(s);i.set(this._buffer,0),this._array=s,this._buffer=i,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,s){this._i16View[2*t]+=e,this._i16View[2*t+1]+=s}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,s){this._ensureSize(s-e);for(let i=e;i!==s;i++)this.writeFixed(t._buffer[i])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,e=[];for(let s=0;s<t.byteLength/4;s++)e.push(t[s]);return e}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}class ds{constructor(t,e,s){this._start={index:0,vertex:0};const i=Br(t,e,s),n=e/4;this.geometryType=t,this._records=new jt(Int32Array,i.recordBytes),this._indices=new jt(Uint32Array,i.indexBytes),this._vertices=new jt(Uint32Array,i.vertexBytes),this._metrics=new jt(Float32Array,0),this._strideInt=n}serialize(t){const e=this._records.buffer(),s=this._indices.buffer(),i=this._vertices.buffer(),n=this._metrics.length?this._metrics.buffer():null,a=4*this._strideInt;return t.push(e,s,i),{stride:a,records:e,indices:s,vertices:i,metrics:n}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/Le}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,s,i,n,a,o,h){this._records.push(t),this._records.push(e),this._records.push(s),this._records.push(i),this._records.push(n),this._records.push(a),this._records.push(o),this._records.writeF32(h)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,s){const i=t._records.length-Le,n=t._records.getValue(i),a=t._records.getValue(i+1),o=t._records.getValue(i+2),h=t._records.getValue(i+4),l=t._records.getValue(i+6),c=t._records.getValue(i+7),u=this._vertices.length,d=(t._start.vertex-this._vertices.length)/this._strideInt,f=this._indices.length,m=this.vertexCount;for(let _=t._start.index;_!==t._indices.length;_++){const p=t._indices.getValue(_);this._indices.push(p-d)}for(let _=t._start.vertex;_!==t._vertices.length;_++){const p=t._vertices.getValue(_);this._vertices.push(p)}for(let _=u;_<=this._vertices.length;_+=this._strideInt)this._vertices.i1616Add(_,e,s);this._records.push(n),this._records.push(a),this._records.push(o),this._records.push(f),this._records.push(h),this._records.push(m),this._records.push(l),this._records.push(c)}}const ce=1,Ne=2,ue=4,Ke=8,Ze=16,fe=32,Ue=64,de=128;function _s(r){switch(r){case ce:case Ke:case fe:return-1;case Ne:case Ue:return 0;case ue:case Ze:case de:return 1}}function ms(r){switch(r){case ce:case Ne:case ue:return-1;case Ke:case Ze:return 0;case fe:case Ue:case de:return 1}}const ps=ce|Ke|fe,ys=ue|Ze|de,gs=ce|Ne|ue,xs=fe|Ue|de;class Dr{constructor(t,e,s,i,n,a=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=i,this._pixelBufferEnabled=n,this._version=a,this._symbologyType=s}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((s,i)=>{const n=1<<i,a=_s(n),o=ms(n),h=Sr(new ii(this.tileKey),a,o,t),l=this._serializeTileVertexData(this.tileKey,h.id,s.vertexData);l.message.bufferIds=s.displayIds,e.push(l)}),e}_serializeTileVertexData(t,e,s){var n,a,o,h,l;const i=new Array;return{message:{tileKeyOrigin:t,tileKey:e,data:{[w.MARKER]:(n=s.get(w.MARKER))==null?void 0:n.serialize(i),[w.FILL]:(a=s.get(w.FILL))==null?void 0:a.serialize(i),[w.LINE]:(o=s.get(w.LINE))==null?void 0:o.serialize(i),[w.TEXT]:(h=s.get(w.TEXT))==null?void 0:h.serialize(i),[w.LABEL]:(l=s.get(w.LABEL))==null?void 0:l.serialize(i)},version:this._version},transferList:i}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,s,i){this._current.writer=this._getVertexWriter(s),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=i,this._current.id=t,this._current.materialKey=e,this._current.geometryType=s,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,s,i){this._current.bufferingEnabled&&this._addOverlap(t,e,s,i)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,s,i,n,a,o,h){this._current.writer=this._getVertexWriter(w.LABEL);const l=this._current.writer.metricWriter;l.push(ur(t)),l.push(e),l.push(s),l.push(i),l.push(n),l.push(a),l.push(o),l.push(h),l.push(255),this._current.metricBoxLenPointer=l.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,s,i){const n=this._current.writer.metricWriter;n.incr(this._current.metricBoxLenPointer),n.push(0),n.push(0),n.push(t),n.push(e),n.push(s),n.push(i)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const s=this._current.indexStart,i=this._current.writer.indexCount-s;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,s,i,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===w.LABEL)return!0;const n=this._current.writer;for(let a=0;a<8;a++){const o=1<<a;if(this._current.overlaps&o){this._data.neighbors[a]||(this._data.neighbors[a]={vertexData:new Map,displayIds:new Set});const h=this._data.neighbors[a],l=this._current.geometryType;if(!h.vertexData.has(l)){const m=Ie(l,this._symbologyType).geometry,_=new ds(l,m,_r);h.vertexData.set(l,_)}const c=h.vertexData.get(this._current.geometryType),u=8,d=512*-_s(o)*u,f=512*-ms(o)*u;c.copyLastFrom(n,d,f),h.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,s,i){const n=255^((t<0+s?ys:t>=gt-s?ps:ys|ps)|(e<0+i?xs:e>=gt-i?gs:xs|gs));this._current.overlaps|=n}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,s=Ie(t,this._symbologyType).geometry;e.set(t,new ds(t,s,this.hint.records))}return this._data.self.get(t)}}function Gr(r,t,e){const s=N.SIZE_FIELD_STOPS|N.SIZE_MINMAX_VALUE|N.SIZE_SCALE_STOPS|N.SIZE_UNIT_VALUE,i=(t&(Ut.FIELD_TARGETS_OUTLINE|Ut.MINMAX_TARGETS_OUTLINE|Ut.SCALE_TARGETS_OUTLINE|Ut.UNIT_TARGETS_OUTLINE))>>>4;return r===w.LINE&&e.isOutline||r===w.FILL&&Mi(e.symbologyType)?s&i:s&~i}const vs=0,Ms=8,Nr=7,ws=8,Ss=11,bs=11,Ts=12,Is=13,Ls=14,zs=15,Ps=16,$s=17,Es=18,Cs=19,Vs=20,As=21,Fs=26,Kr=Object.keys(A).filter(r=>typeof A[r]=="number").reduce((r,t)=>({...r,[t]:A[t]}),{});function Zr(r){return r===A.SIMPLE||r===A.OUTLINE_FILL_SIMPLE}function Mi(r){return r===A.OUTLINE_FILL||r===A.OUTLINE_FILL_SIMPLE}function wi(r){return Zr(r.symbologyType)}function ie(r){return Mi(r.symbologyType)}function _e(r,t){switch(r){case w.FILL:return Y.from(t);case w.LINE:return ct.from(t);case w.MARKER:return xt.from(t);case w.TEXT:return Wt.from(t);case w.LABEL:return kt.from(t);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${r}`)}}function da(r){switch(K.load(r).geometryType){case w.MARKER:return new xt(r);case w.FILL:return new Y(r);case w.LINE:return new ct(r);case w.TEXT:return new Wt(r);case w.LABEL:return new kt(r)}}class K{constructor(t){this._data=0,this._data=t}static load(t){const e=this.shared;return e.data=t,e}set data(t){this._data=t}get data(){return this._data}get geometryType(){return this.bits(ws,Ss)}set geometryType(t){this.setBits(t,ws,Ss)}get mapAligned(){return!!this.bit(Vs)}set mapAligned(t){this.setBit(Vs,t)}get sdf(){return!!this.bit(bs)}set sdf(t){this.setBit(bs,t)}get pattern(){return!!this.bit(Ts)}set pattern(t){this.setBit(Ts,t)}get textureBinding(){return this.bits(vs,Ms)}set textureBinding(t){this.setBits(t,vs,Ms)}get symbologyType(){return this.bits(As,Fs)}set symbologyType(t){this.setBits(t,As,Fs)}get geometryTypeString(){switch(this.geometryType){case w.FILL:return"fill";case w.MARKER:return"marker";case w.LINE:return"line";case w.TEXT:return"text";case w.LABEL:return"label";default:throw new ft(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(t,e){const s=1<<t;e?this._data|=s:this._data&=~s}bit(t){return(this._data&1<<t)>>t}setBits(t,e,s){for(let i=e,n=0;i<s;i++,n++)this.setBit(i,(t&1<<n)!=0)}bits(t,e){let s=0;for(let i=t,n=0;i<e;i++,n++)s|=this.bit(i)<<n;return s}hasVV(){return!1}setVV(t,e){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf,symbologyType:{value:A[this.symbologyType],options:Kr,namespace:"SYMBOLOGY_TYPE"}}}getVariationHash(){return this._data&~(Nr&this.textureBinding)}}K.shared=new K(0);const Nt=r=>class extends r{get vvSizeMinMaxValue(){return this.bit(Ps)!==0}set vvSizeMinMaxValue(t){this.setBit(Ps,t)}get vvSizeScaleStops(){return this.bit($s)!==0}set vvSizeScaleStops(t){this.setBit($s,t)}get vvSizeFieldStops(){return this.bit(Es)!==0}set vvSizeFieldStops(t){this.setBit(Es,t)}get vvSizeUnitValue(){return this.bit(Cs)!==0}set vvSizeUnitValue(t){this.setBit(Cs,t)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(t,e){super.setVV(t,e);const s=Gr(this.geometryType,t,e)&t;this.vvSizeMinMaxValue=!!(s&N.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(s&N.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(s&N.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(s&N.SIZE_SCALE_STOPS)}},Si=r=>class extends r{get vvRotation(){return this.bit(zs)!==0}set vvRotation(t){this.setBit(zs,t)}hasVV(){return super.hasVV()||this.vvRotation}setVV(t,e){super.setVV(t,e),this.vvRotation=!e.isOutline&&!!(t&N.ROTATION)}},me=r=>class extends r{get vvColor(){return this.bit(Is)!==0}set vvColor(t){this.setBit(Is,t)}hasVV(){return super.hasVV()||this.vvColor}setVV(t,e){super.setVV(t,e),this.vvColor=!e.isOutline&&!!(t&N.COLOR)}},pe=r=>class extends r{get vvOpacity(){return this.bit(Ls)!==0}set vvOpacity(t){this.setBit(Ls,t)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(t,e){super.setVV(t,e),this.vvOpacity=!e.isOutline&&!!(t&N.OPACITY)}};class Y extends me(pe(Nt(K))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const{symbologyType:e,vvFlags:s}=t,i=this.load(0);return i.geometryType=w.FILL,i.symbologyType=e,e!==A.DOT_DENSITY&&i.setVV(s,t),i.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}Y.shared=new Y(0);class xt extends me(pe(Si(Nt(K)))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const{symbologyType:e,vvFlags:s}=t,i=this.load(0);return i.geometryType=w.MARKER,i.symbologyType=e,e!==A.HEATMAP&&i.setVV(s,t),i.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}xt.shared=new xt(0);class ct extends me(pe(Nt(K))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=w.LINE,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}ct.shared=new ct(0);class Wt extends me(pe(Si(Nt(K)))){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=w.TEXT,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}Wt.shared=new Wt(0);class kt extends Nt(K){static load(t){const e=this.shared;return e.data=t,e}static from(t){const e=this.load(0);return e.geometryType=w.LABEL,e.symbologyType=t.symbologyType,e.setVV(t.vvFlags,t),e.mapAligned=hi(t.placement),e.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}kt.shared=new kt(0);const q=0,X=100;function Rs(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r}function bi(r,t){return Math.sqrt(r*r+t*t)}function Ws(r){const t=bi(r[0],r[1]);r[0]/=t,r[1]/=t}function Ur(r,t){return bi(r[0]-t[0],r[1]-t[1])}function b(r){return typeof r=="function"}function $e(r=2){return 1/Math.max(r,1)}function dt(r,t){return[!!r.minScale&&t.scaleToZoom(r.minScale)||q,!!r.maxScale&&t.scaleToZoom(r.maxScale)||X]}function qr(r,t){return r[t+1]}function Ti(r){return r.length-1}function Xr(r){let t=0;for(let e=0;e<Ti(r);e++)t+=Hr(r,e);return t}function Hr(r,t,e=1){const[s,i]=qr(r,t);return Math.sqrt(s*s+i*i)*e}class re{constructor(t,e,s,i,n){this._segments=t,this._index=e,this._distance=s,this._xStart=i,this._yStart=n,this._done=!1}static create(t){return new re(t,0,0,t[0][0],t[0][1])}clone(){return new re(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let s=Math.acos(e);return t>0&&(s=2*Math.PI-s),s}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Ti(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const s=this.backwardLength;if(t<=s)return this._distance=(s-t)/this.length,this;let i=this.backwardLength;for(;this.prev();){if(i+this.length>t)return this._seekBackwards(t-i);i+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let s=this.remainingLength;for(;this.next();){if(s+this.length>t)return this.seek(t-s,e);s+=this.length}return this._distance=1,e?this:null}}function Yr(r,t,e,s=!0){const i=Xr(r),n=re.create(r),a=i/2;if(!s)return n.seek(a),void e(n.clone(),0,a+0*t,i);const o=Math.max((i-t)/2,0),h=Math.floor(o/t),l=a-h*t;n.seek(l);for(let c=-h;c<=h;c++)n.x<512&&n.x>=0&&n.y<512&&n.y>=0&&e(n.clone(),c,a+c*t,i),n.seek(t)}function jr(r,t){const e=t;for(let s=0;s<r.length;s++){let i=r[s];const n=[];n.push(i[0]);for(let o=1;o<i.length;o++){let[h,l]=n[o-1];h+=i[o][0],l+=i[o][1],n.push([h,l])}Qr(n,e);const a=[];a.push(n[0]);for(let o=1;o<n.length;o++){const[h,l]=n[o-1],[c,u]=n[o],d=Math.round(c-h),f=Math.round(u-l);a.push([d,f])}r[s]=a,i=a}return r}function Qr(r,t){if(t<=0)return;const s=r.length;if(s<3)return;const i=[];let n=0;i.push(0);for(let u=1;u<s;u++)n+=Ur(r[u],r[u-1]),i.push(n);t=Math.min(t,.2*n);const a=[];a.push(r[0][0]),a.push(r[0][1]);const o=r[s-1][0],h=r[s-1][1],l=Rs([0,0],r[0],r[1]);Ws(l),r[0][0]+=t*l[0],r[0][1]+=t*l[1],Rs(l,r[s-1],r[s-2]),Ws(l),r[s-1][0]+=t*l[0],r[s-1][1]+=t*l[1];for(let u=1;u<s;u++)i[u]+=t;i[s-1]+=t;const c=.5*t;for(let u=1;u<s-1;u++){let d=0,f=0,m=0;for(let _=u-1;_>=0&&!(i[_+1]<i[u]-c);_--){const p=c+i[_+1]-i[u],y=i[_+1]-i[_],g=i[u]-i[_]<c?1:p/y;if(Math.abs(g)<1e-6)break;const v=g*g,S=g*p-.5*v*y,I=g*y/t,T=r[_+1],L=r[_][0]-T[0],z=r[_][1]-T[1];d+=I/S*(T[0]*g*p+.5*v*(p*L-y*T[0])-v*g*y*L/3),f+=I/S*(T[1]*g*p+.5*v*(p*z-y*T[1])-v*g*y*z/3),m+=I}for(let _=u+1;_<s&&!(i[_-1]>i[u]+c);_++){const p=c-i[_-1]+i[u],y=i[_]-i[_-1],g=i[_]-i[u]<c?1:p/y;if(Math.abs(g)<1e-6)break;const v=g*g,S=g*p-.5*v*y,I=g*y/t,T=r[_-1],L=r[_][0]-T[0],z=r[_][1]-T[1];d+=I/S*(T[0]*g*p+.5*v*(p*L-y*T[0])-v*g*y*L/3),f+=I/S*(T[1]*g*p+.5*v*(p*z-y*T[1])-v*g*y*z/3),m+=I}a.push(d/m),a.push(f/m)}a.push(o),a.push(h);for(let u=0,d=0;u<s;u++)r[u][0]=a[d++],r[u][1]=a[d++]}class Ii{static getPlacement(t,e,s,i){const n=ir(e);if(!n)return null;const a=rr(t);return n.execute(a,e,s,i)}}const Qt=8,Li=r=>class extends r{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=w.TEXT,this._aux=V(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=Rt(t,s=>Rr(s,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:mr*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM})):this._shapingInfo=null}_write(t,e,s,i){const n=e.getDisplayId();this._writeGeometry(t,e,n,s,i)}_writeGeometry(t,e,s,i,n){const a=this._shapingInfo;if(W(a))return;if($(this._textPlacement)){const h=n!=null?n:e.readLegacyGeometryForDisplay();return this._writePlacedText(t,s,h,a,i)}const o=n?Be(Oe(n),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!W(o)){if(o.isPoint){const[h,l]=o.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(h<0||h>=512||l<0||l>=512)?void 0:this._writeGlyphs(t,s,{x:h,y:l},a)}o.forEachVertex((h,l)=>this._writeGlyphs(t,s,{x:h,y:l},a))}}_writePlacedText(t,e,s,i,n){const a=he(this._textPlacement),o=Ii.getPlacement(s,a,x(1),n.geometryEngine);if(!o)return;let h=o.next();for(;h!=null;){const l=-h.getAngle();i.setRotation(l);const c=h.tx,u=-h.ty;c<0||c>=512||u<0||u>=512||(this._writeGlyphs(t,e,{x:c,y:u},i),i.setRotation(-l)),h=o.next()}}_writeGlyphs(t,e,s,i){const n=K.load(this._materialKey),a=M(Math.round(Qt*s.x),Math.round(Qt*s.y)),o=this._vertexBoundsScale,h=i.bounds,l=2*Math.max(h.width,h.height);for(const c of i.glyphs)n.textureBinding=c.textureBinding,t.recordStart(e,n.data,this.geometryType,!0),t.vertexBounds(s.x+h.x+this._xOffset,s.y+h.y-this._yOffset,l*o,l*o),this._writeVertices(t,e,a,c),t.recordEnd()}_writeGlyph(t,e,s,i,n){const a=K.load(this._materialKey),o=M(Math.round(Qt*s),Math.round(Qt*i));a.textureBinding=n.textureBinding,t.recordStart(e,a.data,this.geometryType,!0);const h=n.bounds,l=this._vertexBoundsScale;t.vertexBounds(s+h.x*l,i+h.y*l,h.width*l,h.height*l),this._writeVertices(t,e,o,n),t.recordEnd()}_writeVertices(t,e,s,i){const n=t.vertexCount();this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.upperLeft),t.vertexWrite(i.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.upperRight),t.vertexWrite(i.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.lowerLeft),t.vertexWrite(i.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,s,i),t.vertexWrite(i.offsets.lowerRight),t.vertexWrite(i.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}_writeVertexCommon(t,e,s,i){const n=this._color,a=this._haloColor,o=V(0,0,this._referenceSize,this._bitset),h=V(0,0,this._size,this._haloSize);t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(a),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom)}};class Kt{bindFeature(t,e,s){}write(t,e,s,i){var o;if(W(this._effects)||((o=this._effects)==null?void 0:o.length)===0)return this._write(t,e,i);const n=xe.executeEffects(this._effects,e.readLegacyGeometryForDisplay(),i.geometryEngine);let a=xe.next(n);for(;a;)this._write(t,e,i,a),a=xe.next(n)}_write(t,e,s,i){}}const Jr=5;class $t extends Li(Kt){constructor(t,e,s,i,n,a,o,h,l,c,u,d,f,m,_,p,y,g,v=!1,S,I){super(),this._xOffset=x(f),this._yOffset=x(m),this._decoration=c||"none",this._color=n,this._haloColor=a,this._haloSize=Math.min(Math.floor(Jr*x(ki(s))),127),this._size=Math.min(Math.round(x(e)),127);const T=Math.min(Math.round(x(i||e)),127);this._referenceSize=Math.round(Math.sqrt(256*T)),this._scale=this._size/di,this._angle=d,this._justify=nr(o||"center"),this._xAlignD=li(o||"center"),this._yAlignD=ci(h||"baseline"),this._baseline=(h||"baseline")==="baseline",this._bitset=(l===G.MAP?1:0)|(u?1:0)<<1;const L=K.load(t);L.sdf=!0,this._materialKey=L.data,this._lineWidth=x(_)||512,this._lineHeight=p||1,this._textPlacement=y,this._effects=g,this._isCIM=v,this._minMaxZoom=M(Math.round(S*F),Math.round(I*F))}static fromText(t,e){const s=new $t(t.materialKey,t.font.size,t.haloSize||0,t.font.size,t.color&&et(t.color)||0,t.haloColor&&et(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,G.SCREEN,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1,q,X),[,i]=Te(t.text);return s.bindTextInfo(e,i),s._vertexBoundsScale=t.maxVVSize?t.maxVVSize/t.font.size:1,s}static fromCIMText(t,e,s){const i=t.scaleFactor||1,n=t.size*t.sizeRatio*i,[a,o]=dt(t.scaleInfo,s),h=new $t(t.materialKey,n,t.outlineSize*t.sizeRatio,t.referenceSize,E(t.color),E(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*i,t.offsetY*t.sizeRatio*i,512,1,t.markerPlacement,t.effects,!0,a,o),[,l]=Te(t.text);return h.bindTextInfo(e,l),h._vertexBoundsScale=t.maxVVSize?t.maxVVSize/n:1,h}}const tn=Ct.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),en=(r,t="mapview-labeling")=>tn.error(new ft(t,r)),Jt=1,bt=0,sn=4,ks=25;function rn(r,t){const e=!!r.minScale&&t.scaleToZoom(r.minScale)||0;return ri(e,0,25.5)}function nn(r,t){const e=!!r.maxScale&&t.scaleToZoom(r.maxScale)||255;return ri(e,0,25.5)}function an(r){const t=new Map;return e=>(t.has(e)||t.set(e,r(e)),t.get(e))}const on=an(r=>{let t=0;if(r===0)return 1/0;for(;!(r%2);)t++,r/=2;return t}),te=r=>Math.floor(127*r+127),Vt=r=>Math.floor(10*r),Tt=r=>Math.round(r*(254/360));class ne extends $t{constructor(t,e,s,i){var u,d,f;super(t,s.font.size,s.haloSize||0,s.font.size,s.color&&et(s.color)||0,s.haloColor&&et(s.haloColor)||0,s.horizontalAlignment,s.verticalAlignment,hi(e.labelPlacement)?G.MAP:G.SCREEN,s.font.decoration,!1,s.angle||0,s.xoffset,s.yoffset,s.lineWidth,s.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=w.LABEL,this._allowOverrun=(u=e.allowOverrun)!=null?u:!1,this._repeatLabel=(d=e.repeatLabel)!=null?d:!0,this._labelPosition=(f=e.labelPosition)!=null?f:"curved";const n=rn(e,i),a=nn(e,i),o=e.labelPlacement,[h,l]=ar(o);this._xAlignD=h,this._yAlignD=l,this._minZoom=n,this._maxZoom=a,this._refPlacementPadding=x(s.haloSize)+pr,this._repeatLabelDistance=e.repeatLabelDistance?x(e.repeatLabelDistance):128;const c=kt.load(t);c.sdf=!0,this._materialKey=c.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const s=t.symbol;s.xoffset=0,s.yoffset=0,s.angle=0,s.font.decoration="none"}return new ne(t.materialKey,t,t.symbol,e)}get _shapedBox(){return he(this._shapingInfo).bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=or(this._xAlignD),s=hr(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,W(t))return void(this._refSymbolAndPlacementOffset=V(0,0,te(e),te(s)));if(t.boundsType==="circle"&&(e||s)){const a=Math.sqrt(e*e+s*s);e/=a,s/=a}const i=Math.max(t.height,t.width),n=this._refPlacementPadding*sn;this._refSymbolAndPlacementOffset=V(n,i,te(e),te(s)),this._referenceSize=i,this._refPlacementDirX=e,this._refPlacementDirY=s,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(W(this._shapingInfo))return;const s=this._shapingInfo,i=e.getDisplayId(),n=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(n)switch(this._current={out:t,inId:i,inShaping:s,zoomLevel:this._zoomLevel},e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(n);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(n);break;default:en("mapview-labeling",`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const s=Vt(this._current.zoomLevel);return Vt(t)<=s&&s<=Vt(e)}_placePointLabels(t){const{out:e,inId:s,inShaping:i}=this._current;this._writeGlyphs(e,s,t,i)}_placeLineLabels(t){const e=jr(t.paths,this._current.inShaping.bounds.width),s=this._placeSubdivGlyphs.bind(this),i=(this._shapedBox.width+this._repeatLabelDistance)/(1<<Jt);for(const n of e)Yr(n,i,s,this._repeatLabel)}_placeSubdivGlyphs(t,e,s,i){const n=on(e),a=this._shapedBox.width/(1<<Jt),o=Math.sqrt(this._repeatLabelDistance)/(1<<Jt),h=Math.min(s,i-s),l=this._current.inShaping.isMultiline?ks:Math.log2(h/(o+a/2)),c=e===0?l:Math.min(n,l),u=Math.max(this._minZoom,this._current.zoomLevel+Jt-c),d=this._current.zoomLevel-u,f=this._shapedBox.width/2*2**d;this._current.inShaping.isMultiline?e===0&&this._placeStraight(t,u):this._allowOverrun&&d<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,u):this._labelPosition==="curved"&&this._placeCurved(t,u,f)}_placeStraight(t,e){const{out:s,inId:i,inShaping:n}=this._current,a=Math.ceil(t.angle*(180/Math.PI)%360),o=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=Tt(a),this._writeGlyphs(s,i,t,n,e),this._outLineLabelAngle=Tt(o),this._writeGlyphs(s,i,t,n,e)}_placeCurved(t,e,s){const{out:i,inId:n}=this._current;i.metricStart(n,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Tt(o),this._placeFirst(a,e,1),this._placeBack(t,a,e,s,1),this._placeForward(t,a,e,s,1),this._outLineLabelAngle=Tt(h),this._placeFirst(a,e,0),this._placeBack(t,a,e,s,0),this._placeForward(t,a,e,s,0),i.metricEnd()}_placeStraightAlong(t,e){const{out:s,inId:i}=this._current;s.metricStart(i,e,t.x,t.y,0,0,0,0);const n=t.clone(),a=t.angle*(180/Math.PI)%360,o=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Tt(a),this._placeFirst(n,e,1,!0),this._outLineLabelAngle=Tt(o),this._placeFirst(n,e,0,!0),s.metricEnd()}_placeBack(t,e,s,i,n){const a=t.clone();let o=t.backwardLength+bt;for(;a.prev()&&!(o>=i);)this._placeOnSegment(a,e,o,s,-1,n),o+=a.length+bt}_placeForward(t,e,s,i,n){const a=t.clone();let o=t.remainingLength+bt;for(;a.next()&&!(o>=i);)this._placeOnSegment(a,e,o,s,1,n),o+=a.length+bt}_placeFirst(t,e,s,i=!1){const n=t,a=this._current.inShaping,o=a.glyphs,h=this._current.zoomLevel,{out:l,inId:c}=this._current;for(const u of o){const d=u.x>a.bounds.x?s:1-s,f=d*t.remainingLength+(1-d)*t.backwardLength,m=Math.abs(u.x+u.width/2-a.bounds.x),_=Math.max(0,h+Math.log2(m/(f+bt))),p=Math.max(e,i?0:_);if(u.maxZoom=ks,u.angle=t.angle+(1-s)*Math.PI,u.minZoom=p,this._writeGlyph(l,c,n.x,n.y,u),s&&this._isVisible(u.minZoom,u.maxZoom)){const y=u.bounds;l.metricBoxWrite(y.center[0],y.center[1],y.width,y.height)}}}_placeOnSegment(t,e,s,i,n,a){const o=this._current.inShaping.glyphs,{out:h,inId:l}=this._current,c=this._current.inShaping,u=this._current.zoomLevel,d=t.dx/t.length,f=t.dy/t.length,m={x:t.x+s*-n*d,y:t.y+s*-n*f};for(const _ of o){const p=_.x>c.bounds.x?a:1-a;if(!(p&&n===1||!p&&n===-1))continue;const y=Math.abs(_.x+_.width/2-c.bounds.x),g=Math.max(0,u+Math.log2(y/s)-.1),v=Math.max(i,u+Math.log2(y/(s+t.length+bt)));if(g!==0&&(_.angle=t.angle+(1-a)*Math.PI,_.minZoom=v,_.maxZoom=g,this._writeGlyph(h,l,m.x,m.y,_),a&&this._isVisible(_.minZoom,_.maxZoom))){const S=_.bounds,I=t.x-e.x,T=t.y-e.y;h.metricBoxWrite(S.center[0]+I,S.center[1]+T,S.width,S.height)}}}_writeGlyphs(t,e,s,i,n=this._minZoom){if(s.x<0||s.x>=512||s.y<0||s.y>=512)return;const a=s.x+this._refOffsetX,o=s.y-this._refOffsetY;for(const u of i.glyphs)u.minZoom=n,u.maxZoom=this._maxZoom,this._writeGlyph(t,e,a,o,u);const h=this._refPlacementDirX,l=this._refPlacementDirY,c=i.boundsT;t.metricStart(e,n,a,o,h,l,this._referenceSize,this._materialKey),t.metricBoxWrite(c.center[0],c.center[1],c.width,c.height),t.metricEnd()}_writeVertexCommon(t,e,s,i){const n=this._color,a=this._haloColor,o=V(0,0,this._size,this._haloSize),h=Math.max(i.minZoom,this._minZoom),l=Math.min(i.maxZoom,this._maxZoom),c=V(Vt(h),Vt(l),this._outLineLabelAngle,0);t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(n),t.vertexWrite(a),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(c)}}const Bs=3.14159265359/180,Os=8,zi=r=>class extends r{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=w.MARKER}_write(t,e,s,i){const n=e.getDisplayId();t.recordStart(n,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,n,s,i),t.recordEnd()}_writeGeometry(t,e,s,i,n){if($(this._markerPlacement))return this._writePlacedMarkers(t,e,i,n);if(!n&&e.geometryType==="esriGeometryPoint"){const o=e.getX(),h=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=513||h<0||h>=513)?void 0:this._writeVertices(t,s,this._getPos(o,h),o,h)}const a=n?Be(Oe(n),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!W(a)){if(a.isPoint){const[o,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=512||h<0||h>=512)?void 0:this._writeVertices(t,s,this._getPos(o,h),o,h)}a.forEachVertex((o,h)=>{const l=2*gt;o<-l||o>=l||h<-l||h>=l||this._writeVertices(t,s,this._getPos(o,h),o,h)})}}_writePlacedMarkers(t,e,s,i){const n=i!=null?i:e.readLegacyGeometryForDisplay(),a=Ii.getPlacement(n,he(this._markerPlacement),x(1),s.geometryEngine);if(!a)return;const o=e.getDisplayId(),h=Pt(),l=lt(),c=-128,u=640;let d=a.next();for(;d!=null;){const f=d.tx,m=-d.ty;f>=c&&f<=u&&m>=c&&m<=u&&(this._applyTransformation(l,h,-d.getAngle()/Bs),this._writeVertices(t,o,this._getPos(f,m),f,m)),d=a.next()}}_writeVertices(t,e,s,i,n){const a=xt.load(this._materialKey);return a.symbologyType===A.HEATMAP?this._writeHeatmapVertices(t,e,s):this._writeMarkerVertices(t,e,a,s,i,n)}_writeMarkerVertices(t,e,s,i,n,a){const o=s.vvRotation,h=t.vertexCount();let l=this._computedWidth*this._vertexBoundsScaleX,c=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const u=Math.max(l,c);l=u,c=u}if(o){const u=Math.max(this.xOffset,this.yOffset);l+=u,c+=u}t.vertexBounds(n+this.xOffset,a-this.yOffset,l,c),t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,h)}_writeHeatmapVertices(t,e,s){const i=t.vertexCount();t.vertexWrite(s),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,i)}_writeIndices(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)}_applyTransformation(t,e,s=0){Bi(t,Qs(this.xOffset,-this.yOffset)),this.angle+s!==0&&be(t,t,Bs*(this.angle+s));const i=this._computedWidth,n=this._computedHeight,a=-(.5+this._anchorX)*i,o=-(.5-this._anchorY)*n;ht(e,a,o),At(e,e,t),this._offsetUpperLeft=M(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],ht(e,a+i,o),At(e,e,t),this._offsetUpperRight=M(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],ht(e,a,o+n),At(e,e,t),this._offsetBottomLeft=M(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],ht(e,a+i,o+n),At(e,e,t),this._offsetBottomRight=M(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]}_getPos(t,e){return M(Math.round(Os*t),Math.round(Os*e))}};class U extends zi(Kt){constructor(t,e,s,i,n,a,o,h,l,c,u,d,f,m,_,p,y,g,v,S,I,T,L){super(),this.angle=i,this.height=o,this.width=a,this.xOffset=e*v,this.yOffset=s*v,this._markerPlacement=S,this._effects=I,this._anchorX=p,this._anchorY=y,this._minMaxZoom=M(Math.round(T*F),Math.round(L*F));const z=(m===G.MAP?yr:gr)|(u?pt:0)|(f?xr:0)|(d?vr:0),j=_&&_.sdf,st=xt.load(t);st.sdf=j,st.pattern=!0,st.textureBinding=_.textureBinding,this._materialKey=st.data,this._fillColor=n,this._outlineColor=l,this._sizeOutlineWidth=V(Math.round(Math.min(Math.sqrt(128*a),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*h),255)));const it=_.rect.x+P,Z=_.rect.y+P,vt=it+_.width,Mt=Z+_.height;this._offsets.xUpperLeft=it,this._offsets.yUpperLeft=Z,this._offsets.xUpperRight=vt,this._offsets.yUpperRight=Z,this._offsets.xBottomLeft=it,this._offsets.yBottomLeft=Mt,this._offsets.xBottomRight=vt,this._offsets.yBottomRight=Mt,st.symbologyType===A.PIE_CHART?(this._texUpperLeft=M(0,1),this._texUpperRight=M(1,1),this._texBottomLeft=M(0,0),this._texBottomRight=M(1,0)):(this._texUpperLeft=M(it,Z),this._texUpperRight=M(vt,Z),this._texBottomLeft=M(it,Mt),this._texBottomRight=M(vt,Mt)),a*=g,o*=g,a*=v,o*=v;const Fi=Math.round(64*g);this._bitestAndDistRatio=M(z,Fi),this._computedWidth=a,this._computedHeight=o;const Ri=Pt(),Wi=lt();this._applyTransformation(Wi,Ri)}static fromCIMMarker(t,e,s){const i=e&&e.width||1,n=e&&e.height||1,a=t.size,o=i/n*t.scaleX,h=t.scaleSymbolsProportionally&&t.frameHeight?a/t.frameHeight:1;let l=E(t.color);const c=E(t.outlineColor),u=x(a),d=u*o,f=x(t.offsetX||0),m=x(t.offsetY||0),_=x(t.outlineWidth||0)*h,p=t.alignment||G.SCREEN,y=x(t.referenceSize),[g,v]=dt(t.scaleInfo,s);e.sdf||l!==0||(l=-1);let S=t.rotation||0;t.rotateClockwise||(S=-S);let I=0,T=0;const L=t.anchorPoint;L&&(t.isAbsoluteAnchorPoint?a&&(I=L.x/(a*o),T=L.y/a):(I=L.x,T=L.y));const z=new U(t.materialKey,f,m,S,l,d,u,y,c,_,t.colorLocked,t.scaleSymbolsProportionally,!1,p,e,I,T,t.sizeRatio,se(t.scaleFactor,1),t.markerPlacement,t.effects,g,v);return z._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/d:1,z._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/u:1,z}static fromPictureMarker(t,e){const s=Math.round(x(t.width)),i=Math.round(x(t.height)),n=_i,a=Math.round(x(t.xoffset||0)),o=Math.round(x(t.yoffset||0)),h=new U(t.materialKey,a,o,t.angle,n,s,i,i,0,0,!1,!1,!1,G.SCREEN,e,0,0,1,1,null,null,q,X);return h._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,h._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,h}static fromSimpleMarker(t,e){const s=et(t.color),i=Math.round(x(t.size)),n=i,a=Math.round(x(t.xoffset||0)),o=Math.round(x(t.yoffset||0)),h=t.style,l=t.outline,c=0|(l&&l.color&&et(l.color)),u=0|(l&&l.width&&Math.round(x(l.width))),d=new U(t.materialKey,a,o,t.angle,s,i,n,n,c,u,!1,!1,h==="esriSMSCross"||h==="esriSMSX",G.SCREEN,e,0,0,126/64,1,null,null,q,X);return d.boundsType=h==="esriSMSCircle"?"circle":"square",d._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,d._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,d}static fromLineSymbolMarker(t,e){const s=et(t.color),i=6,n=Math.round(x(i*t.lineWidth)),a=n,o=t.style==="cross"||t.style==="x";let h;switch(t.placement){case"begin-end":h=qt.Both;break;case"begin":h=qt.JustBegin;break;case"end":h=qt.JustEnd;break;default:h=qt.None}const l={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},c=new U(t.materialKey,0,0,0,s,n,a,a/i,s,o?Math.round(x(t.lineWidth)):0,!1,!1,o,G.MAP,e,0,0,126/64,1,l,null,q,X);return c.boundsType=t.style==="circle"?"circle":"square",c}}function hn(r,t,e,s,i,n,a){Ve=0;const o=(s-e)*n,h=i&&i.length,l=h?(i[0]-e)*n:o;let c,u,d,f,m,_=Pi(t,e,s,0,l,n,!0);if(_&&_.next!==_.prev){if(h&&(_=fn(t,e,s,i,_,n)),o>80*n){c=d=t[0+e*n],u=f=t[1+e*n];for(let p=n;p<l;p+=n){const y=t[p+e*n],g=t[p+1+e*n];c=Math.min(c,y),u=Math.min(u,g),d=Math.max(d,y),f=Math.max(f,g)}m=Math.max(d-c,f-u),m=m!==0?1/m:0}Ot(_,r,n,c,u,m,a,0)}}function Pi(r,t,e,s,i,n,a){let o;if(a===yn(r,t,e,s,i,n)>0)for(let h=s;h<i;h+=n)o=Ds(h+t*n,r[h+t*n],r[h+1+t*n],o);else for(let h=i-n;h>=s;h-=n)o=Ds(h+t*n,r[h+t*n],r[h+1+t*n],o);return o&&mt(o,o.next)&&(Dt(o),o=o.next),o}function Bt(r,t=r){if(!r)return r;let e,s=r;do if(e=!1,s.steiner||!mt(s,s.next)&&C(s.prev,s,s.next)!==0)s=s.next;else{if(Dt(s),s=t=s.prev,s===s.next)break;e=!0}while(e||s!==t);return t}function Ot(r,t,e,s,i,n,a,o){if(!r)return;!o&&n&&(r=$i(r,s,i,n));let h=r;for(;r.prev!==r.next;){const l=r.prev,c=r.next;if(n?cn(r,s,i,n):ln(r))t.push(l.index/e+a),t.push(r.index/e+a),t.push(c.index/e+a),Dt(r),r=c.next,h=c.next;else if((r=c)===h){o?o===1?Ot(r=xn(r,t,e,a),t,e,s,i,n,a,2):o===2&&vn(r,t,e,s,i,n,a):Ot(Bt(r),t,e,s,i,n,a,1);break}}}function ln(r){const t=r.prev,e=r,s=r.next;if(C(t,e,s)>=0)return!1;let i=r.next.next;const n=i;let a=0;for(;i!==r.prev&&(a===0||i!==n);){if(a++,zt(t.x,t.y,e.x,e.y,s.x,s.y,i.x,i.y)&&C(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function cn(r,t,e,s){const i=r.prev,n=r,a=r.next;if(C(i,n,a)>=0)return!1;const o=i.x<n.x?i.x<a.x?i.x:a.x:n.x<a.x?n.x:a.x,h=i.y<n.y?i.y<a.y?i.y:a.y:n.y<a.y?n.y:a.y,l=i.x>n.x?i.x>a.x?i.x:a.x:n.x>a.x?n.x:a.x,c=i.y>n.y?i.y>a.y?i.y:a.y:n.y>a.y?n.y:a.y,u=Ee(o,h,t,e,s),d=Ee(l,c,t,e,s);let f=r.prevZ,m=r.nextZ;for(;f&&f.z>=u&&m&&m.z<=d;){if(f!==r.prev&&f!==r.next&&zt(i.x,i.y,n.x,n.y,a.x,a.y,f.x,f.y)&&C(f.prev,f,f.next)>=0||(f=f.prevZ,m!==r.prev&&m!==r.next&&zt(i.x,i.y,n.x,n.y,a.x,a.y,m.x,m.y)&&C(m.prev,m,m.next)>=0))return!1;m=m.nextZ}for(;f&&f.z>=u;){if(f!==r.prev&&f!==r.next&&zt(i.x,i.y,n.x,n.y,a.x,a.y,f.x,f.y)&&C(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;m&&m.z<=d;){if(m!==r.prev&&m!==r.next&&zt(i.x,i.y,n.x,n.y,a.x,a.y,m.x,m.y)&&C(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function Ds(r,t,e,s){const i=Et.create(r,t,e);return s?(i.next=s.next,i.prev=s,s.next.prev=i,s.next=i):(i.prev=i,i.next=i),i}function Dt(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function un(r){let t=r,e=r;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==r);return e}function fn(r,t,e,s,i,n){const a=new Array;for(let o=0,h=s.length;o<h;o++){const l=Pi(r,t,e,s[o]*n,o<h-1?s[o+1]*n:e*n,n,!1);l===l.next&&(l.steiner=!0),a.push(un(l))}a.sort(gn);for(const o of a)i=dn(o,i);return i}function dn(r,t){const e=_n(r,t);if(!e)return t;const s=Ci(e,r);return Bt(s,s.next),Bt(e,e.next)}function _n(r,t){let e=t;const s=r.x,i=r.y;let n,a=-1/0;do{if(i<=e.y&&i>=e.next.y&&e.next.y!==e.y){const d=e.x+(i-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(d<=s&&d>a){if(a=d,d===s){if(i===e.y)return e;if(i===e.next.y)return e.next}n=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!n)return null;if(s===a)return n.prev;const o=n,h=n.x,l=n.y;let c,u=1/0;for(e=n.next;e!==o;)s>=e.x&&e.x>=h&&s!==e.x&&zt(i<l?s:a,i,h,l,i<l?a:s,i,e.x,e.y)&&(c=Math.abs(i-e.y)/(s-e.x),(c<u||c===u&&e.x>n.x)&&Gt(e,r)&&(n=e,u=c)),e=e.next;return n}function $i(r,t,e,s){for(let i;i!==r;i=i.next){if(i=i||r,i.z===null&&(i.z=Ee(i.x,i.y,t,e,s)),i.prev.next!==i||i.next.prev!==i)return i.prev.next=i,i.next.prev=i,$i(r,t,e,s);i.prevZ=i.prev,i.nextZ=i.next}return r.prevZ.nextZ=null,r.prevZ=null,mn(r)}function mn(r){let t,e=1;for(;;){let s,i=r;r=null,t=null;let n=0;for(;i;){n++,s=i;let a=0;for(;a<e&&s;a++)s=s.nextZ;let o=e;for(;a>0||o>0&&s;){let h;a===0?(h=s,s=s.nextZ,o--):o!==0&&s?i.z<=s.z?(h=i,i=i.nextZ,a--):(h=s,s=s.nextZ,o--):(h=i,i=i.nextZ,a--),t?t.nextZ=h:r=h,h.prevZ=t,t=h}i=s}if(t.nextZ=null,e*=2,n<2)return r}}function C(r,t,e){return(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y)}function Ei(r,t,e,s){return!!(mt(r,t)&&mt(e,s)||mt(r,s)&&mt(e,t))||C(r,t,e)>0!=C(r,t,s)>0&&C(e,s,r)>0!=C(e,s,t)>0}function pn(r,t){let e=r;do{if(e.index!==r.index&&e.next.index!==r.index&&e.index!==t.index&&e.next.index!==t.index&&Ei(e,e.next,r,t))return!0;e=e.next}while(e!==r);return!1}function yn(r,t,e,s,i,n){let a=0;for(let o=s,h=i-n;o<i;o+=n)a+=(r[h+t*n]-r[o+t*n])*(r[o+1+t*n]+r[h+1+t*n]),h=o;return a}function zt(r,t,e,s,i,n,a,o){return(i-a)*(t-o)-(r-a)*(n-o)>=0&&(r-a)*(s-o)-(e-a)*(t-o)>=0&&(e-a)*(n-o)-(i-a)*(s-o)>=0}function Gt(r,t){return C(r.prev,r,r.next)<0?C(r,t,r.next)>=0&&C(r,r.prev,t)>=0:C(r,t,r.prev)<0||C(r,r.next,t)<0}function Ee(r,t,e,s,i){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-e)*i)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function mt(r,t){return r.x===t.x&&r.y===t.y}function gn(r,t){return r.x-t.x}function xn(r,t,e,s){let i=r;do{const n=i.prev,a=i.next.next;!mt(n,a)&&Ei(n,i,i.next,a)&&Gt(n,a)&&Gt(a,n)&&(t.push(n.index/e+s),t.push(i.index/e+s),t.push(a.index/e+s),Dt(i),Dt(i.next),i=r=a),i=i.next}while(i!==r);return i}function vn(r,t,e,s,i,n,a){let o=r;do{let h=o.next.next;for(;h!==o.prev;){if(o.index!==h.index&&Mn(o,h)){let l=Ci(o,h);return o=Bt(o,o.next),l=Bt(l,l.next),Ot(o,t,e,s,i,n,a,0),void Ot(l,t,e,s,i,n,a,0)}h=h.next}o=o.next}while(o!==r)}function Mn(r,t){return r.next.index!==t.index&&r.prev.index!==t.index&&!pn(r,t)&&Gt(r,t)&&Gt(t,r)&&wn(r,t)}function wn(r,t){let e=r,s=!1;const i=(r.x+t.x)/2,n=(r.y+t.y)/2;do e.y>n!=e.next.y>n&&e.next.y!==e.y&&i<(e.next.x-e.x)*(n-e.y)/(e.next.y-e.y)+e.x&&(s=!s),e=e.next;while(e!==r);return s}function Ci(r,t){const e=Et.create(r.index,r.x,r.y),s=Et.create(t.index,t.x,t.y),i=r.next,n=t.prev;return r.next=t,t.prev=r,e.next=i,i.prev=e,s.next=e,e.prev=s,n.next=s,s.prev=n,s}class Et{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,s){const i=Ve<Ce.length?Ce[Ve++]:new Et;return i.index=t,i.x=e,i.y=s,i.prev=null,i.next=null,i.z=null,i.prevZ=null,i.nextZ=null,i.steiner=!1,i}}const Ce=new Array,Sn=8096;let Ve=0;for(let r=0;r<Sn;r++)Ce.push(new Et);const bn=1e-5,_t=new yi(0,0,0,1,0),Ae=new yi(0,0,0,1,0);function Gs(r,t,e){let s=0;for(let i=1;i<e;i++){const n=r[2*(t+i-1)],a=r[2*(t+i-1)+1];s+=(r[2*(t+i)]-n)*(r[2*(t+i)+1]+a)}return s}function Tn(r,t,e,s,i){let n=0;const a=2;for(let o=e;o<s;o+=3){const h=(r[o]-i)*a,l=(r[o+1]-i)*a,c=(r[o+2]-i)*a;n+=Math.abs((t[h]-t[c])*(t[l+1]-t[h+1])-(t[h]-t[l])*(t[c+1]-t[h+1]))}return n}function In(r,t){const{coords:e,lengths:s,hasIndeterminateRingOrder:i}=t,n=0,a=r;if(i)return!1;let o=0;for(let h=0;h<s.length;){let l=h,c=s[h],u=Gs(e,o,c);const d=[];for(;++l<s.length;){const p=s[l],y=Gs(e,o+c,p);if(!(y>0))break;u+=y,d.push(o+c),c+=p}const f=a.length;hn(a,e,o,o+c,d,2,n);const m=Tn(a,e,f,a.length,n),_=Math.abs(u);if(Math.abs((m-_)/Math.max(1e-7,_))>bn)return a.length=0,!1;h=l,o+=c}return!0}function Ln(r){const{coords:t,lengths:e}=r,{buffer:s}=Tr(t,e);return s}function zn(r,t,e){let s=0;for(let i=0;i<r.lengths.length;i++){const n=r.lengths[i];for(let a=0;a<n;a++){const o=r.coords[2*(a+s)],h=r.coords[2*(a+s)+1];if(o<t||o>e||h<t||h>e)return!0}s+=n}return!1}function Pn(r,t){if(W(r))return null;if(!zn(r,-128,gt+128))return r;_t.setPixelMargin(t),_t.reset(gi.Polygon);let e=0;for(let a=0;a<r.lengths.length;a++){const o=r.lengths[a];let h=r.coords[2*(0+e)],l=r.coords[2*(0+e)+1];_t.moveTo(h,l);for(let c=1;c<o;c++)h=r.coords[2*(c+e)],l=r.coords[2*(c+e)+1],_t.lineTo(h,l);_t.close(),e+=o}const s=_t.result(!1);if(!s)return null;const i=[],n=[];for(const a of s){let o=0;for(const h of a)n.push(h.x),n.push(h.y),o++;i.push(o)}return new Oi(i,n)}function $n(r,t){Ae.setPixelMargin(t);const e=Ae,s=-t,i=gt+t;let n=[],a=!1,o=0;for(;o<r.length;){const h=[],l=r[o];if(!l)return null;e.reset(gi.LineString);let[c,u]=l[0];if(a)e.moveTo(c,u);else{if(c<s||c>i||u<s||u>i){a=!0;continue}h.push({x:c,y:u})}let d=!1;const f=l.length;for(let m=1;m<f;++m)if(c+=l[m][0],u+=l[m][1],a)e.lineTo(c,u);else{if(c<s||c>i||u<s||u>i){d=!0;break}h.push({x:c,y:u})}if(d)a=!0;else{if(a){const m=e.resultWithStarts();if(m)for(const _ of m)n.push(_)}else n.push({line:h,start:0});o++,a=!1}}return n=n.filter(h=>h.line.length>1),n.length===0?null:n}_t.setExtent(gt),Ae.setExtent(gt);const ae=8,B=16,Ns=65535,Vi=r=>class extends r{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=w.LINE}writeGeometry(t,e,s,i){this._writeGeometry(t,e,s,i)}_initializeTessellator(t){const e=ct.load(this._materialKey),s=Y.load(this._materialKey),i=this._tessellationOptions,n=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,a=this.tessellationProperties._halfWidth<Mr&&!t&&!n;this.tessellationProperties.minMaxZoom=this._minMaxZoom,i.wrapDistance=Ns,i.textured=this._isDashed||this._hasPattern,i.offset=this.tessellationProperties.offset,i.halfWidth=this.tessellationProperties._halfWidth;const o=a?0:1,h=ie(s)?Cn:En;this._lineTessellator=new Ir(h(this.tessellationProperties,o,o),Vn(this.tessellationProperties),a)}_write(t,e,s,i){const n=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,i,n),t.recordEnd()}_writeGeometry(t,e,s,i){const n=s!=null?s:e.readLegacyGeometryForDisplay(),a=this._getLines(n,i);W(a)||this._writeVertices(t,e,a)}_getLines(t,e){if(W(t))return null;const s=t.paths||t.rings;return W(s)?null:$n(s,e?256:16)}_writeVertices(t,e,s){const i=e.getDisplayId(),n=t.vertexCount(),a=this.tessellationProperties,o=this._tessellationOptions;a.out=t,a.id=i,a.indexCount=0,a.vertexCount=0,a.offset=n,o.capType=this._capType,o.joinType=this._joinType;const h=Y.load(this._materialKey);this.tessellationProperties.key=ie(h)?h:ct.load(this._materialKey);for(const{line:l,start:c}of s)o.initialDistance=c%Ns,this._lineTessellator.tessellate(l,o)}},En=(r,t,e)=>(s,i,n,a,o,h,l,c,u,d,f)=>{const m=M(f,Math.ceil(B*r._halfWidth)),_=V(Math.round(B*l),Math.round(B*c),Math.round(B*u),Math.round(B*d)),p=V(B*o,B*h,0,r._bitset),y=r.out;return y.vertexBounds(s,i,t,e),y.vertexWrite(M(ae*s,ae*i)),y.vertexWrite(r.id),y.vertexWrite(r._fillColor),y.vertexWrite(_),y.vertexWrite(m),y.vertexWrite(r._tl),y.vertexWrite(r._br),y.vertexWrite(p),y.vertexWrite(M(Math.ceil(B*r._halfReferenceWidth),0)),y.vertexWrite(r.minMaxZoom),y.vertexEnd(),r.offset+r.vertexCount++},Cn=(r,t,e)=>(s,i,n,a,o,h,l,c,u,d,f)=>{const m=M(B*r._halfWidth,B*r._halfReferenceWidth),_=V(B*l+128,B*c+128,B*u+128,B*d+128),p=r.out,y=r._bitset<<24|r.id;p.vertexBounds(s,i,t,e),p.vertexWrite(M(ae*s,ae*i)),p.vertexWrite(y),p.vertexWrite(r._fillColor);const g=wi(r.key);return g||(p.vertexWrite(0),p.vertexWrite(0)),p.vertexWrite(0),p.vertexWrite(m),p.vertexWrite(_),g||p.vertexWrite(r.minMaxZoom),p.vertexEnd(),r.offset+r.vertexCount++},Vn=r=>(t,e,s)=>{const i=r.out;i.indexWrite(t),i.indexWrite(e),i.indexWrite(s),r.indexCount+=3};class J extends Vi(Kt){constructor(t,e,s,i,n,a,o,h,l,c,u,d,f,m,_,p,y,g,v,S){super();const I=ct.load(t);e&&(I.sdf=e.sdf,I.pattern=!0,I.textureBinding=e.textureBinding),this._capType=i,this._joinType=n,this._miterLimitCosine=$e(a),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=h,this.tessellationProperties._br=l,this._hasPattern=c,this._isDashed=u,this._zOrder=y,this._effects=g,this._minMaxZoom=M(Math.round(v*F),Math.round(S*F)),this._materialKey=I.data;const T=(f?pt:0)|(m?wr:0)|(d?mi:0)|(_?le:0);this.tessellationProperties._bitset=T,this.tessellationProperties._halfWidth=.5*s,this.tessellationProperties._halfReferenceWidth=.5*p,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,s){const i=t.color,n=t.scaleFactor||1,a=!!t.dashTemplate;let o=t.cap;a&&o===hs.ROUND&&(o=hs.SQUARE);const h=t.join,l=x(t.width)*n,c=x(t.referenceWidth),u=x(t.miterLimit),d=i&&E(i)||0,[f,m]=dt(t.scaleInfo,s),_=!1;if(!e)return new J(t.materialKey,e,l,o,h,u,d,0,0,!1,a,t.scaleDash,t.colorLocked,_,t.sampleAlphaOnly,c,t.zOrder,t.effects,f,m);const{rect:p,width:y,height:g}=e,v=p.x+P,S=p.y+P,I=v+y,T=S+g,L=M(v,S),z=M(I,T),j=!1;return new J(t.materialKey,e,l,o,h,u,d,L,z,!0,a,t.scaleDash,t.colorLocked,j,t.sampleAlphaOnly,c,t.zOrder,t.effects,f,m)}static fromFillOutline(t){var s;const e=Y.load(t.materialKey);return ie(e)&&t.outline&&((s=t.outline)==null?void 0:s.style)==="esriSLSSolid"?J.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0):null}static fromSimpleLine(t,e,s=!1){const{color:i}=t,n=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",a=fr(t.cap||"round"),o=dr(t.join||"round");let h=i&&t.style!=="esriSLSNull"&&et(i)||0;t.style==="esriSLSNull"&&(h=0);const l=x(t.width),c=t.miterLimit;if(!e)return new J(t.materialKey,e,l,a,o,c,h,0,0,!1,n,!0,!1,s,!1,l,0,null,q,X);const{rect:u,width:d,height:f}=e,m=u.x+P,_=u.y+P,p=m+d,y=_+f,g=M(m,_),v=M(p,y);return new J(t.materialKey,e,l,a,o,c,h,g,v,!0,n,!0,!1,s,!1,l,0,null,q,X)}static fromPictureLineSymbol(t,e,s,i){return Ct.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const An=100,Ks=1,Ai=r=>class extends r{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=w.FILL}_maybeAddLineTemplate(t){this._lineTemplate=J.fromFillOutline(t)}_write(t,e,s,i){const n=e.geometryType==="esriGeometryPoint",a=Y.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,e,a,i,n),ie(a)&&$(this._lineTemplate)&&this._lineTemplate.writeGeometry(t,e,i,n),t.recordEnd()}_writeGeometry(t,e,s,i,n){const a=this._getGeometry(e,i,n);if(W(a))return;const o=[];if(!(a.maxLength>An)&&!this.forceLibtess&&In(o,a))return void(o.length&&this._writeVertices(t,e,a.coords,a.lengths,s,o));const h=Ln(a);this._writeVertices(t,e,h,[h.length/2],s)}_writeVertex(t,e,s,i,n,a){const o=M(Ks*i,Ks*n);if(t.vertexBounds(i,n,0,0),t.vertexWrite(o),t.vertexWrite(e),s.symbologyType===A.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(a.readGeometryArea()));else{t.vertexWrite(this.fillColor);const h=wi(s);h||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux21),t.vertexWrite(this.aux22),t.vertexWrite(this.aux3),h||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,e,s,i,n,a){const o=e.getDisplayId(),h=this._bitset<<24|o,l=i.reduce((f,m)=>f+m),c=Ie(n.geometryType,n.symbologyType).geometry/4,u=t.vertexCount();t.vertexEnsureSize(c*l);let d=0;if(a)for(const f of a){const m=s[2*f],_=s[2*f+1];this._writeVertex(t,h,n,m,_,e),d++}else for(let f=0;f<s.length;f+=2){const m=Math.round(s[f]),_=Math.round(s[f+1]);this._writeVertex(t,h,n,m,_,e),d++}t.indexEnsureSize(d);for(let f=0;f<d;f++)t.indexWrite(f+u)}_getGeometry(t,e,s){const i=e?Be(Oe(e),2):t.readGeometryForDisplay();return i?Pn(i,s?256:8):null}},Zs=Ct.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class ye extends Kt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,s,i,n){if(n&&n.length===0)return null;const a=n&&n.length>0,o=e.readLegacyFeature(),h=e.getObjectId(),l=this._materialCache,c=this._cimLayer.materialHash;if(!c)return Zs.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const u=typeof c=="function"?c(o,s,i,h):c;if(l.has(u)){const v=l.get(u);return Promise.resolve(v)}const d=this._ongoingMaterialRequestMap.get(u);if(d)return d;const f=this._cimLayer,m=lr(f.cim,this._cimLayer.materialOverrides);m.mosaicHash=u;const{type:_,url:p}=f,y={cim:m,type:_,mosaicHash:u,url:p,size:null,dashTemplate:null,text:null,fontName:null,objectId:h,animatedSymbolProperties:null};switch(_){case"marker":y.size=Zt(f.size,o,s,i),y.animatedSymbolProperties=Zt(f.animatedSymbolProperties,o,s,i);break;case"line":y.dashTemplate=f.dashTemplate;break;case"text":y.text=Zt(f.text,o,s,i),y.fontName=Zt(f.fontName,o,s,i)}const g=t.getMosaicItem(y,n).then(v=>(a||(this._ongoingMaterialRequestMap.delete(u),l.set(u,v)),v)).catch(v=>(this._ongoingMaterialRequestMap.delete(u),Zs.error(".analyze()",v.message),null));return a||this._ongoingMaterialRequestMap.set(u,g),g}}function O(r,t){if(r&&"name"in r){const e=r;return t&&t.error(new ft(e.name,e.message,e.details)),!1}return!0}const Us=128;class qe extends Ai(ye){constructor(t,e,s){var c;if(super(t),this._minMaxZoom=M(Math.round(e*F),Math.round(s*F)),b(t.color)){const u=(d,f,m)=>{const _=t.color(d,f,m);return _&&E(_)||0};this._dynamicPropertyMap.set("fillColor",u)}else{const u=t.color;this.fillColor=u&&E(u)||0}const i=((c=t.cim.placement)==null?void 0:c.type)==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,n=t.height;if(b(n)){const u=(d,f,m)=>n(d,f,m)*i;this._dynamicPropertyMap.set("_height",u)}else this._height=(n||0)*i;const a=t.offsetX;if(b(a)){const u=(d,f,m)=>x(a(d,f,m));this._dynamicPropertyMap.set("_offsetX",u)}else this._offsetX=x(a||0);const o=t.offsetY;if(b(o)){const u=(d,f,m)=>x(-o(d,f,m));this._dynamicPropertyMap.set("_offsetY",u)}else this._offsetY=x(-o||0);const h=t.scaleX;b(h)?this._dynamicPropertyMap.set("_scaleX",h):this._scaleX=h||1;const l=t.angle;if(b(l)){const u=(d,f,m)=>ze(l(d,f,m));this._dynamicPropertyMap.set("_angle",u)}else this._angle=ze(l)||0;if($(t.effects)){const u=t.effects;b(u)?this._dynamicPropertyMap.set("_effects",u):this._effects=u}this._cimFillLayer=t,this._bitset=(t.colorLocked?pt:0)|(t.applyRandomOffset?pi:0)|(t.sampleAlphaOnly?le:0),this._fillMaterialKey=t.materialKey}static fromCIMFill(t,e){const[s,i]=dt(t.scaleInfo,e);return new qe(t,s,i)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(i,e,s)});const n=Y.load(this._fillMaterialKey),a=this._materialCache,o=(0,this._cimFillLayer.materialHash)(i,e,s),h=a.get(o);let l=null;if(h&&O(h.spriteMosaicItem)&&(l=h.spriteMosaicItem),l){const{rect:c,width:u,height:d}=l,f=c.x+P,m=c.y+P,_=f+u,p=m+d;let y=Math.round(x(this._height));y<=0&&(y=p-m);let g=Math.round(x(this._height/d*u||0));g<=0&&(g=_-f);const v=this._scaleX,S=1;this.tl=M(f,m),this.br=M(_,p),this.aux21=M(g,y),this.aux22=M(this._offsetX,this._offsetY),this.aux3=V(v*Us,S*Us,this._angle,0),n.sdf=l.sdf,n.pattern=!0,n.textureBinding=l.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}class Xe extends Vi(ye){constructor(t,e,s){super(t),this._minMaxZoom=M(Math.round(e*F),Math.round(s*F)),this._cimLineLayer=t;let i=0;b(t.width)||(i=.5*x(t.width));const n=(u,d,f)=>b(t.width)?.5*x(t.width(u,d,f)):i;this._dynamicPropertyMap.set("_halfWidth",n),b(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,b(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const a=t.color;if(b(a)){const u=(d,f,m)=>E(a(d,f,m));this._dynamicPropertyMap.set("_fillColor",u)}else this._fillColor=a&&E(a)||0;const o=t.miterLimit;if(b(o)){const u=(d,f,m)=>$e(o(d,f,m));this._dynamicPropertyMap.set("_miterLimitCosine",u)}else this._miterLimitCosine=$e(o);if($(t.effects)){const u=t.effects;b(u)?this._dynamicPropertyMap.set("_effects",u):this._effects=u}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null;const h=t.colorLocked?pt:0,l=t.scaleDash?mi:0,c=t.sampleAlphaOnly?le:0;this.tessellationProperties._bitset=h|l|c,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[s,i]=dt(t.scaleInfo,e);return new Xe(t,s,i)}bindFeature(t,e,s){const i=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(i,e,s)}),this._halfWidth*=this._scaleFactor;const n=this._materialCache,a=(0,this._cimLineLayer.materialHash)(i,e,s),o=n.get(a);let h=null;if(o&&O(o.spriteMosaicItem)&&(h=o.spriteMosaicItem),h){this._hasPattern=!0;const{rect:c,width:u,height:d}=h,f=c.x+P,m=c.y+P,_=f+u,p=m+d;this.tessellationProperties._tl=M(f,m),this.tessellationProperties._br=M(_,p)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=ct.load(this._materialKey);h&&(l.sdf=h.sdf,l.pattern=!0,l.textureBinding=h.textureBinding),this._materialKey=l.data}}const Fn=Pt(),Rn=lt();class He extends zi(ye){constructor(t,e,s){super(t),this._cimMarkerLayer=t,this._minMaxZoom=M(Math.round(e*F),Math.round(s*F));const i=t.color;if(b(i)){const d=(f,m,_)=>E(i(f,m,_));this._dynamicPropertyMap.set("_fillColor",d)}else this._fillColor=E(i);const n=t.outlineColor;if(b(n)){const d=(f,m,_)=>E(n(f,m,_));this._dynamicPropertyMap.set("_outlineColor",d)}else this._outlineColor=E(n);const a=t.size;if(b(a)){const d=(f,m,_)=>x(a(f,m,_));this._dynamicPropertyMap.set("_size",d)}else this._size=x(a)||0;const o=t.scaleX;b(o)?this._dynamicPropertyMap.set("_scaleX",o):this._scaleX=o;const h=t.offsetX;if(b(h)){const d=(f,m,_)=>x(h(f,m,_));this._dynamicPropertyMap.set("xOffset",d)}else this.xOffset=x(h)||0;const l=t.offsetY;if(b(l)){const d=(f,m,_)=>x(l(f,m,_));this._dynamicPropertyMap.set("yOffset",d)}else this.yOffset=x(l)||0;const c=t.outlineWidth;if(b(c)){const d=(f,m,_)=>x(c(f,m,_));this._dynamicPropertyMap.set("_outlineWidth",d)}else this._outlineWidth=x(c)||0;const u=t.rotation;if(b(u)?this._dynamicPropertyMap.set("_angle",u):this._angle=u||0,$(t.effects)){const d=t.effects;b(d)?this._dynamicPropertyMap.set("_effects",d):this._effects=d}if($(t.markerPlacement)){const d=t.markerPlacement;b(d)?this._dynamicPropertyMap.set("_markerPlacement",d):this._markerPlacement=d}this._scaleFactor=se(t.scaleFactor,1),this._bitSet=(t.alignment===G.MAP?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[s,i]=dt(t.scaleInfo,e);return new He(t,s,i)}bindFeature(t,e,s){const i=t.readLegacyFeature(),n=t.getObjectId();this._dynamicPropertyMap.forEach((vt,Mt)=>{this[Mt]=vt(i,e,s)});const a=this._cimMarkerLayer.materialHash,o=typeof a=="function"?a(i,e,s,n):a,h=this._materialCache.get(o);if(!h||!O(h.spriteMosaicItem)||!h.spriteMosaicItem)return void Ct.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new ft("mapview-cim","Encountered an error when binding feature"));const l=h.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,u=l.width/l.height*this._scaleX,d=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,m=f*u;const _=this.xOffset,p=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const y=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/x(this._cimMarkerLayer.frameHeight):1,g=this._outlineWidth*y,v=x(this._cimMarkerLayer.referenceSize);let S=0,I=0;const T=this._cimMarkerLayer.anchorPoint;T&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(S=x(T.x)/(this._size*u),I=x(T.y)/this._size):(S=T.x,I=T.y)),this._anchorX=S,this._anchorY=I,this._sizeOutlineWidth=V(Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*v),255))),this.angle=d;const L=Math.round(64*c);this._bitestAndDistRatio=M(this._bitSet,L);const z=l.rect.x+P,j=l.rect.y+P,st=z+l.width,it=j+l.height;this._texUpperLeft=M(z,j),this._texUpperRight=M(st,j),this._texBottomLeft=M(z,it),this._texBottomRight=M(st,it);const Z=xt.load(this._materialKey);Z.sdf=l.sdf,Z.pattern=!0,Z.textureBinding=l.textureBinding,this._materialKey=Z.data,m*=c,f*=c,m*=this._scaleFactor,f*=this._scaleFactor,m*=l.rect.width/l.width,f*=l.rect.height/l.height,this._computedWidth=m,this._computedHeight=f,this._applyTransformation(Rn,Fn),this.xOffset=_,this.yOffset=p}}function Ye(r){const t=new Array(r.length);for(let e=0;e<r.length;e++)t[e]=r.charCodeAt(e);return t}const qs=5;function Wn(r,t,e,s){return typeof r.text=="string"?r.text:typeof r.text=="function"?r.text(t,e,s):""}class je extends Li(ye){constructor(t,e,s){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=M(Math.round(e*F),Math.round(s*F));const i=t.scaleFactor||1;this._cimTextLayer=t;const n=t.color;if(b(n)){const _=(p,y,g)=>E(n(p,y,g));this._dynamicPropertyMap.set("_color",_)}else this._color=E(n);const a=t.outlineColor;if(b(a)){const _=(p,y,g)=>E(a(p,y,g));this._dynamicPropertyMap.set("_haloColor",_)}else this._haloColor=E(a);let o;b(t.size)||(o=Math.min(Math.round(x(t.size*t.sizeRatio)),127));const h=(_,p,y)=>b(t.size)?Math.min(Math.round(x(t.size(_,p,y)*t.sizeRatio)),127):o;if(this._dynamicPropertyMap.set("_size",h),b(t.outlineSize)){const _=(p,y,g)=>Math.min(Math.floor(qs*x(t.outlineSize(p,y,g)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",_)}else this._haloSize=Math.min(Math.floor(qs*x(t.outlineSize*t.sizeRatio)),127);let l;b(t.offsetX)||(l=Math.round(x(t.offsetX*t.sizeRatio)));const c=(_,p,y)=>b(t.offsetX)?Math.round(x(t.offsetX(_,p,y)*t.sizeRatio)):l;let u;this._dynamicPropertyMap.set("_xOffset",c),b(t.offsetY)||(u=Math.round(x(t.offsetY*t.sizeRatio)));const d=(_,p,y)=>b(t.offsetY)?Math.round(x(t.offsetY(_,p,y)*t.sizeRatio)):u;if(this._dynamicPropertyMap.set("_yOffset",d),b(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,b(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,b(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,$(t.effects)){const _=t.effects;b(_)?this._dynamicPropertyMap.set("_effects",_):this._effects=_}if($(t.markerPlacement)){const _=t.markerPlacement;b(_)?this._dynamicPropertyMap.set("_markerPlacement",_):this._textPlacement=_}b(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._scaleFactor=i;const f=Math.min(Math.round(x(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*f)),this._materialKey=t.materialKey;const m=Wt.load(this._materialKey);m.sdf=!0,this._bitset=(t.alignment===G.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=m.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[s,i]=dt(t.scaleInfo,e);return new je(t,s,i)}async analyze(t,e,s,i){const n=e.readLegacyFeature(),a=Wn(this._cimTextLayer,n,s,i),o=await super.analyze(t,e,s,i,Ye(a));return o&&o.glyphMosaicItems&&this._textToGlyphs.set(a,o.glyphMosaicItems),o}bindFeature(t,e,s){const i=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((a,o)=>{this[o]=a(i,e,s)}),!this._text||this._text.length===0)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/di,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=li(se(this._horizontalAlignment,"center")),this._yAlignD=ci(se(this._verticalAlignment,"baseline"));const n=this._textToGlyphs.get(this._text);this.bindTextInfo(n,!1)}}const It=128;class tt extends Ai(Kt){constructor(t,e,s,i,n,a,o,h,l,c,u,d,f,m,_,p){super(),this._effects=m;const y=Y.load(t);e&&(y.sdf=e.sdf,y.pattern=!0,y.textureBinding=e.textureBinding),this.fillColor=s,this.tl=i,this.br=n,this.aux21=M(a,o),this.aux22=M(h,l),this.aux3=V(c,u,d,0),this._bitset=f,this._minMaxZoom=M(Math.round(_*F),Math.round(p*F)),this._materialKey=y.data}static fromCIMFill(t,e,s){const i=t.color,n=i&&E(i)||0,a=t.materialKey,[o,h]=dt(t.scaleInfo,s),l=(t.colorLocked?pt:0)|(t.applyRandomOffset?pi:0)|(t.sampleAlphaOnly?le:0);if(!e)return new tt(a,null,n,0,0,0,0,0,0,0,0,0,l,t.effects,o,h);const{rect:c,width:u,height:d}=e,f=t.scaleX||1,m=c.x+P,_=c.y+P,p=m+u,y=_+d,g=x(t.height),v=f*g;let S=Math.round(g);S<=0&&(S=y-_);let I=Math.round(v);I<=0&&(I=p-m);const T=x(t.offsetX||0),L=x(-t.offsetY||0),z=M(m,_),j=M(p,y);return new tt(a,e,n,z,j,I,S,T,L,It,It,ze(t.angle),l,t.effects,o,h)}static fromSimpleFill(t,e,s=!1){const{color:i}=t,n=i&&t.style!=="esriSFSNull"&&et(i)||0,a=s?pt:0,o=t.materialKey;let h;if(e){const{rect:l,width:c,height:u,pixelRatio:d}=e,f=l.x+P,m=l.y+P,_=f+c,p=m+u,y=M(f,m),g=M(_,p);h=new tt(o,e,n,y,g,c/d,u/d,0,0,It,It,0,a,null,q,X)}else h=new tt(o,null,n,0,0,0,0,0,0,0,0,0,a,null,q,X);return h._maybeAddLineTemplate(t),h}static fromPictureFill(t,e,s=!1){const i=_i,{rect:n,width:a,height:o}=e,h=n.x+P,l=n.y+P,c=h+a,u=l+o,d=M(h,l),f=M(c,u),m=Math.round(x(t.width)),_=Math.round(x(t.height)),p=x(t.xoffset),y=x(-t.yoffset),g=t.materialKey,v=s?pt:0,S=new tt(g,e,i,d,f,m,_,p,y,It*t.xscale,It*t.yscale,0,v,null,q,X);return S._maybeAddLineTemplate(t),S}}class kn{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){this._resolver?(await this._resolver.promise,await this.acquire()):this._resolver=Di()}release(){const t=this._resolver;this._resolver=null,t==null||t.resolve()}}async function Bn(r,t,e){try{await r.acquire(),await t(e),r.release()}catch(s){throw r.release(),s}}const On={marker:w.MARKER,fill:w.FILL,line:w.LINE,text:w.TEXT};class Dn{constructor(t,e,s,i){const n={minScale:e==null?void 0:e.minScale,maxScale:e==null?void 0:e.maxScale},a=Gn(n);this.layers=t,this.data=e,this.hash=this._createHash()+a,this.rendererKey=s;const o={isOutline:!1,placement:null,symbologyType:A.DEFAULT,vvFlags:s};for(const h of t){const l=On[h.type];o.isOutline=h.type==="line"&&h.isOutline,h.materialKey=_e(l,o),h.maxVVSize=i,h.scaleInfo=n,h.templateHash+=a}}get type(){return"expanded-cim"}_createHash(){let t="";for(const e of this.layers)t+=e.templateHash;return t}}function Gn(r){return r.minScale||r.maxScale?r.minScale+"-"+r.maxScale:""}async function Nn(r,t,e){if(!r.name)throw new ft("style-symbol-reference-name-missing","Missing name in style symbol reference");if(r.styleName&&r.styleName==="Esri2DPointSymbolsStyle")return Kn(r,e);try{return Zn(await Gi(r,t,e),r.name,t,e)}catch(s){return ot(s),null}}async function Kn(r,t){const e=Ni.replace(/\{SymbolName\}/gi,r.name);try{const s=await ni(e,t);return ai(s.data)}catch(s){return ot(s),null}}async function Zn(r,t,e,s){const i=r.data,n={portal:e&&$(e.portal)?e.portal:Ki.getDefault(),url:Zi(r.baseUrl),origin:"portal-item"},a=i.items.find(h=>h.name===t);if(!a)throw new ft("symbolstyleutils:symbol-name-not-found",`The symbol name '${t}' could not be found`,{symbolName:t});let o=Ui(qi(a,"cimRef"),n);Xi()&&(o=Hi(o));try{const h=await ni(o,s);return ai(h.data)}catch(h){return ot(h),null}}const Xs=async(r,t,e)=>new Dn(await cr(r.data,t,e),r.data,r.rendererKey,r.maxVVSize),H=async(r,t,e,s)=>{if(!r)return null;if(r.type==="cim")return Xs(r,t,e);if(r.type==="web-style"){const i={type:"cim",data:await Nn(r,null,s),rendererKey:r.rendererKey,maxVVSize:r.maxVVSize};return Xs(i,t,e)}return r};function ee(r){if(!r)return null;const{type:t,cim:e,url:s,materialHash:i}=r,n={cim:e,type:t,mosaicHash:i,url:s,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null};switch(t){case"marker":n.size=r.size,n.path=r.path,n.animatedSymbolProperties=r.animatedSymbolProperties;break;case"line":n.dashTemplate=r.dashTemplate;break;case"text":n.text=r.text,n.fontName=r.fontName}return n}const k=Ct.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),Hs=new Array,Qe={isOutline:!1,placement:null,symbologyType:A.DEFAULT,vvFlags:0},Un={...is,hash:JSON.stringify(is),materialKey:_e(w.MARKER,Qe)},qn={...rs,hash:JSON.stringify(rs),materialKey:_e(w.LINE,Qe)},Xn={...ns,hash:JSON.stringify(ns),materialKey:_e(w.FILL,Qe)};function Q(r,t){const e=r.length;return r.push(null),t.then(s=>r[e]=s),r}function Ft(r){return!!(1&r)}function Hn(r){return r.name==="worker:port-closed"}class Yn{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new kn,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const s=t.hash;if(this._symbolToTemplate.has(s))return this._symbolToTemplate.get(s);const i=new Array;e&&this._createMeshTemplates(i,e,!0),this._createMeshTemplates(i,t,!1);const n=this._createGroupId(t.type==="expanded-cim"&&jn(t));return this._idToTemplateGroup.set(n,i),this._symbolToTemplate.set(s,n),n}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):Hs}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(Ft(t)||k.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):Hs}getMosaicItem(t,e){const s=this._createTemplateId(),i=new Promise(n=>this._idToResolver.set(s,n));return this._fetchQueue.push({symbol:t,id:s,glyphIds:e}),i}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?Bn(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],Xn,!1),marker:this._createMeshTemplates([],Un,!1),line:this._createMeshTemplates([],qn,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,s=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(s).then(()=>this._fetchResource(e,t).then(i=>{for(const{id:n,mosaicItem:a}of i)this._idToResolver.get(n)(a),this._idToResolver.delete(n)})).catch(i=>{De(i)?this._fetchQueue=this._fetchQueue.concat(e):Hn(i)||k.error(new ft("mapview-template-store","Unable to fetch requested texture resources",i))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return O(e,k)?U.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return O(e,k)?U.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return O(s,k)?tt.fromSimpleFill(t,s,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return O(s,k)?tt.fromPictureFill(t,s,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return O(s,k)?J.fromSimpleLine(t,s):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return O(e,k)?U.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return $t.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(ee(t),Ye(t.text));return O(e,k)?$t.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(ee(t));return O(e,k)?tt.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(ee(t));return O(e,k)?J.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(ee(t));return O(e,k)?U.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let s;switch(t.type){case"marker":s=await this._createCIMMarker(t);break;case"line":s=await this._createCIMLine(t);break;case"fill":s=await this._createCIMFill(t);break;case"text":s=await this._createCIMText(t)}return this._cimTemplateCache.set(e,s),s}async _createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let s;switch(t.type){case"marker":s=He.fromCIMMarker(t,this._tileInfo);break;case"line":s=Xe.fromCIMLine(t,this._tileInfo);break;case"fill":s=qe.fromCIMFill(t,this._tileInfo);break;case"text":s=je.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(e,s),s}_createPrimitiveMeshTemplates(t,e,s){switch(e.type){case"esriSMS":return Q(t,this._createSMS(e));case"esriPMS":return Q(t,this._createPMS(e));case"esriSFS":return Q(t,this._createSFS(e,s));case"line-marker":return Q(t,this._createLMS(e));case"esriPFS":return Q(t,this._createPFS(e,s));case"esriSLS":return Q(t,this._createSLS(e,!1));case"esriTS":return Q(t,this._createTS(e));default:return k.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,s){if(e.type.includes("3d"))return k.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const i of e.layers)typeof i.materialHash=="function"?Q(t,this._createDynamicCIM(i)):Q(t,this._createCIM(i));return t}if(e.type==="composite-symbol"){for(const i of e.layers)this._createPrimitiveMeshTemplates(t,i,s);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,s)}}const jn=r=>{if(!r.layers)return!1;for(const t of r.layers)if(typeof t.materialHash=="function")return!0;return!1};class Qn{constructor(t,e,s){this._loadPromise=Lr(),this._geometryType=t,this._idField=e,this._templateStore=s}update(t,e){$(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const s=new Map;if(t.type==="simple"){for(const i of t.classes){const n=ne.fromLabelClass(i,e);s.set(i.index,n)}return s}for(const i in t.classes){const n=t.classes[i];for(const a of n){const o=ne.fromLabelClass(a,e);s.set(a.index,o)}}return s}get templates(){return this._templateStore}async analyze(t,e,s,i,n,a,o){if(as(o))return;let h;s.type==="dictionary"&&(h=await s.analyze(this._idField,t.copy(),e,n,a,o));let l=0;for(;t.next();){let c;if(c=h?h[l++]:$(i)&&fi(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?i.match(this._idField,t,this._geometryType,n,a):s.match(this._idField,t,this._geometryType,n,a),t.setGroupId(c),Ft(c)){const u=this._templateStore.getDynamicTemplateGroup(c);for(const d of u)d&&d.analyze&&d.analyze(this._templateStore,t,n,a)}}return await this._loadPromise,this._templateStore.finalize(o)}async analyzeGraphics(t,e,s,i,n,a){if(as(a))return;const o=t.getCursor();for(s&&await s.analyze(this._idField,o.copy(),e,i,n,a);o.next();){let h=o.getGroupId();if(h!=null&&h!==-1||(h=s.match(this._idField,o,o.geometryType,i,n),o.setGroupId(h)),Ft(h)){const l=this._templateStore.getDynamicTemplateGroup(h);for(const c of l)c&&c.analyze&&c.analyze(this._templateStore,o,i,n)}o.setGroupId(h)}return await this._loadPromise,this._templateStore.finalize(a)}writeGraphic(t,e,s,i){const n=e.getGroupId(),a=e.getDisplayId(),o=this._templateStore.getTemplateGroup(n);if(t.featureStart(e.insertAfter,0),a!=null){if(Ft(n))for(const h of o)h&&h.bindFeature(e,null,null);if(o){for(const h of o)h&&h.write(t,e,s,i);t.featureEnd()}}}writeCursor(t,e,s,i,n,a,o){const h=e.getGroupId(),l=e.getDisplayId(),c=this._templateStore.getTemplateGroup(h),u=this._schema.mesh.sortKey;let d=0;if($(u)&&(d=u.fieldIndex!=null?e.getComputedNumericAtIndex(u.fieldIndex):u.field!=null?e.readAttribute(u.field):e.readAttribute(this._idField),d*=u.order==="asc"?1:-1),t.featureStart(0,d==null||isNaN(d)?0:d),l!=null&&c){if(Ft(h))for(const f of c)f.bindFeature(e,s,i);for(const f of c)f.write(t,e,n,o);if($(a)&&t.hasRecords){const f=a&&this._findLabelRef(c);this._writeLabels(t,e,a,f,n,o)}t.featureEnd()}}_findLabelRef(t){for(const e of t)if(e instanceof U)return e;return null}_writeLabels(t,e,s,i,n,a){for(const o of s)if($(o)&&o){const{glyphs:h,rtl:l,index:c}=o,u=this._labelTemplates.get(c);u.setZoomLevel(n),u.bindReferenceTemplate(i),u.bindTextInfo(h,l),u.write(t,e,null,a)}}}const Fe=Ct.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function Re(r,t,e,s){switch(r.type){case"simple":case"heatmap":return ut.fromBasicRenderer(r,t,e,s);case"map":return ts.fromUVRenderer(r,t,e,s);case"interval":return Je.fromCBRenderer(r,t,e,s);case"dictionary":return es.fromDictionaryRenderer(r,t,e,s);case"pie-chart":return oe.fromPieChartRenderer(r,t,e,s);case"subtype":return oe.fromSubtypes(r,t,e,s)}}class ut{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,s,i){const n=new ut;if(t.symbol){const a=await H(t.symbol,s,i),o=e.createTemplateGroup(a,null);n.setDefault(o)}return n}static async fromPieChartRenderer(t,e,s,i){const n=new ut;if(t.markerSymbol){const a=await H(t.markerSymbol,s,i);let o;t.fillSymbol&&(o=await H(t.fillSymbol,s,i));const h=e.createTemplateGroup(a,o);n.setDefault(h)}return n}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,s,i,n){return this.getDefault()}async analyze(t,e,s,i,n,a){return null}}class oe extends ut{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,s,i){const n=new Map,a=[];for(const o in t.renderers){const h=parseInt(o,10),l=Re(t.renderers[o],e,s,i).then(c=>n.set(h,c));a.push(l)}return await Promise.all(a),new oe(n,t.subtypeField)}match(t,e,s,i,n){const a=e.readAttribute(this._subtypeField),o=this._subMatchers.get(a);return o?o.match(t,e,s,i,n):null}}class Je extends ut{constructor(t,e,s,i){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=i,this._field=t,this._normalizationInfo=s}static async fromCBRenderer(t,e,s,i){const{isMaxInclusive:n,normalizationField:a,normalizationTotal:o,normalizationType:h}=t,l=t.field,c=new Je(l,n,{normalizationField:a,normalizationTotal:o,normalizationType:h},t.fieldIndex),u=await H(t.backgroundFillSymbol,s,i);await Promise.all(t.intervals.map(async f=>{const m=await H(f.symbol,s,i),_=await e.createTemplateGroup(m,u),p={min:f.min,max:f.max};c.add(p,_)}));const d=await H(t.defaultSymbol,s,i);if(d){const f=await e.createTemplateGroup(d,u);c.setDefault(f)}return c}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((s,i)=>s.interval.min-i.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,s,i,n){if(this._fieldIndex==null&&!this._field)return this.getDefault();const a=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(a==null||isNaN(a)||a===1/0||a===-1/0)return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:h,result:l}=this._intervals[o],c=a>=h.min,u=this._isMaxInclusive?a<=h.max:a<h.max;if(c&&u)return l}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:s,normalizationTotal:i,normalizationType:n}=this._normalizationInfo,a=!!s&&t.readAttribute(s);if(n)switch(n){case"esriNormalizeByField":return a?e/a:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/i*100;default:return void Fe.error(`Found unknown normalization type: ${n}`)}else Fe.error("Normalization is required, but no type was set!")}}class ts extends ut{constructor(t,e,s){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=s,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,s,i){const n=t.fieldDelimiter,a=[t.field];t.field2&&a.push(t.field2),t.field3&&a.push(t.field3);const o=await H(t.backgroundFillSymbol,s,i),h=new ts(a,n,t.fieldIndex);await Promise.all(t.map.map(async c=>{const u=await H(c.symbol,s,i),d=await e.createTemplateGroup(u,o);c.value==="<Null>"?h.setNullResult(d):h.add(c.value,d)}));const l=await H(t.defaultSymbol,s,i);if(l){const c=await e.createTemplateGroup(l,o);h.setDefault(c)}return h}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,s,i,n){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const a=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(a==null||a===""||a==="<Null>"))return this._nullResult;if(a==null)return this.getDefault();const o=a.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const s of this._fields){const i=t.readAttribute(s);i==null||i===""?e.push("<Null>"):e.push(i)}return e.join(this._seperator)}}async function Jn(r,t){const e=r||1;if(typeof e=="number")return(i,n,a)=>e;const s=await ji(e,t.spatialReference,t.fields);return(i,n,a)=>Qi(s,i,{$view:a},t.geometryType,n)||1}let we;async function ta(){return we||(we=oi(()=>import("./createSymbolSchema.ceaf7719.js"),["assets/createSymbolSchema.ceaf7719.js","assets/TileInfoView.2ed0d6a8.js","assets/index.347f2ee6.js","assets/index.a651de9c.css","assets/cimAnalyzer.07c3575e.js","assets/BidiEngine.d8bba3fc.js","assets/enums.6b5e3ac2.js","assets/number.30628ef2.js","assets/Pipeline.e5b86b67.js","assets/QueryEngine.cce283e7.js","assets/QueryEngineResult.fb48dac5.js","assets/WhereClause.b191b7a3.js","assets/utils.40423a49.js","assets/generateRendererUtils.a175dd7f.js","assets/json.879c9adc.js","assets/QueryEngineCapabilities.78217f95.js","assets/StreamFeatureManager.a70d79e9.js","assets/quickselect.3948ea39.js","assets/centroid.28bc38cc.js","assets/ogcFeatureUtils.91843bda.js","assets/geojson.42b96238.js","assets/clientSideDefaults.459207f2.js","assets/createConnection.2c16c68b.js","assets/tileUtils.1cefcafb.js","assets/TileClipper.b43beef6.js","assets/Geometry.d049a63c.js","assets/GeometryUtils.12948ca8.js"])),we}class es extends ut{constructor(t,e,s,i,n,a){super(),this.type="dictionary",this._groupIdCache=new Yi(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=s,this._scaleFn=i,this._schemaUtilsModule=n,this._symbolOptions=a}static async fromDictionaryRenderer(t,e,s,i){const[{DictionaryLoader:n},a]=await Promise.all([oi(()=>import("./index.347f2ee6.js").then(l=>l.uh),["assets/index.347f2ee6.js","assets/index.a651de9c.css"]),ta()]),o=new n(t.url,t.config,t.fieldMap);await o.fetchResources({spatialReference:s.spatialReference,fields:s.fields});const h=await Jn(t.scaleExpression,s);return new es(o,e,s,h,a,t.symbolOptions)}async _analyzeFeature(t,e,s,i,n){const a=t.readLegacyFeature(),o=this._scaleFn(a,s,i),h=this._attributeHash(a)+"-"+o,l=this._groupIdCache.get(h);if(l)return l;const c={...i,spatialReference:this._info.spatialReference,abortOptions:n,fields:this._info.fields},u=await this._loader.getSymbolAsync(a,c),d=this._schemaUtilsModule.createSymbolSchema(u,this._symbolOptions),f=H(d,this._info,e,n).then(m=>{if(m.type!=="expanded-cim")return Fe.error(new ft("mapview-bad-type",`Found unexpected type ${m.type} in dictionary response`)),null;m.hash+="-"+o;for(const _ of m.layers)_.scaleFactor=o,_.templateHash+="-"+o;return this._templates.createTemplateGroup(m,null)});return this._groupIdCache.put(h,f,1),f}async analyze(t,e,s,i,n,a){const o=e.getCursor(),h=[];for(;o.next();)h.push(this._analyzeFeature(o,s,i,n,a));return Promise.all(h)}match(t,e,s,i,n){return null}_attributeHash(t){let e="";for(const s of this._symbolFields){const i=this._fieldMap[s];i&&(e+=t.attributes[i]+"-")}return e}}class ea{constructor(t){this._remoteClient=t,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null}destroy(){}async fetchResource(t,e){const s=this._resourceMap,i=s.get(t);if(i)return i;let n=this._inFlightResourceMap.get(t);if(n)return n;try{n=this._remoteClient.invoke("tileRenderer.fetchResource",{url:t},{...e}),this._inFlightResourceMap.set(t,n),n.then(a=>(this._inFlightResourceMap.delete(t),s.set(t,a),a))}catch(a){return De(a)?null:{width:0,height:0}}return n}getResource(t){var e;return(e=this._resourceMap.get(t))!=null?e:null}}function Ys(r,t){return(!r.minScale||r.minScale>=t)&&(!r.maxScale||r.maxScale<=t)}function js(r){const t=r.message,e={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin,version:t.version},transferList:new Array};for(const s in t.data){const i=t.data[s];if(e.message.data[s]=null,$(i)){const n=i.stride,a=i.indices.slice(0),o=i.vertices.slice(0),h=i.records.slice(0),l={stride:n,indices:a,vertices:o,records:h,metrics:Rt(i.metrics,c=>c.slice(0))};e.transferList.push(a,o,h),e.message.data[s]=l}}return e}let We=class extends br{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new ea(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(r){this._bufferIds.forEach(t=>{t.forEach(r)})}async update(r,t){const e=t.schema.processors[0];if(e.type!=="symbol")return;const s=Ji(this._schema,e);(os(s,"mesh")||os(s,"target"))&&(r.mesh=!0,r.why.mesh.push("Symbology changed"),this._schema=e,this._factory=this._createFactory(e),this._factory.update(e,this.tileStore.tileScheme.tileInfo))}onTileMessage(r,t,e,s){return ot(s),this._onTileData(r,t,e,s)}onTileClear(r){const t={clear:!0};return this._bufferData.delete(r.key.id),this._bufferIds.delete(r.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:r.id,data:t})}onTileError(r,t,e){const s=e.signal,i={tileKey:r.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:s})}onTileUpdate(r){for(const t of r.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of r.added)this._bufferData.forEach(e=>{for(const s of e)s.message.tileKey===t.id&&this._updateTileMesh("append",t,js(s),[],!1,!1,null)})}_addBufferData(r,t){this._bufferData.has(r)||this._bufferData.set(r,[]),this._bufferData.get(r).push(js(t))}_createFactory(r){const{geometryType:t,objectIdField:e,fields:s}=this.service,i=(l,c)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",l,c),n={geometryType:t,fields:s,spatialReference:tr.fromJSON(this.spatialReference)},a=new Yn(i,this.tileStore.tileScheme.tileInfo),{matcher:o,aggregateMatcher:h}=r.mesh;return this._store=a,this._matchers.feature=Re(o,a,n,this._resourceManagerProxy),this._matchers.aggregate=Rt(h,l=>Re(l,a,n,this._resourceManagerProxy)),new Qn(t,e,a)}async _onTileData(r,t,e,s){ot(s);const{type:i,addOrUpdate:n,remove:a,clear:o,end:h}=t,l=!!this._schema.mesh.sortKey;if(!n){const u={type:i,addOrUpdate:null,remove:a,clear:o,end:h,sort:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:r.id,data:u},s)}const c=this._processFeatures(r,n,e,s,t.status.version);try{const u=await c;if(W(u)){const f={type:i,addOrUpdate:null,remove:a,clear:o,end:h,sort:l};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:r.id,data:f},s)}const d=[];for(const f of u){let m=!1;const _=f.message.bufferIds,p=r.key.id,y=f.message.tileKey;if(p!==y&&$(_)){if(!this.tileStore.get(y)){this._addBufferData(p,f),d.push(f);continue}let g=this._bufferIds.get(y);g||(g=new Set,this._bufferIds.set(y,g));const v=Array.from(_);for(const S of v){if(g.has(S)){m=!0;break}g.add(S)}}m||(this._addBufferData(p,f),d.push(f))}await Promise.all(d.map(f=>{const m=r.key.id===f.message.tileKey,_=m?t.remove:[],p=m&&t.end;return this._updateTileMesh(i,r,f,_,p,t.clear,s.signal)}))}catch(u){this._handleError(r,u,s)}}async _updateTileMesh(r,t,e,s,i,n,a){const o=r,h=e.message.tileKey,l=!!this._schema.mesh.sortKey;h!==t.key.id&&(i=!1);const c=Rt(e,m=>m.message),u=Rt(e,m=>m.transferList)||[],d={type:o,addOrUpdate:c,remove:s,clear:n,end:i,sort:l},f={transferList:he(u)||[],signal:a};return ot(f),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:h,data:d},f)}async _processFeatures(r,t,e,s,i){if(W(t)||!t.hasFeatures)return null;const n={transform:r.transform,hasZ:!1,hasM:!1},a=this._factory,o={viewingMode:"",scale:r.scale},h=await this._matchers.feature,l=await this._matchers.aggregate;ot(s);const c=this._getLabelInfos(r,t);return await a.analyze(t.getCursor(),this._resourceManagerProxy,h,l,n,o),ot(s),this._writeFeatureSet(r,t,n,c,a,e,i)}_writeFeatureSet(r,t,e,s,i,n,a){const o=t.getSize(),h=this._schema.mesh.matcher.symbologyType,l=new Dr(r.key.id,{features:o,records:o,metrics:0},h,n,h!==A.HEATMAP,a),c={viewingMode:"",scale:r.scale},u=t.getCursor();for(;u.next();)try{const f=u.getDisplayId(),m=$(s)?s.get(f):null;i.writeCursor(l,u,e,c,r.level,m,this._resourceManagerProxy)}catch{}const d=r.tileInfoView.tileInfo.isWrappable;return l.serialize(d)}_handleError(r,t,e){if(!De(t)){const s={tileKey:r.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",s,{signal:e.signal})}}_getLabelingSchemaForScale(r){const t=this._schema.mesh.labels;if(W(t))return null;if(t.type==="subtype"){const s={type:"subtype",classes:{}};let i=!1;for(const n in t.classes){const a=t.classes[n].filter(o=>Ys(o,r.scale));i=i||!!a.length,s.classes[n]=a}return i?s:null}const e=t.classes.filter(s=>Ys(s,r.scale));return e.length?{type:"simple",classes:e}:null}_getLabels(r,t){var e;if(t.type==="subtype"){const s=this.service.subtypeField,i=er(s,"Expected to find subtype Field"),n=r.readAttribute(i);return n==null?[]:(e=t.classes[n])!=null?e:[]}return t.classes}_getLabelInfos(r,t){const e=this._getLabelingSchemaForScale(r);if(W(e))return null;const s=new Map,i=t.getCursor();for(;i.next();){const n=i.getDisplayId(),a=[],o=fi(n),h=o&&i.readAttribute("cluster_count")!==1?"aggregate":"feature",l=this._getLabels(i,e);for(const c of l){if(c.target!==h)continue;const u=i.getStorage(),d=o&&h==="feature"?u.getComputedStringAtIndex(i.readAttribute("referenceId"),c.fieldIndex):u.getComputedStringAtIndex(n,c.fieldIndex);if(!d)continue;const f=Te(d.toString()),m=f[0],_=f[1];this._store.getMosaicItem(c.symbol,Ye(m)).then(p=>{a[c.index]={glyphs:p.glyphMosaicItems,rtl:_,index:c.index}})}s.set(n,a)}return s}};We=R([ke("esri.views.2d.layers.features.processors.SymbolProcessor")],We);const sa=We,_a=Object.freeze(Object.defineProperty({__proto__:null,default:sa},Symbol.toStringTag,{value:"Module"}));export{da as A,_a as S,Mi as _,_e as f};
