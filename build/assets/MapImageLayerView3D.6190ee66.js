import{r as _,hh as D,ia as B,ib as q,e as n,f as y,ic as Z,hl as K,at as T,ea as W,id as X,k as R,cd as M,ie as C,g as U,dX as Y,g9 as ee,ig as te,ih as re,v as se,ii as ie,ij as ae,bz as oe,hR as ne,ik as le,cO as pe,aF as ue,s as V,br as ye,il as he,im as ce,c1 as de,t as me,ad as fe,g$ as ge,dL as we,aK as be,b6 as ve,dM as xe}from"./index.bd80e406.js";import{F as $e}from"./DynamicLayerView3D.82c78fd6.js";import{c as Fe}from"./ExportImageParameters.540730fe.js";import{n as N}from"./floorFilterUtils.05eb8c6a.js";import{s as A}from"./clickToleranceUtils.974405a9.js";import{i as Pe}from"./sublayerUtils.cb2795c8.js";import{a as Ee}from"./drapedUtils.5a0d6f05.js";import"./LayerView3D.a3a76aef.js";import"./projectExtentUtils.f3988d8f.js";import"./ImageMaterial.870c0942.js";import"./LayerView.3c9ee51e.js";import"./RefreshableLayerView.befc29a9.js";const L=o=>o.spatialReference.wkid||JSON.stringify(o.spatialReference);function Ie(o,s){const{dpi:r,gdbVersion:t,geometry:e,geometryPrecision:i,height:c,layerOption:u,mapExtent:a,maxAllowableOffset:l,returnFieldName:p,returnGeometry:h,returnUnformattedValues:g,returnZ:F,spatialReference:x,timeExtent:$,tolerance:m,width:E}=o.toJSON(),{dynamicLayers:w,layerDefs:f,layerIds:b}=_e(o),G=s&&_(s.geometry)?s.geometry:null,v={geometryPrecision:i,maxAllowableOffset:l,returnFieldName:p,returnGeometry:h,returnUnformattedValues:g,returnZ:F,tolerance:m},I=G&&G.toJSON()||e;if(v.imageDisplay=`${E},${c},${r}`,t&&(v.gdbVersion=t),I&&(delete I.spatialReference,v.geometry=JSON.stringify(I),v.geometryType=D(I)),x?v.sr=x.wkid||JSON.stringify(x):I&&I.spatialReference?v.sr=L(I):a&&a.spatialReference&&(v.sr=L(a)),v.time=$?[$.start,$.end].join(","):null,a){const{xmin:H,ymin:k,xmax:Q,ymax:z}=a;v.mapExtent=`${H},${k},${Q},${z}`}return f&&(v.layerDefs=f),w&&!f&&(v.dynamicLayers=w),v.layers=u==="popup"?"visible":u,b&&!w&&(v.layers+=`:${b.join(",")}`),v}function _e(o){var x,$;const{mapExtent:s,floors:r,width:t,sublayers:e,layerIds:i,layerOption:c,gdbVersion:u}=o,a=($=(x=e==null?void 0:e.find(m=>m.layer!=null))==null?void 0:x.layer)==null?void 0:$.serviceSublayers,l=c==="popup",p={},h=B({extent:s,width:t,spatialReference:s==null?void 0:s.spatialReference}),g=[],F=m=>{const E=h===0,w=m.minScale===0||h<=m.minScale,f=m.maxScale===0||h>=m.maxScale;if(m.visible&&(E||w&&f))if(m.sublayers)m.sublayers.forEach(F);else{if((i==null?void 0:i.includes(m.id))===!1||l&&(!m.popupTemplate||!m.popupEnabled))return;g.unshift(m)}};if(e==null||e.forEach(F),e&&!g.length)p.layerIds=[];else{const m=Pe(g,a,u),E=g.map(w=>{const f=N(r,w);return w.toExportImageJSON(f)});if(m)p.dynamicLayers=JSON.stringify(E);else{if(e){let f=g.map(({id:b})=>b);i&&(f=f.filter(b=>i.includes(b))),p.layerIds=f}else i!=null&&i.length&&(p.layerIds=i);const w=Re(r,g);if(_(w)&&w.length){const f={};for(const b of w)b.definitionExpression&&(f[b.id]=b.definitionExpression);Object.keys(f).length&&(p.layerDefs=JSON.stringify(f))}}}return p}function Re(o,s){const r=!!(o!=null&&o.length),t=s.filter(e=>e.definitionExpression!=null||r&&e.floorInfo!=null);return t.length?t.map(e=>{const i=N(o,e),c=q(i,e.definitionExpression);return{id:e.id,definitionExpression:c}}):null}var S;let d=S=class extends M{constructor(o){super(o),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(o){return C(S,o)}};n([y({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),n([y()],d.prototype,"floors",void 0),n([y({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),n([y({types:Z,json:{read:K,write:!0}})],d.prototype,"geometry",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"height",void 0),n([y({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),n([y({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),n([y({type:T,json:{write:!0}})],d.prototype,"mapExtent",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),n([y({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),n([y({type:W,json:{write:!0}})],d.prototype,"spatialReference",void 0),n([y()],d.prototype,"sublayers",void 0),n([y({type:X,json:{write:!0}})],d.prototype,"timeExtent",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),n([y({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=S=n([R("esri.rest.support.IdentifyParameters")],d);const J=d;let P=class extends M{constructor(o){super(o),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(o,s){return U.fromJSON({attributes:{...s.attributes},geometry:{...s.geometry}})}writeFeature(o,s){if(!o)return;const{attributes:r,geometry:t}=o;r&&(s.attributes={...r}),_(t)&&(s.geometry=t.toJSON(),s.geometryType=te.toJSON(t.type))}};n([y({type:String,json:{write:!0}})],P.prototype,"displayFieldName",void 0),n([y({type:U})],P.prototype,"feature",void 0),n([Y("feature",["attributes","geometry"])],P.prototype,"readFeature",null),n([ee("feature")],P.prototype,"writeFeature",null),n([y({type:Number,json:{write:!0}})],P.prototype,"layerId",void 0),n([y({type:String,json:{write:!0}})],P.prototype,"layerName",void 0),P=n([R("esri.rest.support.IdentifyResult")],P);const Oe=P;async function Se(o,s,r){const t=(s=Ne(s)).geometry?[s.geometry]:[],e=re(o);return e.path+="/identify",se(t).then(i=>{const c=Ie(s,{geometry:i&&i[0]}),u=ie({...e.query,f:"json",...c}),a=ae(u,r);return oe(e.path,a).then(je).then(l=>Ge(l,s.sublayers))})}function je(o){const s=o.data;return s.results=s.results||[],s.exceededTransferLimit=Boolean(s.exceededTransferLimit),s.results=s.results.map(r=>Oe.fromJSON(r)),s}function Ne(o){return o=J.from(o)}function Ge(o,s){if(!(s!=null&&s.length))return o;const r=new Map;function t(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(t)}s.forEach(t);for(const e of o.results)e.feature.sourceLayer=r.get(e.layerId);return o}let O=null;const Ve=o=>{let s=class extends o{constructor(){super(...arguments),this._featuresResolutions=new WeakMap,this.highlightGraphics=new le,this.updateHighlightedFeatures=pe(async r=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(r).catch(()=>{}))})}initialize(){this.exportImageParameters=new Fe({layer:this.layer}),this.handles.add([ue(()=>this.highlightGraphics,"change",r=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(r.added).catch(()=>{})),this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var r;return(r=this.exportImageParameters)==null||r.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(r,t){var c,u,a,l,p,h;const{layer:e}=this;if(!r)throw new V("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:e});const i=(a=(u=(c=this.layer.capabilities)==null?void 0:c.operations)==null?void 0:u.supportsQuery)!=null?a:!0;if(!(((h=(p=(l=this.layer.capabilities)==null?void 0:l.operations)==null?void 0:p.supportsIdentify)!=null?h:!0)&&this.layer.version>=10.5)&&!i)throw new V("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:e});return i?this._fetchPopupFeaturesUsingQueries(r,t):this._fetchPopupFeaturesUsingIdentify(r,t)}canResume(){var r;return!!super.canResume()&&!((r=this.timeExtent)!=null&&r.isEmpty)}async _updateHighlightedFeaturesSymbols(r){for(const t of r){const e="renderer"in t.sourceLayer&&t.sourceLayer.renderer;"geometryType"in t.sourceLayer&&t.sourceLayer.geometryType==="point"&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(t).then(async i=>{var a;let c="width"in i&&"height"in i&&i.width!=null&&i.height!=null?Math.max(i.width,i.height):"size"in i?i.size:null;const u="visualVariables"in e&&((a=e.visualVariables)==null?void 0:a.find(l=>l.type==="size"));u&&(O||(O=(await ye(()=>import("./index.bd80e406.js").then(l=>l.u2),["assets/index.bd80e406.js","assets/index.785c8c13.css"])).getSize),c=O(u,t,{view:this.view.type,scale:this.view.scale,shape:i.type==="simple-marker"?i.style:null})),this.highlightGraphics.includes(t)&&(t.symbol=new he({style:"square",size:c,xoffset:"xoffset"in i?i.xoffset:0,yoffset:"yoffset"in i?i.yoffset:0}),t.visible=!0,this.highlightGraphicUpdated(t,"symbol"))})}}async _updateHighlightedFeaturesGeometries(r){this._highlightGeometriesResolution=r;const t=this.highlightGraphics;if(!t.length||!this.layer.capabilities.operations.supportsQuery)return;const e=this._getTargetResolution(r),i=new Map;for(const a of t)if(!this._featuresResolutions.has(a)||this._featuresResolutions.get(a)>e){const l=a.sourceLayer;ce(i,l,()=>new Map).set(a.getObjectId(),a)}const c=Array.from(i,([a,l])=>{const p=a.createQuery();return p.objectIds=[...l.keys()],p.outFields=[a.objectIdField],p.returnGeometry=!0,p.maxAllowableOffset=e,p.outSpatialReference=this.view.spatialReference,a.queryFeatures(p)}),u=await Promise.all(c);if(!this.destroyed)for(const{features:a}of u)for(const l of a){const p=l.sourceLayer,h=i.get(p).get(l.getObjectId());h&&this.highlightGraphics.includes(h)&&(h.geometry=l.geometry,this.highlightGraphicUpdated(h,"geometry"),this._featuresResolutions.set(h,e))}}_getTargetResolution(r){const t=r*de(this.view.spatialReference),e=t/16;return e<=10?0:r/t*e}async _fetchPopupFeaturesUsingIdentify(r,t){const e=await this._createIdentifyParameters(r,t);if(me(e))return[];const{results:i}=await Se(this.layer.parsedUrl,e);return i.map(c=>c.feature)}async _createIdentifyParameters(r,t){const{floors:e,spatialReference:i,scale:c}=this.view,u=_(t)?t.event:null,a=await this._collectPopupProviders(this.layer.sublayers,c,t);if(!a.length)return null;await Promise.all(a.map(({sublayer:x})=>x.load().catch(()=>{})));const l=Math.min(fe("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((x,$)=>$.renderer?A({renderer:$.renderer,event:u}):x,2)),p=this.createFetchPopupFeaturesQueryGeometry(r,l),h=ge(c,i),g=Math.round(p.width/h),F=new T({xmin:p.center.x-h*g,ymin:p.center.y-h*g,xmax:p.center.x+h*g,ymax:p.center.y+h*g,spatialReference:p.spatialReference});return new J({floors:e,gdbVersion:this.layer.gdbVersion,geometry:r,height:g,layerOption:"popup",mapExtent:F,returnGeometry:!0,spatialReference:i,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:l,width:g})}async _fetchPopupFeaturesUsingQueries(r,t){const e=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,t),i=_(t)?t.event:null,c=e.map(async({sublayer:u,popupTemplate:a})=>{var E,w;await u.load().catch(()=>{});const l=u.createQuery(),p=A({renderer:u.renderer,event:i}),h=this.createFetchPopupFeaturesQueryGeometry(r,p);if(l.geometry=h,l.outFields=await we(u,a),l.timeExtent=this.timeExtent,"floors"in this.view){const f=(w=(E=this.view)==null?void 0:E.floors)==null?void 0:w.clone(),b=N(f,u);_(b)&&(l.where=l.where?`(${l.where}) AND (${b})`:b)}const g=this._getTargetResolution(h.width/p),F=await this._loadArcadeModules(a),x=u.geometryType==="point"||F&&F.arcadeUtils.hasGeometryOperations(a);x||(l.maxAllowableOffset=g);const{features:$}=await u.queryFeatures(l),m=x?0:g;for(const f of $)this._featuresResolutions.set(f,m);return $});return(await be(c)).reverse().reduce((u,a)=>a.value?[...u,...a.value]:u,[]).filter(u=>u!=null)}async _collectPopupProviders(r,t,e){const i=[],c=async a=>{const l=a.minScale===0||t<=a.minScale,p=a.maxScale===0||t>=a.maxScale;if(a.visible&&l&&p){if(a.sublayers)a.sublayers.forEach(c);else if(a.popupEnabled){const h=xe(a,{...e,defaultPopupTemplateEnabled:!1});_(h)&&i.unshift({sublayer:a,popupTemplate:h})}}},u=r.toArray().reverse().map(c);return await Promise.all(u),i}_loadArcadeModules(r){var t;if(((t=r.expressionInfos)==null?void 0:t.length)||Array.isArray(r.content)&&r.content.some(e=>e.type==="expression"))return ve()}};return n([y()],s.prototype,"highlightGraphics",void 0),n([y()],s.prototype,"exportImageParameters",void 0),n([y({readOnly:!0})],s.prototype,"exportImageVersion",null),n([y()],s.prototype,"layer",void 0),n([y()],s.prototype,"suspended",void 0),n([y(ne)],s.prototype,"timeExtent",void 0),s=n([R("esri.views.layers.MapImageLayerView")],s),s};let j=class extends Ve($e){constructor(){super(...arguments),this.type="map-image-3d"}initialize(){this.updatingHandles.add(()=>this.exportImageVersion,()=>this.updatingHandles.addPromise(this.refreshDebounced()))}createFetchPopupFeaturesQueryGeometry(o,s){return Ee(o,s,this.view)}highlight(o){return{remove:()=>{}}}highlightGraphicUpdated(o,s){}getFetchOptions(){return{timeExtent:this.timeExtent}}};j=n([R("esri.views.3d.layers.MapImageLayerView3D")],j);const qe=j;export{qe as default};
