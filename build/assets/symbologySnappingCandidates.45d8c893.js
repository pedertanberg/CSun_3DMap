import{nE as x,ah as m,r as g,t as b,ai as I,im as v,ab as z,y,p3 as _}from"./index.f2e9cdcf.js";function k(a=!1,t){if(a){const{elevationInfo:e,alignPointsInFeatures:n,spatialReference:s}=t;return new E(e,n,s)}return new w}class w{async alignCandidates(t,e){return t}notifyElevationSourceChange(){}}const j=1024;class E{constructor(t,e,n){this._elevationInfo=t,this._alignPointsInFeatures=e,this.spatialReference=n,this._alignmentsCache=new x(j),this._cacheVersion=0,this._metersPerVerticalUnit=m(n)}async alignCandidates(t,e){const n=this._elevationInfo;return g(n)&&n.mode==="absolute-height"&&!n.featureExpressionInfo?(this._alignAbsoluteElevationCandidates(t,n),t):this._alignComputedElevationCandidates(t,e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}_alignAbsoluteElevationCandidates(t,e){const{offset:n,unit:s}=e;if(b(n))return;const o=n*(I(s!=null?s:"meters")/this._metersPerVerticalUnit);for(const i of t)switch(i.type){case"edge":i.start.z+=o,i.end.z+=o;continue;case"vertex":i.target.z+=o;continue}}async _alignComputedElevationCandidates(t,e){const n=new Map;for(const r of t)v(n,r.objectId,S).push(r);const[s,o,i]=this._prepareQuery(n),c=await this._alignPointsInFeatures(s,e);if(z(e),i!==this._cacheVersion)return this._alignComputedElevationCandidates(t,e);this._applyCacheAndResponse(s,c,o);const{drapedObjectIds:h,failedObjectIds:d}=c,f=[];for(const r of t){const{objectId:u}=r;h.has(u)&&r.type==="edge"&&(r.draped=!0),d.has(u)||f.push(r)}return f}_prepareQuery(t){const e=[],n=[];for(const[s,o]of t){const i=[];for(const c of o)this._addToQueriesOrCachedResult(s,c.target,i,n),c.type==="edge"&&(this._addToQueriesOrCachedResult(s,c.start,i,n),this._addToQueriesOrCachedResult(s,c.end,i,n));i.length!==0&&e.push({objectId:s,points:i})}return[e,n,this._cacheVersion]}_addToQueriesOrCachedResult(t,e,n,s){const o=C(t,e),i=this._alignmentsCache.get(o);g(i)?s.push(new V(e,i)):n.push(e)}_applyCacheAndResponse(t,{elevations:e,drapedObjectIds:n,failedObjectIds:s},o){for(const h of o)h.apply();let i=0;const c=this._alignmentsCache;for(const{objectId:h,points:d}of t){if(s.has(h)){i+=d.length;continue}const f=!n.has(h);for(const r of d){const u=C(h,r),l=e[i++];r.z=l,f&&c.put(u,l,1)}}}}class V{constructor(t,e){this.point=t,this.z=e}apply(){this.point.z=this.z}}function C(a,{x:t,y:e,z:n}){return`${a}-${t}-${e}-${n!=null?n:0}}`}function S(){return[]}class O{filter(t,e){return e}notifyElevationSourceChange(){}}class R{filter(t,e){const{point:n,distance:s}=t,{z:o}=n;if(o==null||e.length===0)return e;const i=A(s),c=this._updateCandidatesTo3D(e,n,i).filter(Q);return c.sort(F),c}_updateCandidatesTo3D(t,e,n){for(const s of t)switch(s.type){case"edge":T(s,e,n);continue;case"vertex":P(s,e,n);continue}return t}}function Q(a){return a.distance<=1}function B(a=!1){return a?new R:new O}function T(a,t,{x:e,y:n,z:s}){const{start:o,end:i,target:c}=a;a.draped||M(c,t,o,i);const h=(t.x-c.x)/e,d=(t.y-c.y)/n,f=(t.z-c.z)/s;a.distance=Math.sqrt(h*h+d*d+f*f)}function M(a,t,e,n){const s=n.x-e.x,o=n.y-e.y,i=n.z-e.z,c=s*s+o*o+i*i,h=(t.x-e.x)*s+(t.y-e.y)*o+i*(t.z-e.z),d=Math.min(1,Math.max(0,h/c)),f=e.x+s*d,r=e.y+o*d,u=e.z+i*d;a.x=f,a.y=r,a.z=u}function P(a,t,{x:e,y:n,z:s}){const{target:o}=a,i=(t.x-o.x)/e,c=(t.y-o.y)/n,h=(t.z-o.z)/s,d=Math.sqrt(i*i+c*c+h*h);a.distance=d}function A(a){return typeof a=="number"?{x:a,y:a,z:a}:a}function F(a,t){return a.distance-t.distance}function G(a=!1,t){return a?new U(t):new q}class q{async fetch(){return[]}notifySymbologyChange(){}}const D=1024;class U{constructor(t){this._getSymbologyCandidates=t,this._candidatesCache=new x(D),this._cacheVersion=0}async fetch(t,e){if(t.length===0)return[];const n=[],s=[],o=this._candidatesCache;for(const r of t){const u=$(r),l=o.get(u);if(l)for(const p of l)s.push(y(p));else n.push(r),o.put(u,[],1)}if(n.length===0)return s;const i=this._cacheVersion,{candidates:c,sourceCandidateIndices:h}=await this._getSymbologyCandidates(n,e);if(z(e),i!==this._cacheVersion)return this.fetch(t,e);const d=[],{length:f}=c;for(let r=0;r<f;++r){const u=c[r],l=$(n[h[r]]),p=o.get(l);p.push(u),o.put(l,p,p.length),d.push(y(u))}return s.concat(d)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function $(a){var t,e,n;switch(a.type){case"vertex":{const{objectId:s,target:o}=a,i=`${s}-vertex-${o.x}-${o.y}-${(t=o.z)!=null?t:0}`;return _(i).toString()}case"edge":{const{objectId:s,start:o,end:i}=a,c=`${s}-edge-${o.x}-${o.y}-${(e=o.z)!=null?e:0}-to-${i.x}-${i.y}-${(n=i.z)!=null?n:0}`;return _(c).toString()}default:return""}}export{B as a,G as n,k as r};
