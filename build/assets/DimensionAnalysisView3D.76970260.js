import{fV as zs,b2 as Vs,km as Is,kn as ks,aZ as Fs,r as m,lv as Ns,t as y,aS as hi,fS as qt,aR as se,aq as v,lw as Gs,lx as Zs,an as V,lr as M,kc as Ys,aj as Ke,ly as en,kk as tn,et as nn,lz as C,k9 as te,fT as D,kY as On,kO as Qe,k8 as Rn,eu as Di,lA as de,lB as Xe,lC as sn,en as qs,fU as wi,e as h,f as p,k as N,m as ye,b as st,z as gt,kF as Us,G as E,N as Y,kz as js,ak as Ln,l as R,lD as Xs,lE as et,aU as $t,lF as pt,lG as xi,lH as tt,lI as Ws,ft as zi,lJ as An,g_ as ce,jw as B,lK as Bs,aV as ft,l8 as Pi,iU as Ei,fg as rt,l9 as rn,ld as Js,lL as Ks,lM as Qs,lN as er,lO as tr,jW as jt,kt as b,kQ as Re,b7 as re,i_ as ui,kv as We,fK as _t,kP as Hn,lP as pi,lQ as ir,iV as nr,lR as sr,lS as rr,lT as or,cN as Dn,lU as ke,aT as zn,kK as ar,kJ as he,l5 as fi,gR as lr,l0 as At,lo as bt,cd as Vn,fR as yt,dU as cr,iq as Ze,kW as dr,fs as hr,kw as He,lV as ur,fH as pr,dh as on,lW as fr,j as ot,h as Xt,l4 as vt,l3 as Ct,l2 as Le,lX as mr,ls as St,lY as gr,lZ as an,l_ as Ae,l$ as Mi,gW as ze,B as Vi,aL as _r,U as it,dT as yr,ab as vr,kV as Sr,br as Ht,gS as ln,kT as In,kg as kn,a3 as wr,bZ as cn,bY as xr,ci as Pr,y as Er,O as Wt,m0 as Mr,m1 as Fn,cO as Nn,aH as Gn,au as Zn,dR as wt,aI as Yn,eI as $r,aE as Ii,m2 as $i,af as br,ag as Cr,m3 as Tr,m4 as Or,iJ as Rr,m5 as qn,kR as Lr,kS as Ar,m6 as Hr,m7 as Dr,m8 as lt,kx as zr,kE as Vr,aF as dn}from"./index.f2e9cdcf.js";import{n as ti,c as Ee,b as Ir,d as kr,a as Fr}from"./LineVisualElement.9133d51b.js";import{t as $,r as Nr,u as Gr}from"./LengthDimension.3df95a04.js";import{a as Zr,v as Un,l as De,f as ct,c as Yr,u as jn,d as q,g as qr,b as Ur}from"./Segment.54e1279f.js";import{U as jr,i as Xn,x as Wn,R as Xr,T as Wr,d as Tt,D as ki,w as Fi,z as Br,G as bi,v as hn,a as Jr,s as Kr,m as Qr,c as eo}from"./analysisViewUtils.832e6f12.js";import{B as to,C as Bn,z as Ni,o as io}from"./Factory.0b13bc82.js";import{d as no,S as un}from"./PointVisualElement.93f2b248.js";import{S as so}from"./RightAngleQuadVisualElement.6ef9250b.js";import{x as ro,h as Jn,E as O,g as oo}from"./elevationInfoUtils.6c1a0147.js";import{y as ao,p as lo}from"./colorUtils.bb6424b7.js";import{p as co}from"./ImageMaterial.cd48947d.js";import{b as I,L as mi,m as ho,V as uo,g as po,w as fo}from"./EditGeometryOperations.8d8d841c.js";import{q as pn}from"./QueryEngineResult.ddb48b00.js";import{i as mo}from"./dehydratedFeatureComparison.e2438592.js";import{r as go}from"./RenderTexture.b346685b.js";function _o(i){const e=zs(i),t=e===Is?ks:e;return Vs(i,t)?t:i}var Be;function yo(i,e){const{spatialReference:t}=i;return Fs(t,e.spatialReference)?(Dt[0]=i.x,Dt[1]=i.y,Dt[2]=i.hasZ?i.z:0,zt[0]=e.x,zt[1]=e.y,zt[2]=e.hasZ?e.z:0,Kn(Dt,zt,t)):null}function Kn(i,e,t){const n=vo(i,e,t,Be.Direct);return m(n)?Zr(n.direct,n.unit):null}function vo(i,e,t,n){const s=_o(t),r=Ns(s);if(y(r))return null;const o=e[2]-i[2];if(n===Be.Vertical)return{verticalSigned:o,unit:r};if(!hi(i,t,gi,s)||!hi(e,t,Vt,s))return null;if(n===Be.Direct)return{direct:qt(Vt,gi),unit:r};if(se(It,i[0],i[1],e[2]),!hi(It,t,It,s))return null;const a=qt(It,Vt);return n===Be.Horizontal?{horizontal:a,unit:r}:{direct:qt(Vt,gi),horizontal:a,vertical:Math.abs(o),unit:r}}(function(i){i[i.Direct=0]="Direct",i[i.Horizontal=1]="Horizontal",i[i.Vertical=2]="Vertical"})(Be||(Be={}));const Dt=v(),zt=v(),gi=v(),Vt=v(),It=v();function So(i,e,t){if(y(i))return null;const n=i.dimensionSegment.startRenderSpace,s=i.dimensionSegment.endRenderSpace,r=Kn(n,s,i.spatialReference);if(y(r))return null;const o=e===$.Vertical?Gs(r.value,r.unit,t):Zs(r.value,r.unit,t);return Un(r,o)}function Bt(i){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,dimension:{offset:n,measureType:s,orientation:r}}=i;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:n,measureType:s,orientation:r}}function Jt({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e,offset:t,measureType:n,orientation:s},r,o=null){if(y(i)||y(e))return null;const a=es(m(o)?o.directSegment:new De,{elevationAlignedStartPoint:i,elevationAlignedEndPoint:e},r),l=m(o)?o.primaryOffsetAxis:v();ii(l,{measureType:n,elevationAlignedStartPoint:i,elevationAlignedEndPoint:e,directSegment:a,orientation:s,renderCoordsHelper:r});const c=m(o)?o.dimensionSegment:new De;return Gi({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e})&&n===$.Vertical?(V(c.startRenderSpace,a.startRenderSpace),V(c.endRenderSpace,a.endRenderSpace)):ts(c,{offsetAxis:l,offset:t,relativeToSegment:a,renderCoordsHelper:r}),{directSegment:a,dimensionSegment:c,primaryOffsetAxis:l,spatialReference:r.spatialReference}}function fn(i,e,t,n){return e===xt.Start?(V(i.startRenderSpace,t.startRenderSpace),V(i.endRenderSpace,n.startRenderSpace)):(V(i.startRenderSpace,t.endRenderSpace),V(i.endRenderSpace,n.endRenderSpace)),i}var xt;function wo(i,e,t,n){de(i.startRenderSpace,e.startRenderSpace,t,n),de(i.endRenderSpace,e.endRenderSpace,t,n)}function Qn(i,e,t,n){switch(e){case $.Direct:return es(i,t,n);case $.Horizontal:case $.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:o,geometry:a}=t;let l;o.measureType===$.Direct?(l=xo(a,n)===s.z>r.z,e===$.Horizontal&&(l=!l)):l=!Po(a);const[c,d]=l?[s,r]:[r,s],u=Xe(d,Eo);return e===$.Horizontal?u.z=c.z:(u.x=c.x,u.y=c.y),n.toRenderCoords(c,i.startRenderSpace),n.toRenderCoords(u,i.endRenderSpace),i}}}function es(i,e,t){return t.toRenderCoords(e.elevationAlignedStartPoint,i.startRenderSpace),t.toRenderCoords(e.elevationAlignedEndPoint,i.endRenderSpace),i}function xo(i,e){const t=i.directSegment.eval(.5,M.get()),n=e.worldUpAtPosition(t,M.get()),s=i.dimensionSegment.eval(.5,M.get()),r=C(M.get(),s,t);return!On(r,Qe)&&D(r,n)>0}function Po(i){const{startRenderSpace:e,endRenderSpace:t}=i.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=i.directSegment;return sn(n,e)<sn(s,t)}(function(i){i[i.Start=0]="Start",i[i.End=1]="End"})(xt||(xt={}));const Eo=qs(0,0,0,null);function Mo(i,e,t,n){const{directSegment:s}=t,r=ii(M.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),o=ts($o,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,M.get()),a=C(M.get(),i,o);return D(a,r)*n.unitInMeters}const $o=new De;function ii(i,e){const{measureType:t,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:o},directSegment:a,renderCoordsHelper:l}=e,c=a.eval(.5,M.get()),d=l.worldUpAtPosition(c,M.get()),u=l.worldBasisAtPosition(c,Ys.Y,M.get());switch(t){case $.Horizontal:V(i,d);break;case $.Vertical:D(r,d)<D(o,d)?C(i,o,r):C(i,r,o),te(i,i,d),te(i,i,d);break;case $.Direct:{const f=Ke(e.orientation,0);if(Gi({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))en(kt,-tn(f),d),nn(i,u,kt);else{const g=C(M.get(),o,r),_=te(M.get(),g,d);te(_,_,g),en(kt,tn(f),g),nn(i,_,kt)}break}}return On(i,Qe)?V(i,u):Rn(i,i)}const kt=Di();function Gi({elevationAlignedStartPoint:i,elevationAlignedEndPoint:e}){return m(i)&&m(e)&&i.x===e.x&&i.y===e.y}function ts(i,e){const{offsetAxis:t,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:o,renderCoordsHelper:a}=e,l=n/a.unitInMeters,[c,d]=bo(s,r,t,l);return de(i.startRenderSpace,o.startRenderSpace,t,c),de(i.endRenderSpace,o.endRenderSpace,t,d),i}function bo(i,e,t,n=0){const s=D(e,t),r=D(i,t),o=Math.abs(s-r)+n;return s>r?[o,n]:[n,o]}function ni(i,e,t){const n=e.directSegment.eval(.5,M.get());return t.worldUpAtPosition(n,i)}function Zi(i,e){const{startRenderSpace:t,endRenderSpace:n}=e.directSegment;return C(i,n,t)}function Yi(i,e,t={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return t.invert?C(i,n,s):C(i,s,n)}function Ci(i,e){const t=i.directSegment.eval(.5,M.get());return e.headingAtPosition(t,i.primaryOffsetAxis)}function Co(i,e){return wi(Yi(To,i))/e**2}const To=v();function is(i){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=i;if(y(e)||y(t))return!1;const n=yo(e,t);return m(n)&&Un(n,"meters").value>ns}const ns=1e5;function Pt(i){return m(i.geometry)}let Me=class extends ye{constructor(i){super(i),this._handles=new st}initialize(){const{computations:i}=this.analysisViewData;for(const e of i)this._addComputation(e);this.addHandles(i.on("change",({added:e,removed:t})=>{for(const n of t)this._removeComputation(n);for(const n of e)this._addComputation(n)}))}destroy(){this._handles=gt(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Us(this.view)}_addComputation(i){this._handles.has(i)||this._handles.add(E(()=>Bt(i),e=>{const{measureType:t}=e;if(is(e)&&t!==$.Direct){const s=Math.round(js(ns,"meters","kilometers"));return Ln.getLogger(this.declaredClass).warnOnce(`A ${t} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(i.geometry=null)}const n=Jt(e,this.view.renderCoordsHelper,i.geometry);i.geometry=n,i.result.length=So(n,t,this._defaultUnit)},Y),i)}_removeComputation(i){this._handles.remove(i)}};h([p({constructOnly:!0})],Me.prototype,"analysisViewData",void 0),h([p({constructOnly:!0})],Me.prototype,"view",void 0),h([p()],Me.prototype,"analysis",null),h([p()],Me.prototype,"_defaultUnit",null),Me=h([N("esri.views.3d.analysis.Dimension.support.DimensionController")],Me);const ss={main:new R([255,127,0])};class Oo{constructor(){this.color=ss.main,this.opacity=.5,this.radius=5}}class Ro{constructor(){this.color=new R([127,127,127]),this.opacity=.5,this.radius=5}}class Lo{constructor(){this.lineSizeFraction=.8}}class Ao{constructor(){this.color=ss.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}}class Ho{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}class Do{constructor(){this.lineSizeFraction=.25}}class zo{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}}class Vo{constructor(){this.color=new R([255,127,0,.5])}}class Io{constructor(){this.pointManipulators=new Oo,this.offsetManipulator=new Ao,this.orientationManipulator=new Ho,this.markers=new Lo,this.labels=new zo,this.offsetLine=new Do,this.constraint=new Vo,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new Ro,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}}const T=new Io;class ko{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of Nr)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case $.Direct:return this.direct;case $.Horizontal:return this.horizontal;case $.Vertical:return this.vertical}}}function Fo(i,e){const t=jr(i,R.toUnitRGB(T.pointManipulators.color),T.pointManipulators.opacity,fe);return t.available=!1,t.grabCursor="crosshair",t.radius=T.pointManipulators.radius,t.metadata=e.metadata,t.collisionPriority=1,t}function No(i,e){const t=[B(-.5,0,0),B(.5,0,0)],{lengthFraction:n}=T.offsetManipulator,s=et(t.map(r=>$t(v(),r,n)));return new Xn({view:i,renderObjects:[{geometry:s,material:e.unfocusedMaterial,stateMask:pt.Unfocused|pt.Selected|fe},{geometry:s,material:e.focusedMaterial,stateMask:pt.Focused|fe}],collisionType:{type:"line",paths:[t]},radius:qi(e.lineSizePt)/2,metadata:e.metadata,available:!1,...Wn})}function rs(i,{lineSizePt:e,material:t}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:r,discScale:o,focusMultiplier:a}=T.orientationManipulator;return{calloutLength:.25*Bs*T.markers.lineSizeFraction*ce(e)+n,calloutOpacity:s,calloutWidth:r,customStateMask:fe,discScale:o,focusMultiplier:a,material:t,metadata:i}}function mn(i,e){return Xr(i,rs(e.metadata,e))}function gn(i,e){Wr(i,rs(i.metadata,e))}function Go(i,e){const t=[B(-.5,0,0),B(.5,0,0)],{lengthFraction:n}=T.offsetManipulator,s=et(t),r=et(t.map(o=>$t(v(),o,n)));return new Xn({view:i,renderObjects:[{geometry:r,material:e.unfocusedMaterial,stateMask:pt.Unfocused|fe},{geometry:r,material:e.focusedMaterial,stateMask:pt.Focused|fe},{geometry:s,material:e.thinOffsetManipulatorMaterial,stateMask:fe}],collisionType:{type:"line",paths:[t]},radius:qi(e.lineSizePt)/2,available:!1,metadata:e.metadata,...Wn})}function Zo(i,{isStart:e,createSnappingPipelineStep:t,dimension:n,onUpdate:s,snappingPipeline:r,view:o}){const a=e?"startPoint":"endPoint";return[Tt(i,(c,d,u,f)=>{const g=Ni(c);u=u.next(g).next(Fi(n,[a,"measureType","orientation"])),d.next(g).next(to(o)).next(t(u,f),r.next).next(_=>{const S=Xe(_.mapEnd,new ft);s(a==="startPoint"?{startPoint:S}:{endPoint:S})})})]}function Yo(i,{computation:e,view:t}){return[Tt(i,(n,s,r)=>{if(!Pt(e)||!n.selected)return;const{geometry:o,dimension:a}=e,l=Ni(n);s.next(l).next(as(t,a,o.dimensionSegment,o.primaryOffsetAxis)),r.next(l).next(Fi(a,["offset"]))})]}function qo(i,{computation:e,view:t}){return[Tt(i,(n,s,r)=>{os({cancel:r,computation:e,settingHeading:!0,steps:s,view:t})})]}function Uo(i,{computation:e,view:t}){return[Tt(i,(n,s,r)=>{os({cancel:r,computation:e,settingHeading:!1,steps:s,view:t})}),i.events.on("immediate-click",n=>{jo(n,e,t)})]}function jo(i,e,t){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void i.stopPropagation();if(y(s))return;const{renderCoordsHelper:r}=t,o=Jt({...Bt(e),orientation:90},r),a=Jt({...Bt(e),orientation:270},r);if(y(o)||y(a))return;const l=Ci(o,r),c=Ci(a,r),d=ls(s,t),u=xi.shortestSignedDiff(d,l),f=xi.shortestSignedDiff(d,c);n.orientation=Math.abs(u)<Math.abs(f)?90:270,i.stopPropagation()}function os(i){const{cancel:e,computation:t,settingHeading:n,steps:s,view:r}=i;if(!Pt(t))return;const{renderCoordsHelper:o}=r,{dimension:a,geometry:l}=t,c=v(),d=ds(v(),l,l.directSegment,o),u=hs(M.get(),{forHeading:n,geometry:l,renderCoordsHelper:o}),f=Pi(d,u,Ei()),g=Ke(a.orientation,n?()=>Ci(l,r.renderCoordsHelper):0);s.next(Bn(r,f)).next(_=>{_.action==="start"&&V(c,_.renderStart);const S=Js(f),x=Br(c,_.renderEnd,d,S);let H=g-Ks(x);n||(H=Xo(H)),a.orientation=H}),e.next(Fi(a,["orientation"]))}function Xo(i){const e=xi.normalize(i)%90;return e<T.orientationSnapThresholdDegrees?i-e:90-e<T.orientationSnapThresholdDegrees?i+(90-e):i}function Wo(i,{computation:e,manipulatorMeasureType:t,view:n}){let s=$.Direct,r=0,o=0;return[i.events.on("grab-changed",a=>{if(a.action!=="start"||!Pt(e))return;const{dimension:l,geometry:c}=e;s=l.measureType,r=l.offset,o=l.orientation;const d=V(M.get(),i.renderLocation);l.measureType=t,l.offset=Mo(d,t,c,n.renderCoordsHelper),l.orientation=0}),Tt(i,(a,l,c)=>{if(!Pt(e))return;const{geometry:d,dimension:u}=e,{renderCoordsHelper:f}=n,g=Qn(us,t,e,f),_=ii(M.get(),{measureType:t,directSegment:d.directSegment,renderCoordsHelper:f}),S=Ni(a);l.next(S).next(as(n,u,g,_)),c.next(S).next(x=>(u.measureType=s,u.offset=r,u.orientation=o,x))})]}function as(i,e,t,n){const s=rt(M.get(),t.endRenderSpace,t.startRenderSpace);te(s,s,n);const r=Pi(t.startRenderSpace,s,Ei()),o=Pi(t.startRenderSpace,n,Ei()),a=e.offset;let l,c=0;const d=new bi;return d.next(Bn(i,r)).next(u=>{u.action==="start"&&(c=rn(o,u.renderStart));const f=(rn(o,u.renderEnd)-c)*i.renderCoordsHelper.unitInMeters;e.offset=a+f,l=u}),u=>(d.execute(u),l)}function ls(i,e){const{directSegment:t}=i,{renderCoordsHelper:n}=e,s=ni(M.get(),i,n),r=Zi(M.get(),i),o=te(M.get(),r,s),{viewForward:a}=e.state.camera;D(o,a)>0&&$t(o,o,-1);const l=t.eval(.5,M.get());return n.headingAtPosition(l,o)}function Bo(i,e,t){const{dimensionSegment:n,primaryOffsetAxis:s}=e,r=Yi(mt,e),o=tt(r,Qe)?Ws(Kt):ki(r,s,Qe,Kt),a=Math.max(zi(r),T.offsetManipulator.minLengthMeters/t.unitInMeters);An(o,o,se(mt,a,a,a)),i.modelTransform=o,i.renderLocation=n.eval(.5,mt)}function Jo(i,e,t){cs(i,e,t,{forHeading:!0})}function Ko(i,e,t){cs(i,e,t,{forHeading:!1})}function cs(i,e,t,{forHeading:n}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:o}=r,a=$t(Qo,o,s.offset>=0?1:-1),l=hs(ea,{forHeading:n,geometry:r,renderCoordsHelper:t});te(l,l,a);const c=ki(a,l,Qe,Kt);i.modelTransform=c,i.renderLocation=ds(mt,r,r.dimensionSegment,t)}const Qo=v(),ea=v();function ta(i,e,t,n){const{geometry:s}=e,r=Qn(us,t,e,n),o=ii(mt,{measureType:t,directSegment:s.directSegment,renderCoordsHelper:n}),a=C(_i,r.endRenderSpace,r.startRenderSpace),l=ki(a,o,Qe,Kt),c=zi(a);An(l,l,se(_i,c,c,c)),i.modelTransform=l,i.renderLocation=r.eval(.5,_i)}function ds(i,e,t,n){const{startRenderSpace:s,endRenderSpace:r}=t,o=ia(e,n)?s:r;return V(i,o)}function hs(i,{forHeading:e,geometry:t,renderCoordsHelper:n}){return e?ni(i,t,n):Yi(i,t,{invert:!0})}function ia(i,e){const t=Zi(na,i),n=ni(sa,i,e);return D(t,n)>0}const na=v(),sa=v();function ra(i){return ce(i)+T.offsetManipulator.linePaddingPx}function qi(i){return ce(i)+T.offsetManipulator.focusedLinePaddingPx}const fe=Xs.Custom1,mt=v(),_i=v(),Kt=Di(),us=new De;var K;function Ft(i,e){if(is(i))return K.Direct;const{geometry:t}=i;if(y(t)||tt(t.directSegment.startRenderSpace,t.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=T,{camera:s}=e.state,r=ni(M.get(),t,e.renderCoordsHelper),o=Zi(M.get(),t),a=$t(M.get(),r,D(o,r)),l=rt(M.get(),o,a),c=wi(l),d=wi(a),{startRenderSpace:u,endRenderSpace:f}=t.directSegment,g=Math.max(s.computeRenderPixelSizeAt(u)*n,s.computeRenderPixelSizeAt(f)*n)**2;return c<g?K.Vertical:d<g?K.Horizontal:null}function oa(i,e,t){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:o,view:a}=t,{dimension:l,previousConstraint:c,preConstraintProperties:d}=i;if(y(s)||y(r))return;const u=()=>{"startPoint"in e?l.startPoint=e.startPoint:"endPoint"in e&&(l.endPoint=e.endPoint)};if(y(n))u(),m(c)&&m(d)&&(l.measureType=d.measureType,l.orientation=d.orientation);else switch(l.measureType=$.Direct,n){case K.Horizontal:if(n!==c&&(l.orientation=0),"startPoint"in e){const f=e.startPoint;m(f)&&(f.z=r.z),l.startPoint=f}else if("endPoint"in e){const f=e.endPoint;m(f)&&(f.z=s.z),l.endPoint=f}break;case K.Vertical:if(n!==c&&(l.orientation=ls(o,a)),"startPoint"in e){const f=e.startPoint;m(f)&&(f.x=r.x,f.y=r.y),l.startPoint=f}else if("endPoint"in e){const f=e.endPoint;m(f)&&(f.x=s.x,f.y=s.y),l.endPoint=f}break;case K.Direct:n!==c&&m(d)&&(l.orientation=d.orientation),u()}i.previousConstraint=n}(function(i){i[i.Horizontal=0]="Horizontal",i[i.Vertical=1]="Vertical",i[i.Direct=2]="Direct"})(K||(K={}));class aa extends ti{constructor(e){super(e),this._ray=tr(),this._externalResources=null,this._handles=new st,this._isWorldDown=!1,this._start=v(),this._end=B(1,0,0),this._width=1,this._color=jt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=jt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=W.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=b.OccludeAndTransparent,this._fadedExtensions=vn,this.applyProps(e)}createExternalResources(){const e=new Re(this.materialParameters);this._handles.add(E(()=>this.view.state.camera,()=>{this._updateGeometry()}));const t=new no({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){m(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){m(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[v(),v()],n=this.extensionType===W.FADED;n&&t.push(v(),v());const s=n?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,r=et(t,null,s);e.addGeometry(r,re(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),m(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,V(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),rt(this._end,e,this._end),ui(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,tt(this._start,e)||(V(this._start,e),ui(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,tt(this._end,e)||(V(this._end,e),ui(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){We(e,this._color)||(_t(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){We(e,this._innerColor)||(_t(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=m(e)!==m(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(y(e)||y(this._stippleOffColor)||!We(e,this._stippleOffColor))&&(this._stippleOffColor=m(e)?Hn(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&m(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,m(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,m(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,m(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=Ke(e,vn),this.recreateGeometry()}_updateMaterial(){y(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){m(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const t=this._extensionType===W.FADED?this._updateLineSegmentFinite(_n):this._updateLineSegmentInfinite(this._extensionType,_n);this._updateVertexAttributes(e,t),m(this._externalResources)&&(this._externalResources.laserline.intersectsLine=t)}_updateLineSegmentFinite(e){return pi(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const n=this.view.state.camera;switch(ir(this._ray,ve),e){case W.LINE:ve.c0=-Number.MAX_VALUE;break;case W.RAY:case W.GROUND_RAY:{const o=this._ray.origin,a=Ke(this.view.elevationProvider.getElevation(o[0],o[1],o[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),l=this.view.renderCoordsHelper.getAltitude(o);this._isWorldDown&&l<a&&nr(ve.ray.direction,ve.ray.direction),this._extensionType===W.GROUND_RAY&&a!=null&&(ve.c1=Math.abs(l-a));break}}if(!sr(n.frustum,ve))return pi(this._start,this._end,t);const s=rr(ve,Pe),r=or(ve,la);return pi(s,r,t)}_updateVertexAttributes(e,t){const n=e.geometries[0].getMutableAttribute(Dn.POSITION).data;if(this.extensionType===W.FADED){const s=ke(t,-this.fadedExtensions.start,Pe);n[0]=s[0],n[1]=s[1],n[2]=s[2];const r=ke(t,0,Pe);n[3]=r[0],n[4]=r[1],n[5]=r[2];const o=ke(t,1,Pe);n[6]=o[0],n[7]=o[1],n[8]=o[2];const a=ke(t,1+this.fadedExtensions.end,Pe);n[9]=a[0],n[10]=a[1],n[11]=a[2]}else{const s=ke(t,0,Pe);n[0]=s[0],n[1]=s[1],n[2]=s[2];const r=ke(t,1,Pe);n[3]=r[0],n[4]=r[1],n[5]=r[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const ve=Qs(),Pe=v(),la=v(),_n=er();var W;(function(i){i[i.LINE=0]="LINE",i[i.RAY=1]="RAY",i[i.GROUND_RAY=2]="GROUND_RAY",i[i.FADED=3]="FADED"})(W||(W={}));const yn=1/3,vn={start:yn,end:yn};class ca extends ti{constructor(e){super(e),this._handles=new st,this._location=v(),this._direction=B(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=jt(1,0,1,1),this._renderOccluded=b.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){tt(this._location,e)||(V(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){tt(this._direction,e)||(V(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){Rn(this._direction,rt(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){We(e,this._color)||(_t(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new Re(this.materialParameters);this._handles.add(E(()=>this.view.state.camera,()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=et([v(),v()]),n=et([v(),v()]),s=re(this._externalResources).material;e.addGeometry(t,s),e.addGeometry(n,s),this._updateVertices(e)}forEachExternalMaterial(e){m(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){y(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;y(e)||this._updateVertices(e)}_updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,Nt),zn(oe,this.location,this.direction),t.projectToScreen(oe,Fe),ar(Fe,he(Fe,Fe,Nt)),this._updateVertexAttributes(t,e,0,Nt,Fe,1),this._updateVertexAttributes(t,e,1,Nt,Fe,-1)}_updateVertexAttributes(e,t,n,s,r,o){const a=t.geometryRecords[n],l=a.geometry.getMutableAttribute(Dn.POSITION).data,c=fi(Sn,lr(Sn,r[1]*o,r[0]*-o),this.offset+this.width/2),d=At(Gt,At(Gt,At(Gt,s,fi(Gt,r,this.length/2)),c),c),u=At(wn,d,fi(wn,r,-this.length));e.unprojectFromScreen(d,oe),l[0]=oe[0],l[1]=oe[1],l[2]=oe[2],e.unprojectFromScreen(u,oe),l[3]=oe[0],l[4]=oe[1],l[5]=oe[2],t.geometryVertexAttrsUpdated(a)}}const oe=v(),Nt=bt(),Fe=bt(),Sn=bt(),Gt=bt(),wn=bt();let ie=class extends Vn{constructor(){super(...arguments),this.enabled=!0}};h([p({type:Boolean})],ie.prototype,"enabled",void 0),ie=h([N("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],ie);let L=class extends Vn{constructor(i){super(i),this.lineSnapper=new ie,this.parallelLineSnapper=new ie,this.rightAngleSnapper=new ie,this.rightAngleTriangleSnapper=new ie,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new R([255,127,0]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5}};h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],L.prototype,"lineSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],L.prototype,"parallelLineSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],L.prototype,"rightAngleSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],L.prototype,"rightAngleTriangleSnapper",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],L.prototype,"shortLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],L.prototype,"distance",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],L.prototype,"pointThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],L.prototype,"intersectionParallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],L.prototype,"parallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],L.prototype,"touchSensitivityMultiplier",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],L.prototype,"pointOnLineThreshold",void 0),h([p({type:R,nonNullable:!0})],L.prototype,"orange",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],L.prototype,"lineHintWidthReference",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],L.prototype,"lineHintWidthTarget",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],L.prototype,"lineHintFadedExtensions",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],L.prototype,"parallelLineHintWidth",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],L.prototype,"parallelLineHintLength",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],L.prototype,"parallelLineHintOffset",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],L.prototype,"rightAngleHintSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],L.prototype,"rightAngleHintOutlineSize",void 0),L=h([N("esri.views.interactive.snapping.Settings.Defaults")],L);const P=new L;var z;(function(i){i[i.FEATURE=1]="FEATURE",i[i.SELF=2]="SELF",i[i.ALL=3]="ALL"})(z||(z={}));function F(i,e){const t=i.length===e.length&&i[0]===e[0]&&i[1]===e[1];switch(i.length){case 2:return t;case 3:return t&&i[2]===e[2];case 4:return t&&i[2]===e[2]&&i[3]===e[3]}return!1}function Ve(i,e){const t=i.x-e.x,n=i.y-e.y;return t*t+n*n}function da(i,e){return Math.sqrt(Ve(i,e))}function Ui(i,e,t){const n=t.toXYZ(i,ha);e.sort((s,r)=>{const o=t.toXYZ(s.targetPoint,xn),a=yt(o,n),l=t.toXYZ(r.targetPoint,xn);return a-yt(l,n)})}const ha=v(),xn=v();var U;function Zl(i,e){return{point:i.coordinateHelper.vectorToPoint(i.point).toJSON(),distance:i.distance,types:i.types,query:m(e)?e.toJSON():{where:"1=1"}}}function A(i,e,t,n){const{coordinateHelper:s,elevationInfo:r}=t;if(!s.hasZ()||y(e)||e.type!=="3d"||y(i)||ro(r,n))return i;const o=Jn(e,i,s.spatialReference,r,n),a=s.clone(i);return a[2]=o,a}function le(i,e,t,n=O){return{left:A(i.leftVertex.pos,e,t,n),right:A(i.rightVertex.pos,e,t,n)}}function Yl(i){return i.createQuery()}(function(i){i[i.TARGET=0]="TARGET",i[i.REFERENCE=1]="REFERENCE",i[i.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(U||(U={}));class Ot{constructor(e,t){this.elevationInfo=e,this.domain=t}}class si extends Ot{constructor(e,t,n=z.ALL){super(t,n),this.intersectionPoint=e}equals(e){return e instanceof si&&F(this.intersectionPoint,e.intersectionPoint)}}class Q extends Ot{constructor(e,t,n,s,r=z.ALL,o=!0,a=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=n,this.fadeLeft=o,this.fadeRight=a}equals(e){return e instanceof Q&&this.type===e.type&&F(this.lineStart,e.lineStart)&&F(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}}class ri extends Ot{constructor(e,t,n,s=z.ALL){super(n,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof ri&&F(this.lineStart,e.lineStart)&&F(this.lineEnd,e.lineEnd)}}class ji extends Ot{constructor(e,t,n){super(t,n),this.point=e}equals(e){return e instanceof ji&&F(this.point,e.point)}}class Rt extends Ot{constructor(e,t,n,s,r=z.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=n}equals(e){return e instanceof Rt&&F(this.previousVertex,e.previousVertex)&&F(this.centerVertex,e.centerVertex)&&F(this.nextVertex,e.nextVertex)}}class ua{draw(e,t){const n=this._getUniqueHints(e),s=[];for(const r of n)r instanceof si&&s.push(this.visualizeIntersectionPoint(r,t)),r instanceof Q&&s.push(this.visualizeLine(r,t)),r instanceof ri&&s.push(this.visualizeParallelSign(r,t)),r instanceof Rt&&s.push(this.visualizeRightAngleQuad(r,t)),r instanceof ji&&s.push(this.visualizePoint(r,t));return cr(s)}_getUniqueHints(e){const t=[];for(const n of e){let s=!0;for(const r of t)if(n.equals(r)){s=!1;break}s&&t.push(n)}return t}}class pa extends ua{visualizeIntersectionPoint(e,t){const{coordinateHelper:n,view:s}=t;return Ze(new un({view:s,primitive:"circle",geometry:n.vectorToPoint(e.intersectionPoint),elevationInfo:Ke(e.elevationInfo,t.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:R.toUnitRGBA(P.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{view:n,coordinateHelper:s}=t,r=this._alignPoint(e.point,e.domain,t);return Ze(new un({view:n,primitive:"circle",geometry:s.vectorToPoint(r),elevationInfo:this._hintElevationInfo(e,t),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:R.toUnitRGBA(P.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{view:n,coordinateHelper:s}=t,r=this._alignPoint(e.lineStart,e.domain,t),o=this._alignPoint(e.lineEnd,e.domain,t);return Ze(this._createLineSegmentHintFromMap(e.type,r,o,s,this._hintElevationInfo(e,t),n,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:n,coordinateHelper:s}=t,r=this._hintElevationInfo(e,t),o=this._alignPoint(e.lineStart,e.domain,t),a=this._alignPoint(e.lineEnd,e.domain,t),l=ct(o,s,r,n),c=ct(a,s,r,n),d=dr(c,l,c,.5),u=new ca({view:n,attached:!1,offset:P.parallelLineHintOffset,length:P.parallelLineHintLength,width:P.parallelLineHintWidth,color:R.toUnitRGBA(P.orange),location:d,renderOccluded:b.Opaque});return u.setDirectionFromPoints(l,d),u.attached=!0,Ze(u)}visualizeRightAngleQuad(e,t){const{view:n,coordinateHelper:s}=t,r=this._hintElevationInfo(e,t),o=this._alignPoint(e.previousVertex,e.domain,t),a=this._alignPoint(e.centerVertex,e.domain,t),l=this._alignPoint(e.nextVertex,e.domain,t);return Ze(new so({view:n,attached:!0,color:R.toUnitRGBA(P.orange),renderOccluded:b.Transparent,outlineRenderOccluded:b.Opaque,outlineColor:R.toUnitRGBA(P.orange),outlineSize:P.rightAngleHintOutlineSize,size:P.rightAngleHintSize,geometry:{previous:ct(o,s,r,n),center:ct(a,s,r,n),next:ct(l,s,r,n)}}))}_createLineSegmentHintFromMap(e,t,n,s,r,o,a=!0,l=!0){const c=v(),d=v();return Yr(t,n,s,r,o,c,d),this._createLineSegmentHint(e,o,c,d,a,l)}_createLineSegmentHint(e,t,n,s,r=!0,o=!0){const a=new aa({view:t,extensionType:W.FADED,start:n,end:s,color:R.toUnitRGBA(P.orange),renderOccluded:b.Opaque});switch(e){case U.TARGET:a.width=P.lineHintWidthTarget,a.fadedExtensions={start:0,end:P.lineHintFadedExtensions};break;case U.REFERENCE_EXTENSION:a.width=P.lineHintWidthReference,a.fadedExtensions={start:0,end:0};break;case U.REFERENCE:a.width=P.lineHintWidthReference,a.fadedExtensions={start:r?P.lineHintFadedExtensions:0,end:o?P.lineHintFadedExtensions:0}}return a.attached=!0,a}_alignPoint(e,t,n){const s=this._getSelfSnappingZ(t,n);if(y(s))return e;const r=n.coordinateHelper,o=r.vectorToPoint(e,fa);return o.z=s,r.pointToVector(o)}_hintElevationInfo(e,t){return m(this._getSelfSnappingZ(e.domain,t))?re(t.selfSnappingZ).elevationInfo:Ke(e.elevationInfo,t.elevationInfo)}_getSelfSnappingZ(e,{selfSnappingZ:t}){return e===z.SELF&&m(t)?t.value:null}}const fa=new ft,w={main:new R([255,127,0]),selected:new R([255,255,255]),staged:new R([12,207,255]),outline:new R([0,0,0,.5]),selectedOutline:new R([255,255,255])},Je=.3;function Et(i,e){const t=i.clone();return t.a*=e,t}function ma(i,e){const t=i.clone(),n=ao(t);n.s*=e;const s=lo(n);return t.r=s.r,t.g=s.g,t.b=s.b,t}function ee(i,e){if(e)for(const t in e)i[t]=e[t]}class ga{constructor(e){this.color=w.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=b.Opaque,ee(this,e)}}class yi{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=w.main,this.outlineColor=w.outline,this.renderOccluded=b.Opaque,this.hoverOutlineColor=w.selectedOutline,ee(this,e)}apply(e,t){const n=this[e];t.setParameters({color:we(n),transparent:e!=="color"||n.a<1,renderOccluded:this.renderOccluded})}}class _a{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=Et(w.main,.5),this.hoverColor=w.main,this.renderOccluded=b.Transparent,this.minSquaredEdgeLength=900,ee(this,e)}apply(e,t){const n=this[e];t.setParameters({color:we(n),transparent:n.a<1,renderOccluded:this.renderOccluded})}}class ya{constructor(e){this.vertex=new yi({color:w.main,outlineColor:w.outline}),this.edge=new yi({color:ma(Et(w.main,2/3),.5),outlineColor:Et(w.outline,.5),size:8,collisionPadding:8}),this.selected=new yi({color:w.selected,outlineColor:w.outline}),this.edgeOffset=new _a,ee(this,e)}}class Ti{constructor(e){this.color=w.selected,this.width=1.5,this.stipplePattern=He(5),this.stippleOffColor=w.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=w.selected,this.renderOccluded=b.OccludeAndTransparent,ee(this,e)}apply(e){e.color=we(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=we(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=we(this.innerColor),e.renderOccluded=this.renderOccluded}}class va{constructor(e){this.color=w.selected,this.size=4,this.outlineSize=1,this.outlineColor=w.outline,this.shape="square",ee(this,e)}apply(e){e.color=we(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=we(this.outlineColor),e.primitive=this.shape}}class Qt{constructor(e){this.innerColor=w.selected,this.innerWidth=1,this.glowColor=w.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=Je,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=w.main,ee(this,e)}apply(e,t=1){const n={glowColor:R.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:R.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=n:e.laserlineStyle=n}}class Sa{constructor(e){this.outline=new Ti({color:w.outline,renderOccluded:b.OccludeAndTransparentStencil,stippleOffColor:w.selected,stipplePattern:He(5),width:1.5,innerWidth:0}),this.staged=new Ti({color:w.selected,renderOccluded:b.OccludeAndTransparentStencil,innerColor:w.staged,stippleOffColor:w.outline,stipplePattern:He(5),width:1.5}),this.shadowStyle=new Qt({globalAlpha:Je,glowColor:w.main,glowFalloff:8,glowWidth:8,innerColor:w.selected,innerWidth:1}),ee(this,e)}}class wa{constructor(e){this.outline=new va({color:w.selected,outlineColor:w.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Qt({globalAlpha:Je,glowColor:w.main,glowFalloff:1.5,glowWidth:6,innerColor:w.selected,innerWidth:1,radius:2}),ee(this,e)}}class xa extends Ti{constructor(e){super(),this.extensionType=W.GROUND_RAY,ee(this,e)}}class Pa{constructor(e){this.lineGraphics=new Sa,this.pointGraphics=new wa,this.heightPlane=new Qt({globalAlpha:Je,glowColor:w.main,glowFalloff:8,glowWidth:8,innerColor:w.selected,innerWidth:1}),this.heightBox=new Qt({globalAlpha:Je,glowColor:w.main,glowFalloff:8,glowWidth:8,innerColor:w.selected,innerWidth:0,heightFillColor:w.main}),this.zVerticalLine=new xa({color:Et(w.main,5*Je/3),falloff:2,innerColor:Et(w.selected,0),renderOccluded:b.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:W.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,ee(this,e)}}class Ea{constructor(e){this.visualElements=new Pa,this.reshapeManipulators=new ya,this.zManipulator=new ga,ee(this,e)}colorToVec4(e){return we(e)}}function we(i){return hr(R.toUnitRGBA(i))}const Ne=new Ea;function Ma(i,e,t,n,s){const r=new Float64Array(3*i.length),o=new Float64Array(r.length);i.forEach((c,d)=>{r[3*d+0]=c[0],r[3*d+1]=c[1],r[3*d+2]=c.length>2?c[2]:0});const a=ur(r,e,0,o,0,r,0,r.length/3,t,n,s),l=a!=null;return{numVertices:i.length,position:r,mapPosition:o,projectionSuccess:l,sampledElevation:a}}class $a extends ti{constructor(e){super(e),this.view=null,this._renderOccluded=b.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Ne.colorToVec4(Ne.reshapeManipulators.vertex.color),this._size=Ne.reshapeManipulators.vertex.size,this._outlineColor=Ne.colorToVec4(Ne.reshapeManipulators.vertex.outlineColor),this._outlineSize=Ne.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){We(e,this._color)||(_t(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){We(e,this._outlineColor)||(_t(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(y(e)||e.length===0)return[];const t=.5,n=.5,s=Ma(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,pr.fromElevationInfo(this.elevationInfo)),r=[],o=s.numVertices,a=s.position;for(let l=0;l<o;++l){const c=se(ba,a[3*l+0],a[3*l+1],a[3*l+2]),d=Pn(t,c),u=Pn(n,c);r.push({vertexGeometry:d,vertexOutlineGeometry:u})}return r}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:n,vertexOutlineGeometry:s}of t)e.addGeometry(n,this._vertexMaterial),e.addGeometry(s,this._vertexOutlineMaterial)}createExternalResources(){this._vertexMaterial=new hn({...this._vertexMaterialParameters,writeDepth:!0,cullFace:on.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new hn({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:on.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}}const ba=v();function Pn(i,e){return fr(i,16,16,{offset:e})}let $e=class extends ye{constructor(i){super(i),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};h([p({constructOnly:!0})],$e.prototype,"layer",void 0),h([p()],$e.prototype,"enabled",void 0),h([p()],$e.prototype,"updating",void 0),h([p()],$e.prototype,"availability",void 0),$e=h([N("esri.views.interactive.snapping.FeatureSnappingLayerSource")],$e);const ps=$e;let j=class extends ye{constructor(i){super(i),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new ot,this.distance=P.distance,this.touchSensitivityMultiplier=P.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};h([p()],j.prototype,"enabled",void 0),h([p()],j.prototype,"enabledToggled",void 0),h([p()],j.prototype,"selfEnabled",void 0),h([p()],j.prototype,"featureEnabled",void 0),h([p({type:ot.ofType(ps)})],j.prototype,"featureSources",void 0),h([p()],j.prototype,"distance",void 0),h([p()],j.prototype,"touchSensitivityMultiplier",void 0),h([p({readOnly:!0})],j.prototype,"effectiveEnabled",null),h([p({readOnly:!0})],j.prototype,"effectiveSelfEnabled",null),h([p({readOnly:!0})],j.prototype,"effectiveFeatureEnabled",null),j=h([N("esri.views.interactive.snapping.SnappingOptions")],j);const fs=j;function Ca(i,e){var n,s;const t=new fs({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(n=e==null?void 0:e.distance)!=null?n:P.distance,touchSensitivityMultiplier:(s=e==null?void 0:e.touchSensitivityMultiplier)!=null?s:P.touchSensitivityMultiplier});return{...E(()=>{var r,o,a;return(a=(o=(r=i.map)==null?void 0:r.allLayers)==null?void 0:o.toArray())!=null?a:[]},r=>{t.featureSources=new ot(r.map(o=>new ps({layer:o,enabled:!0})))},Xt),options:t}}function Oi({start:i,end:e,type:t},n,s){const r=[],o=n,a=he(me,e,i),l=he(ge,i,o),c=vt(a),d=2*Ct(a,l),u=d*d-4*c*(vt(l)-s*s);if(u===0){const f=-d/(2*c);(t===ne.PLANE||f>=0)&&r.push(Le(B(0,0,n[2]),i,a,f))}else if(u>0){const f=Math.sqrt(u),g=(-d+f)/(2*c);(t===ne.PLANE||g>=0)&&r.push(Le(B(0,0,n[2]),i,a,g));const _=(-d-f)/(2*c);(t===ne.PLANE||_>=0)&&r.push(Le(B(0,0,n[2]),i,a,_))}return r}function Ri(i,e){const t=i.start,n=i.end,s=he(me,n,t),r=se(ge,-s[1],s[0],0),o=e.start,a=e.end,l=C(Lt,a,o),c=D(l,r),d=se(vs,t[0],t[1],0),u=C(Ss,d,o),f=D(u,r);if(Math.abs(c)<k)return[];const g=de(ws,o,l,f/c);if(e.type===I.RAY){const _=C(ei,g,o);if(D(_,l)<-k)return[]}if(i.type===ne.HALF_PLANE){const _=mr(ei,g,t);if(Ct(_,s)<-k)return[]}return[St(g)]}function Li(i,e){return Ai(Mt(oi,e[2],i),e)}function ms(i,e){const n=ys(Mt(oi,0,i),Mt(La,0,e)),s=[];for(const r of n)s.push(gr(r));return s}function gs(i,e){return Xi(i,Mt(oi,i[2],e))}function Ta(i,e){return _s(Mt(oi,i[2],e),i)}function Oa(i,e,t){const n=se(me,i[0],i[1],e[2]),s=rt(ge,n,e),r=t/zi(s);return de(v(),e,s,r)}function Xi(i,{start:e,end:t,type:n}){const s=C(me,i,e),r=C(ge,t,e),o=D(s,r)/D(r,r);return de(v(),e,r,n===I.RAY?Math.max(o,0):o)}function _s({start:i,end:e,type:t},n){const s=C(me,n,i),r=C(ge,e,i);if(t===I.RAY&&D(r,s)<-k)return qt(i,n);const o=te(Lt,r,s);return an(o)/an(r)}function En({start:i,end:e,type:t},n,s){const r=[];if(Ae(i[2],n[2],k)&&Ae(e[2],n[2],k)){const o=i,a=n,l=he(me,e,o),c=he(ge,o,a),d=vt(l),u=2*Ct(l,c),f=u*u-4*d*(vt(c)-s*s);if(f===0){const g=-u/(2*d);(t===I.LINE||g>=0)&&r.push(Le(B(0,0,n[2]),o,l,g))}else if(f>0){const g=Math.sqrt(f),_=(-u+g)/(2*d);(t===I.LINE||_>=0)&&r.push(Le(B(0,0,n[2]),o,l,_));const S=(-u-g)/(2*d);(t===I.LINE||S>=0)&&r.push(Le(B(0,0,n[2]),o,l,S))}}else{const o=C(me,e,i);if(Ae(o[2],0,k))return r;const a=(n[2]-i[2])/o[2],l=de(ge,i,o,a);if(t===I.RAY){const c=C(Lt,l,i);if(D(o,c)<-k)return r}for(const c of Hi(n,s,l))r.push(c)}return r}function ys(i,e){const t=i.start,n=i.end,s=e.start,r=e.end,o=C(me,n,t),a=C(ge,r,s),l=C(Lt,s,t),c=te(vs,o,a),d=D(l,c);if(!Ae(d,0,k))return[];const u=Mi(c);if(Ae(u,0,k))return[];const f=te(Ss,l,a),g=D(f,c)/u,_=de(ws,t,o,g);if(i.type===I.RAY){const S=C(ei,_,t);if(D(o,S)<-k)return[]}if(e.type===I.RAY){const S=C(ei,_,s);if(D(a,S)<-k)return[]}return[St(_)]}function Ai({start:i,end:e,type:t},n){const s=C(me,n,i),r=C(ge,e,i),o=te(Lt,r,s);if(Mi(o)/Mi(r)<k)switch(t){case I.LINE:return[St(n)];case I.RAY:return D(r,s)<-k?[]:[St(n)]}return[]}function Hi(i,e,t){return Ae(i[2],t[2],k)&&Ae(yt(t,i),e*e,k)?[St(t)]:[]}function Mt(i,e,{start:t,end:n,type:s}){return se(i.start,t[0],t[1],e),se(i.end,n[0],n[1],e),i.type=Ra[s],i}var ne;(function(i){i[i.PLANE=0]="PLANE",i[i.HALF_PLANE=1]="HALF_PLANE"})(ne||(ne={}));const Ra={[ne.PLANE]:I.LINE,[ne.HALF_PLANE]:I.RAY},k=1e-6,me=v(),ge=v(),Lt=v(),vs=v(),Ss=v(),ws=v(),ei=v(),oi={start:v(),end:v(),type:I.LINE},La={start:v(),end:v(),type:I.LINE};class Ie{constructor(e){this.coordinateHelper=e}intersect(e){return za(this,e)}}class Aa extends Ie{constructor(e,t){super(e),this.point=t,this.pointXYZ=e.toXYZ(t)}equals(e){return qe(e)&&F(this.point,e.point)}check(e){const t=this.coordinateHelper.toXYZ(e,_e);return yt(t,this.pointXYZ)<P.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}}class xs extends Ie{constructor(e,t,n,s){super(e),this.start=t,this.end=n,this.type=s,this.startXYZ=e.toXYZ(t),this.endXYZ=e.toXYZ(n),this.lineLike={start:this.startXYZ,end:this.endXYZ,type:this.type}}equals(e){return Ce(e)&&this.type===e.type&&F(this.start,e.start)&&F(this.end,e.end)}check(e){const t=this.coordinateHelper.toXYZ(e,_e);return _s(this.lineLike,t)<P.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper,n=t.toXYZ(e,_e),s=Xi(n,this.lineLike);return t.fromXYZ(s)}}class Ha extends xs{constructor(e,t,n){super(e,t,n,I.LINE)}}class ai extends Ie{constructor(e,t,n,s){super(e),this.intersection=t,this.first=n,this.second=s}equals(e){return e instanceof ai&&this.first.equals(e.first)&&this.second.equals(e.second)}check(){return!1}closestTo(){return this.coordinateHelper.clone(this.intersection)}}class Wi extends Ie{constructor(e,t,n,s){super(e),this.basePoint=t,this.first=n,this.second=s}equals(e){return e instanceof Wi&&this.first.equals(e.first)&&this.second.equals(e.second)}check(){return!1}closestTo(e){const t=this.basePoint,n=this.coordinateHelper,s=n.toXYZ(e,_e),r=se(Ia,t[0],t[1],s[2]);return n.fromXYZ(r)}}class Ps extends Ie{constructor(e,t,n){super(e),this.center=t,this.radius=n,this.centerXYZ=e.toXYZ(t)}equals(e){return Ue(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}check(){return!1}closestTo(e){const t=this.coordinateHelper,n=t.toXYZ(e,_e),s=Oa(n,this.centerXYZ,this.radius);return s[2]=t.getZ(e,this.centerXYZ[2]),t.fromXYZ(s)}}class Bi extends Ie{constructor(e,t,n,s){super(e),this.start=t,this.end=n,this.type=s,this.planeLike={start:t,end:n,type:s}}equals(e){return Te(e)&&this.type===e.type&&F(this.start,e.start)&&F(this.end,e.end)}check(e){const t=this.coordinateHelper.toXYZ(e,_e);return Ta(t,this.planeLike)<P.pointOnLineThreshold}closestTo(e){const t=this.coordinateHelper,n=t.toXYZ(e,_e),s=gs(n,this.planeLike);return t.fromXYZ(s)}closestEndTo(e){const{start:t,end:n}=this;return Math.sign(Ct(he(ka,n,t),he(Fa,e,t)))>0?n:t}}class Es extends Bi{constructor(e,t,n){super(e,t,n,ne.HALF_PLANE)}}class Ms extends Bi{constructor(e,t,n){super(e,t,n,ne.PLANE)}}class Da extends Ie{constructor(e,t,n,s){super(e),this.start=t,this.end=n,this.getZ=s,this.planeLike={start:t,end:n,type:ne.HALF_PLANE}}equals(e){return Oe(e)&&F(this.start,e.start)&&F(this.end,e.end)&&this.getZ===e.getZ}check(e){const t=this.coordinateHelper.toXYZ(e,_e),n=Mn(this,t);return yt(t,n)<P.pointThreshold}closestTo(e){const t=this.coordinateHelper,n=Mn(this,t.toXYZ(e,_e));return t.fromXYZ(n)}addIfOnTheGround(e,t){for(const n of t){const s=this.getZ(n[0],n[1],n[2]);m(s)&&Math.abs(n[2]-s)<k&&(n[2]=s,e.push(n))}}}function Mn(i,e){const t=gs(e,i.planeLike),n=i.getZ(e[0],e[1],e[2]);return m(n)&&(t[2]=n),t}function za(i,e){let t=[];if(qe(i)){const{pointXYZ:n}=i;Ce(e)?t=Ai(e.lineLike,n):Ue(e)?t=Hi(e.centerXYZ,e.radius,n):Te(e)?t=Li(e.planeLike,n):Oe(e)&&(t=dt(e,i))}else if(Ce(i)){const{lineLike:n}=i;qe(e)?t=Ai(n,e.pointXYZ):Ce(e)?t=ys(n,e.lineLike):Ue(e)?t=En(n,e.centerXYZ,e.radius):Te(e)?t=Ri(e.planeLike,n):Oe(e)&&(t=dt(e,i))}else if(Ue(i)){const{centerXYZ:n,radius:s}=i;Ce(e)?t=En(e.lineLike,n,s):qe(e)?t=Hi(n,s,e.pointXYZ):Te(e)?t=Oi(e.planeLike,n,s):Oe(e)&&(t=dt(e,i))}else if(Te(i)){const{planeLike:n,coordinateHelper:s}=i;if(Te(e))return ms(n,e.planeLike).map(r=>new Wi(s,s.fromXYZ(r),i,e));qe(e)?t=Li(n,e.pointXYZ):Ce(e)?t=Ri(n,e.lineLike):Ue(e)?t=Oi(n,e.centerXYZ,e.radius):Oe(e)&&(t=dt(e,i))}else Oe(i)&&(t=dt(i,e));return Va(t,i,e)}function dt(i,e){const{planeLike:t,getZ:n}=i,s=[];if(qe(e))i.addIfOnTheGround(s,Li(t,e.pointXYZ));else if(Ce(e))i.addIfOnTheGround(s,Ri(t,e.lineLike));else if(Ue(e))i.addIfOnTheGround(s,Oi(t,e.centerXYZ,e.radius));else if(Te(e)||Oe(e))for(const[r,o]of ms(t,e.planeLike)){const a=n(r,o,0);m(a)&&s.push(B(r,o,a))}return s}function Va(i,e,t){const n=e.coordinateHelper;return i.map(s=>new ai(n,n.fromXYZ(s),e,t))}function qe(i){return i instanceof Aa}function Ce(i){return i instanceof xs}function Ue(i){return i instanceof Ps}function Te(i){return i instanceof Bi}function Oe(i){return i instanceof Da}const _e=v(),Ia=v(),ka=ze(),Fa=ze();class at{constructor(e,t,n,s,r){this.coordinateHelper=e,this.targetPoint=t,this.constraint=n,this.elevationInfo=s,this.domain=r}}class $s extends at{constructor({coordinateHelper:e,targetPoint:t,objectId:n,constraint:s,elevationInfo:r}){super(e,t,s,r,z.FEATURE),this.objectId=n}}class Na extends $s{constructor(e){super({...e,constraint:new Ha(e.coordinateHelper,e.edgeStart,e.edgeEnd)})}get hints(){return[new Q(U.REFERENCE,this.constraint.start,this.constraint.end,this.elevationInfo,this.domain)]}}class bs extends at{constructor({coordinateHelper:e,targetPoint:t,constraint:n,previousVertex:s,otherVertex:r,otherVertexType:o,objectId:a,elevationInfo:l}){super(e,t,n,l,z.SELF),this.previousVertex=s,this.otherVertex=r,this.otherVertexType=o,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===nt.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===nt.CENTER?this.targetPoint:this.otherVertex,s=this.elevationInfo;return[new Q(U.TARGET,t,n,s,this.domain),new Q(U.REFERENCE,e,t,s,this.domain),new Rt(this.previousVertex,t,n,s,this.domain)]}}var nt;(function(i){i[i.NEXT=0]="NEXT",i[i.CENTER=1]="CENTER"})(nt||(nt={}));let ue=class extends Vi{constructor(i){super(i),this.options=null,this._domain=z.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}get updating(){return _r(this.snappingSources,({snappingSource:i})=>i.updating)||this.updatingHandles.updating}get snappingSources(){const i=this._get("snappingSources")||new Map,e=new Map;if(m(this.options)&&m(this.options.featureSources))for(const t of this.options.featureSources.items){const n=t.layer.uid,s=i.get(n);if(s){i.delete(n),e.set(n,s);continue}if(!t.layer.loaded){this.updatingHandles.addPromise(t.layer.load());continue}const r=this._createSourceInfo(t);m(r)&&e.set(n,r)}for(const[,t]of i)t.destroy();return e}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),it),m(this.view)&&this.handles.add([this.view.on("layerview-create",i=>this._updateLayerView(i.layer,i.layerView)),this.view.on("layerview-destroy",i=>this._updateLayerView(i.layer,null))])}_updateLayerView(i,e){for(const[,t]of this.snappingSources)t.snappingSource.layerSource.layer===i&&(t.layerView=e)}destroy(){this._set("options",null);for(const[,i]of this.snappingSources)i.destroy()}async fetchCandidates(i,e,t,n){if(!(e&this._domain)||y(this.options)||!this.options.effectiveFeatureEnabled)return[];const s=[],r=this._computeScreeenSizeDistanceParameters(i,t),o={distance:r,point:i,coordinateHelper:t.coordinateHelper,types:this._types};for(const[,{snappingSource:l,layerView:c}]of this.snappingSources)!l.layerSource.enabled||m(c)&&c.suspended||s.push(l.fetchCandidates(o,n).then(d=>d.filter(u=>!this._candidateIsExcluded(l,u,t.excludeFeature))));const a=(await yr(s)).flat();return this._addRightAngleCandidates(a,i,r,t),vr(n),Ui(i,a,t.coordinateHelper),a}_addRightAngleCandidates(i,e,t,n){var d,u,f,g,_,S,x,H;const s=m(n.vertexHandle)?(u=(d=n.vertexHandle.rightEdge)==null?void 0:d.rightVertex)==null?void 0:u.pos:m(n.editGeometryOperations)&&n.editGeometryOperations.data.type==="polygon"?(g=re((f=n.editGeometryOperations.data.components[0])==null?void 0:f.getFirstVertex()))==null?void 0:g.pos:null,r=m(n.vertexHandle)?(S=(_=n.vertexHandle.leftEdge)==null?void 0:_.leftVertex)==null?void 0:S.pos:m(n.editGeometryOperations)?(H=re((x=n.editGeometryOperations.data.components[0])==null?void 0:x.getLastVertex()))==null?void 0:H.pos:null,{view:o}=this,a=A(s,o,n),l=A(r,o,n),c=i.length;for(let xe=0;xe<c;xe++)this._addRightAngleCandidate(i[xe],l,e,t,n,i),this._addRightAngleCandidate(i[xe],a,e,t,n,i)}_addRightAngleCandidate(i,e,t,n,s,r){const o=i instanceof Na,a=o&&Sr(i.constraint.start,i.constraint.end);if(y(e)||!o||a)return;const l=i.constraint.closestTo(e),c=(l[0]-t[0])/n.x,d=(l[1]-t[1])/n.y;if(c*c+d*d<=1){const u=s.coordinateHelper,f=new bs({coordinateHelper:u,targetPoint:l,otherVertex:e,otherVertexType:nt.NEXT,previousVertex:i.constraint.start,constraint:new Es(u,e,l),objectId:i.objectId,elevationInfo:i.elevationInfo});r.push(f)}}_computeScreeenSizeDistanceParameters(i,e){let t=m(this.options)?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return y(this.view)?{x:t,y:t,z:t,distance:t}:this.view.type==="2d"?(t*=this.view.resolution,{x:t,y:t,z:t,distance:t}):this._computeScreenSizeDistanceParameters3D(i,t,this.view,e)}_computeScreenSizeDistanceParameters3D(i,e,t,n){const{coordinateHelper:s,elevationInfo:r}=n,{spatialReference:o}=s,a=s.hasZ()?O:r,l=s.toXYZ(i,Za);l[2]=Jn(t,l,o,a,O),t.renderCoordsHelper.toRenderCoords(l,o,$n);const c=t.state.camera.computeScreenPixelSizeAt($n),d=c*t.renderCoordsHelper.unitInMeters/t.mapCoordsHelper.unitInMeters,u=e*d,f=jn(l,o,O,t),g=vi(f,l,d,0,0,t,n),_=vi(f,l,0,d,0,t,n),S=vi(f,l,0,0,d,t,n);return{x:g===0?0:u/g,y:_===0?0:u/_,z:S===0?0:u/S,distance:c*e}}get _types(){return pn.EDGE|pn.VERTEX}_candidateIsExcluded(i,e,t){if(y(t))return!1;const n=this._getCandidateObjectId(e);if(y(n))return!1;const s=i.layerSource.layer;return s.type==="graphics"?t.uid===n:t.sourceLayer===s&&!(!t.attributes||!("objectIdField"in s))&&t.attributes[s.objectIdField]===n}_getCandidateObjectId(i){return i instanceof $s?i.objectId:null}_createSourceInfo(i){const e=this._createFeatureSnappingSourceType(i);if(y(e))return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const t=m(this.view)?this.view.allLayerViews.find(n=>n.layer===i.layer):null;return new Ga(e.source,t)}_createFeatureSnappingSourceType(i){switch(i.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(i);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(i);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(i);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(i)}return null}_createFeatureSnappingSourceSceneLayer(i){const{view:e}=this;if(y(e)||e.type!=="3d")return null;const t=this._getSourceModule("scene");return m(t.module)?{source:new t.module.SceneLayerSnappingSource({layerSource:i,view:e})}:{loading:t.loader}}_createFeatureSnappingSourceFeatureLayer(i){switch(i.layer.source.type){case"feature-layer":case"oriented-imagery":{const e=this._getSourceModule("featureService");return m(e.module)?{source:new e.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:i})}:{loading:e.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(i.layer.geometryType==="mesh")return null;const e=this._getSourceModule("featureCollection");return m(e.module)?{source:new e.module.FeatureCollectionSnappingSource({layerSource:i,view:this.view})}:{loading:e.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(i){const e=this._getSourceModule("graphics");return m(e.module)?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>[i.layer],spatialReference:this.spatialReference,view:this.view,layerSource:i})}:{loading:e.loader}}_createFeatureSnappingSourceMapNotesLayer(i){const e=this._getSourceModule("notes");return m(e.module)?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>m(i.layer.sublayers)?i.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:i})}:{loading:e.loader}}_getSourceModule(i){const e=this._sourceModules[i];if(y(e.loader)){const t=this._loadSourceModule(i).then(n=>{e.module=n});return e.loader=t,{module:e.module,loader:t}}return{module:e.module,loader:e.loader}}_loadSourceModule(i){const e=this.updatingHandles;switch(i){case"featureService":return e.addPromise(Ht(()=>import("./FeatureServiceSnappingSource.bb536b34.js"),["assets/FeatureServiceSnappingSource.bb536b34.js","assets/index.f2e9cdcf.js","assets/index.785c8c13.css","assets/elevationInfoUtils.6c1a0147.js","assets/queryEngineUtils.3514093c.js","assets/VertexSnappingCandidate.3aac76a2.js","assets/TileTreeDebugger.4ad16e6f.js","assets/LineVisualElement.9133d51b.js","assets/LengthDimension.3df95a04.js","assets/Segment.54e1279f.js","assets/analysisViewUtils.832e6f12.js","assets/ImageMaterial.cd48947d.js","assets/Factory.0b13bc82.js","assets/PointVisualElement.93f2b248.js","assets/RightAngleQuadVisualElement.6ef9250b.js","assets/colorUtils.bb6424b7.js","assets/EditGeometryOperations.8d8d841c.js","assets/QueryEngineResult.ddb48b00.js","assets/WhereClause.7bb0c466.js","assets/utils.2fc37d0a.js","assets/generateRendererUtils.50aae7ff.js","assets/json.879c9adc.js","assets/dehydratedFeatureComparison.e2438592.js","assets/RenderTexture.b346685b.js"]));case"featureCollection":return e.addPromise(Ht(()=>import("./FeatureCollectionSnappingSource.e775f4c1.js"),["assets/FeatureCollectionSnappingSource.e775f4c1.js","assets/index.f2e9cdcf.js","assets/index.785c8c13.css","assets/elevationInfoUtils.6c1a0147.js","assets/queryEngineUtils.3514093c.js","assets/VertexSnappingCandidate.3aac76a2.js","assets/symbologySnappingCandidates.45d8c893.js","assets/LineVisualElement.9133d51b.js","assets/LengthDimension.3df95a04.js","assets/Segment.54e1279f.js","assets/analysisViewUtils.832e6f12.js","assets/ImageMaterial.cd48947d.js","assets/Factory.0b13bc82.js","assets/PointVisualElement.93f2b248.js","assets/RightAngleQuadVisualElement.6ef9250b.js","assets/colorUtils.bb6424b7.js","assets/EditGeometryOperations.8d8d841c.js","assets/QueryEngineResult.ddb48b00.js","assets/WhereClause.7bb0c466.js","assets/utils.2fc37d0a.js","assets/generateRendererUtils.50aae7ff.js","assets/json.879c9adc.js","assets/dehydratedFeatureComparison.e2438592.js","assets/RenderTexture.b346685b.js"]));case"graphics":case"notes":return e.addPromise(Ht(()=>import("./GraphicsSnappingSource.eb11b618.js"),["assets/GraphicsSnappingSource.eb11b618.js","assets/index.f2e9cdcf.js","assets/index.785c8c13.css","assets/normalizeUtilsSync.08c60e26.js","assets/FeatureStore.8c331557.js","assets/PooledRBush.1b0cf616.js","assets/quickselect.3948ea39.js","assets/optimizedFeatureQueryEngineAdapter.dd97429a.js","assets/centroid.6c3feae8.js","assets/QueryEngine.57019395.js","assets/QueryEngineResult.ddb48b00.js","assets/WhereClause.7bb0c466.js","assets/utils.2fc37d0a.js","assets/generateRendererUtils.50aae7ff.js","assets/json.879c9adc.js","assets/QueryEngineCapabilities.78217f95.js","assets/elevationInfoUtils.6c1a0147.js","assets/queryEngineUtils.3514093c.js","assets/VertexSnappingCandidate.3aac76a2.js","assets/symbologySnappingCandidates.45d8c893.js","assets/LineVisualElement.9133d51b.js","assets/LengthDimension.3df95a04.js","assets/Segment.54e1279f.js","assets/analysisViewUtils.832e6f12.js","assets/ImageMaterial.cd48947d.js","assets/Factory.0b13bc82.js","assets/PointVisualElement.93f2b248.js","assets/RightAngleQuadVisualElement.6ef9250b.js","assets/colorUtils.bb6424b7.js","assets/EditGeometryOperations.8d8d841c.js","assets/dehydratedFeatureComparison.e2438592.js","assets/RenderTexture.b346685b.js"]));case"scene":return e.addPromise(Ht(()=>import("./SceneLayerSnappingSource.1cd97fc7.js"),["assets/SceneLayerSnappingSource.1cd97fc7.js","assets/index.f2e9cdcf.js","assets/index.785c8c13.css","assets/elevationInfoUtils.6c1a0147.js","assets/VertexSnappingCandidate.3aac76a2.js","assets/LineVisualElement.9133d51b.js","assets/LengthDimension.3df95a04.js","assets/Segment.54e1279f.js","assets/analysisViewUtils.832e6f12.js","assets/ImageMaterial.cd48947d.js","assets/Factory.0b13bc82.js","assets/PointVisualElement.93f2b248.js","assets/RightAngleQuadVisualElement.6ef9250b.js","assets/colorUtils.bb6424b7.js","assets/EditGeometryOperations.8d8d841c.js","assets/QueryEngineResult.ddb48b00.js","assets/WhereClause.7bb0c466.js","assets/utils.2fc37d0a.js","assets/generateRendererUtils.50aae7ff.js","assets/json.879c9adc.js","assets/dehydratedFeatureComparison.e2438592.js","assets/RenderTexture.b346685b.js"]))}return null}};h([p({constructOnly:!0})],ue.prototype,"spatialReference",void 0),h([p({constructOnly:!0})],ue.prototype,"view",void 0),h([p()],ue.prototype,"options",void 0),h([p({readOnly:!0})],ue.prototype,"updating",null),h([p({readOnly:!0})],ue.prototype,"snappingSources",null),ue=h([N("esri.views.interactive.snapping.FeatureSnappingEngine")],ue);class Ga{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new st;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([E(()=>e.updating,s=>e.layerSource.updating=s,Y),E(()=>e.availability,s=>e.layerSource.availability=s,Y)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}function vi(i,e,t,n,s,r,{coordinateHelper:o}){const a=V(Ya,e);a[0]+=t,a[1]+=n,a[2]+=s;const l=jn(a,o.spatialReference,O,r);return da(l,i)}const Za=v(),$n=v(),Ya=v();class li{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=P.shortLineThreshold*P.shortLineThreshold}snap(e,t){return m(t.vertexHandle)?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(e.leftVertex.pos,e.rightVertex.pos,t)}exceedsShortLineThreshold(e,t,{elevationInfo:n,editGeometryOperations:s}){const r=s.data.coordinateHelper;return this.squaredShortLineThreshold===0||Ve(q(t,r,n,this.view),q(e,r,n,this.view))>this.squaredShortLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,n=e*t;return n*n}}class qa extends at{constructor({coordinateHelper:e,lineStart:t,lineEnd:n,targetPoint:s,elevationInfo:r}){super(e,s,new Ms(e,t,n),r,z.SELF),this._referenceLineHint=new Q(U.REFERENCE_EXTENSION,t,n,r,this.domain)}get hints(){return[this._referenceLineHint,new Q(U.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.elevationInfo,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}}class Ua extends li{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const o=t.coordinateHelper,a=q(e,o,O,this.view),{view:l}=this,c=n.edges[s-1];let d=c;do{if(this.edgeExceedsShortLineThreshold(d,t)){const u=le(d,l,t);this._processCandidateProposal(u.left,u.right,e,a,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==c);return r}snapExistingVertex(e,t){const n=[],s=re(t.vertexHandle),r=s.component;if(r.edges.length<2)return n;const{view:o}=this,{coordinateHelper:a}=t,l=q(e,a,O,o),c=s.leftEdge,d=s.rightEdge;c&&d&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(A(c.leftVertex.pos,o,t),A(d.rightVertex.pos,o,t),e,l,t,n);const u=r.edges[0];let f=u;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,t)){const g=le(f,o,t);this._processCandidateProposal(g.left,g.right,e,l,t,n)}f=f.rightVertex.rightEdge}while(f&&f!==u);return n}_processCandidateProposal(e,t,n,s,r,o){const{coordinateHelper:a,pointer:l}=r;a.toXYZ(e,Cs),a.toXYZ(t,Ts);const c=a.toXYZ(n,Xa),d=Xi(c,ja),u=a.fromXYZ(d);Ve(s,q(u,a,O,this.view))<this.squaredProximityThreshold(l)&&o.push(new qa({coordinateHelper:a,lineStart:e,lineEnd:t,targetPoint:u,elevationInfo:a.hasZ()?O:null}))}}const Cs=v(),Ts=v(),ja={start:Cs,end:Ts,type:I.LINE},Xa=v();class Wa extends at{constructor({coordinateHelper:e,referenceLine:t,lineStart:n,targetPoint:s,elevationInfo:r}){const o=e.toXYZ(n,Ba),a=e.toXYZ(t.left,Ja),l=e.toXYZ(t.right,Ka);rt(o,zn(o,o,l),a),super(e,s,new Ms(e,n,e.fromXYZ(o)),r,z.SELF),this._referenceLines=[{edge:t,fadeLeft:!0,fadeRight:!0}]}get hints(){const e=this.elevationInfo;return[new Q(U.TARGET,this.constraint.start,this.targetPoint,e,this.domain),new ri(this.constraint.start,this.targetPoint,e,this.domain),...this._referenceLines.map(t=>new Q(U.REFERENCE,t.edge.left,t.edge.right,e,this.domain,t.fadeLeft,t.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0},{coordinateHelper:n}=this;this._referenceLines.forEach(s=>{n.equals(e.right,s.edge.left)&&(s.fadeLeft=!1,t.fadeRight=!1),n.equals(e.right,s.edge.right)&&(s.fadeRight=!1,t.fadeRight=!1),n.equals(e.left,s.edge.right)&&(s.fadeRight=!1,t.fadeLeft=!1),n.equals(e.left,s.edge.left)&&(s.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}}const Ba=v(),Ja=v(),Ka=v();class Qa extends li{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,o=[];if(s<2)return o;const{view:a}=this,l=q(e,t.coordinateHelper,O,a),c=A(n.vertices[r-1].pos,a,t),d=A(n.vertices[0].pos,a,t),u=n.edges[s-1];let f=u;do{if(this.edgeExceedsShortLineThreshold(f,t)){const g=le(f,a,t);this._checkEdgeForParalleLines(g,c,e,l,t,o),this._checkEdgeForParalleLines(g,d,e,l,t,o)}f=f.leftVertex.leftEdge}while(f&&f!==u);return o}snapExistingVertex(e,t){const n=[],s=re(t.vertexHandle),r=s.component;if(r.edges.length<3)return n;const{view:o}=this,a=q(e,t.coordinateHelper,O,o),l=s.leftEdge,c=s.rightEdge,d=r.vertices[0],u=A(d.pos,o,t),f=r.vertices.length,g=r.vertices[f-1],_=A(g.pos,o,t),S=r.edges[0];let x=S;do{if(x!==l&&x!==c&&this.edgeExceedsShortLineThreshold(x,t)){const H=le(x,o,t);l&&this._checkEdgeForParalleLines(H,A(l.leftVertex.pos,o,t),e,a,t,n),c&&this._checkEdgeForParalleLines(H,A(c.rightVertex.pos,o,t),e,a,t,n),s===d?this._checkEdgeForParalleLines(H,_,e,a,t,n):s===g&&this._checkEdgeForParalleLines(H,u,e,a,t,n)}x=x.rightVertex.rightEdge}while(x&&x!==S);return n}_checkEdgeForParalleLines(e,t,n,s,r,o){const a=e.left,l=e.right;if(mi(Ge,t,a,l),ln(Ge,t)<P.parallelLineThreshold)return;mi(Ge,n,a,l,t);const{coordinateHelper:c,pointer:d}=r,u=c.fromXYZ(Ge,c.getZ(n,0));if(Ve(s,q(u,c,O,this.view))<this.squaredProximityThreshold(d)){if(this._parallelToPreviousCandidate(e,o))return;o.push(new Wa({coordinateHelper:c,referenceLine:e,lineStart:t,targetPoint:u,elevationInfo:c.hasZ()?O:null}))}}_parallelToPreviousCandidate(e,t){const n=e.left,s=e.right;for(const r of t)if(mi(Ge,s,r.constraint.start,r.constraint.end,n),ln(Ge,s)<P.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}const Ge=ze();class el extends li{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const{view:o}=this,a=q(e,t.coordinateHelper,O,o),l=n.vertices[s-1];if(this.edgeExceedsShortLineThreshold(l.leftEdge,t)){const d=A(l.pos,o,t),u=le(l.leftEdge,o,t);this._checkForSnappingCandidate(r,u,d,e,u.left,d,t,e,a)}const c=n.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,t)){const d=A(c.pos,o,t),u=le(c.rightEdge,o,t);this._checkForSnappingCandidate(r,u,d,e,u.right,d,t,e,a)}return r}snapExistingVertex(e,t){const n=[],s=re(t.vertexHandle),r=s.component,o=r.vertices.length;if(o<3)return n;const{view:a}=this,l=q(e,t.coordinateHelper,O,a),c=s.leftEdge,d=s.rightEdge,u=r.vertices[0],f=r.vertices[o-1];if(!c){const g=u.rightEdge.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(g,t)){const _=le(g,a,t),S=A(u.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(n,_,S,e,_.right,S,t,e,l)}return n}if(!d){const g=f.leftEdge.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(g,t)){const _=le(g,a,t),S=A(f.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(n,_,S,e,_.left,S,t,e,l)}return n}if(c&&c.leftVertex.leftEdge){const g=c.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(g,t)){const _=le(g,a,t),S=A(c.leftVertex.pos,a,t);this._checkForSnappingCandidate(n,_,S,e,_.left,S,t,e,l)}}if(d&&d.rightVertex.rightEdge){const g=d.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(g,t)){const _=le(g,a,t),S=A(d.rightVertex.pos,a,t);this._checkForSnappingCandidate(n,_,S,e,_.right,S,t,e,l)}}return n}_checkForSnappingCandidate(e,t,n,s,r,o,a,l,c){const{coordinateHelper:d,pointer:u}=a;he(ht,t.right,t.left);const f=se(nl,ht[1],-ht[0],0),g=Ct(f,he(ht,s,n))/vt(f),_=d.fromXYZ(Le(ht,o,f,g),d.getZ(l,0));if(Ve(c,q(_,d,O,this.view))<this.squaredProximityThreshold(u)){const S=d.toXYZ(o,tl),x=de(il,S,f,Math.sign(g)),H=d.fromXYZ(x);e.push(new bs({coordinateHelper:d,targetPoint:_,constraint:new Es(d,o,H),previousVertex:r,otherVertex:o,otherVertexType:nt.CENTER,elevationInfo:d.hasZ()?O:null}))}}}const ht=ze(),tl=v(),il=v(),nl=v();class sl extends at{constructor({coordinateHelper:e,targetPoint:t,point1:n,point2:s,elevationInfo:r}){super(e,t,new Ps(e,e.arrayToVector(In(rl,n,s,.5)),.5*kn(n,s)),r,z.SELF),this._p1=n,this._p2=s}get hints(){const e=this.elevationInfo;return[new Q(U.REFERENCE,this.targetPoint,this._p1,e,this.domain),new Q(U.REFERENCE,this.targetPoint,this._p2,e,this.domain),new Rt(this._p1,this.targetPoint,this._p2,e,this.domain)]}}const rl=ze();class ol extends li{snapNewVertex(e,t){const n=t.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:o}=this,a=n.vertices[0],l=n.vertices[r-1],c=A(a.pos,o,t),d=A(l.pos,o,t);return this._processCandidateProposal(c,d,e,t,s),s}snapExistingVertex(e,t){const n=[],s=re(t.vertexHandle),r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return n;const{view:o}=this,a=A(s.leftEdge.leftVertex.pos,o,t),l=A(s.rightEdge.rightVertex.pos,o,t);return this._processCandidateProposal(a,l,e,t,n),n}_processCandidateProposal(e,t,n,s,r){if(!this.exceedsShortLineThreshold(e,t,s))return;const o=In(al,e,t,.5),a=.5*kn(e,t),l=ho(ll,n,o,a),{coordinateHelper:c,pointer:d}=s,u=c.fromXYZ(l,c.getZ(n,0)),f=q(n,c,O,this.view);Ve(f,q(u,c,O,this.view))<this.squaredProximityThreshold(d)&&r.push(new sl({coordinateHelper:c,targetPoint:u,point1:e,point2:t,elevationInfo:c.hasZ()?O:null}))}}const al=ze(),ll=ze();let Ye=class extends ye{constructor(i){super(i),this.updating=!1,this._snappers=new ot,this._domain=z.SELF}initialize(){this._snappers.push(new Qa(this.view,this.options),new Ua(this.view,this.options),new el(this.view,this.options),new ol(this.view,this.options))}set options(i){this._set("options",i);for(const e of this._snappers)e.options=i}async fetchCandidates(i,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const n=[];for(const s of this._snappers.items)for(const r of s.snap(i,t))n.push(r);return Ui(i,n,t.coordinateHelper),n}};h([p({readOnly:!0})],Ye.prototype,"updating",void 0),h([p({constructOnly:!0})],Ye.prototype,"view",void 0),h([p()],Ye.prototype,"options",null),Ye=h([N("esri.views.interactive.snapping.SelfSnappingEngine")],Ye);function cl(i,e){return[new Ye({view:i,options:e}),new ue({view:i,options:e,spatialReference:i.spatialReference})]}class Zt extends at{constructor(e,t,n,s,r){super(e,t,new ai(e,t,n.constraint,s.constraint),r,z.ALL),this.first=n,this.second=s}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new si(this.targetPoint,this.elevationInfo,this.domain)]}}let ae=class extends wr.EventedMixin(Vi){constructor(i){super(i),this.options=new fs,this.snappingEnginesFactory=cl,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=pe.MAIN}initialize(){this.handles.add([E(()=>{const{effectiveFeatureEnabled:i,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:n}=this.options;return{effectiveFeatureEnabled:i,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:n}},()=>{this.doneSnapping(),this.emit("changed")},it),E(()=>this.options,i=>{for(const e of this._engines)e.options=i},it),E(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:i,snappingEnginesFactory:e})=>this._recreateEngines(i,e),Y)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(i=>i.updating)}_recreateEngines(i,e){if(this._destroyEngines(),!i)return;const{view:t,options:n}=this;this._engines=e(t,n)}_destroyEngines(){for(const i of this._engines)i.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:i,touchSensitivityMultiplier:e}=this.options,t=i*e;return t*t}async snap(i){return dl(i)?this._snapMultiPoint(i):this._snapSinglePoint(i)}update(i){const{point:e,context:t}=i;this._removeVisualization();const n=this._currentMainCandidate;if(y(n))return e;const s=this._selectUpdateInput(i);if(y(s))return e;const{coordinateHelper:{spatialReference:r}}=t,o=cn(this._convertPointElevation(s,t),r);if(y(o))return e;const{view:a}=this,{coordinateHelper:l,elevationInfo:c,visualizer:d}=t,u=[],f=l.pointToVector(o),g=n.constraint.closestTo(f);if(!this._arePointsWithinScreenThreshold(f,g,t))return this._resetSnappingState(),e;n.targetPoint=g,u.push(...n.hints);for(const S of this._currentOtherActiveCandidates)S.targetPoint=g,u.push(...S.hints);m(d)&&this.handles.add(d.draw(u,{coordinateHelper:l,elevationInfo:bn(t),view:a,selfSnappingZ:t.selfSnappingZ}),Yt);const _=l.vectorToDehydratedPoint(g);return this._convertPointElevation(_,t,O,c)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:i,scenePoint:e}){switch(this._currentSnappedType){case pe.MAIN:return i;case pe.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=pe.MAIN}_removeVisualization(){this.handles.remove(Yt)}async _snapSinglePoint({point:i,context:e,signal:t}){const{coordinateHelper:n}=e,{view:s}=this,r=this._convertPointElevation(i,e),o=n.pointToVector(r),a=await this._fetchCandidates(o,z.ALL,e,t);return this._createSnapResult(o,pe.MAIN,a,s,e,t)}async _snapMultiPoint({point:i,scenePoint:e,context:t,signal:n}){const{view:s}=this,{coordinateHelper:r}=t,{spatialReference:o}=r;await xr(e.spatialReference,o);const a=cn(this._convertPointElevation(e,t),o),l=r.pointToVector(a),c=await this._fetchCandidates(l,z.FEATURE,t,n);if(c.length>0){const g=await this._fetchCandidates(l,z.SELF,t,n);return this._createSnapResult(l,pe.SCENE,[...c,...g],s,t,n)}const d=this._convertPointElevation(i,t),u=r.pointToVector(d),f=await this._fetchCandidates(u,z.SELF,t,n);return this._createSnapResult(u,pe.MAIN,f,s,t,n)}async _fetchCandidates(i,e,t,n){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(i,e,t,n)))).flat()}_createSnapResult(i,e,t,n,s,r){return{get valid(){return!Pr(r)},apply:()=>{const{elevationInfo:o,coordinateHelper:a}=s,{snappedPoint:l,hints:c}=this._processCandidates(i,e,t,s);return this._removeVisualization(),m(s.visualizer)&&this.handles.add(s.visualizer.draw(c,{coordinateHelper:a,elevationInfo:bn(s),view:n,selfSnappingZ:s.selfSnappingZ}),Yt),this._convertPointElevation(l,s,O,o)}}}_processCandidates(i,e,t,n){const{coordinateHelper:s}=n;if(t.length<1)return this.doneSnapping(),{snappedPoint:s.vectorToDehydratedPoint(i),hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Ui(i,t,s);const r=this._currentMainCandidate;if(m(r)){const o=this._findOldConstraintInNewCandidates(r,t);if(o>=0){if(!(t[o]instanceof Zt))return this._intersectWithOtherCandidates(o,t,i,e,n);if(this._arePointsWithinScreenThreshold(i,r.targetPoint,n))return this._updateSnappingCandidate(r,e,t,n)}}return this._intersectWithOtherCandidates(0,t,i,e,n)}_findOldConstraintInNewCandidates(i,e){return i instanceof Zt?this._findOldCandidateIndex(e,i.first)>=0&&this._findOldCandidateIndex(e,i.second)>=0?0:-1:this._findOldCandidateIndex(e,i)}_intersectWithOtherCandidates(i,e,t,n,s){const{coordinateHelper:r}=s,o=e[i],a=[];for(let l=0;l<e.length;++l){if(l===i)continue;const c=e[l];for(const d of o.constraint.intersect(c.constraint)){const u=r.fromXYZ(d.closestTo(o.targetPoint),o.targetPoint[2]);a.push([new Zt(r,u,o,c,c.elevationInfo),this._squaredScreenDistance(t,u,r)])}}return a.length>0&&(a.sort((l,c)=>l[1]-c[1]),a[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(a[0][0],n,e,s):this._updateSnappingCandidate(o,n,e,s)}_updateSnappingCandidate(i,e,t,n){this.doneSnapping(),this._currentMainCandidate=i,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...i.hints);for(const o of t){if(i instanceof Zt){if(o.constraint.equals(i.first.constraint)||o.constraint.equals(i.second.constraint))continue}else if(o.constraint.equals(i.constraint))continue;o.constraint.check(s)&&(o.targetPoint=s,this._currentOtherActiveCandidates.push(o),r.push(...o.hints))}return{snappedPoint:n.coordinateHelper.vectorToDehydratedPoint(s),hints:r}}_squaredPointProximityThreshold(i){return i==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(i,e,t){return this._squaredScreenDistance(i,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(i,e,t){return Ve(this._toScreen(i,t),this._toScreen(e,t))}_toScreen(i,e){return q(i,e,O,this.view)}_findOldCandidateIndex(i,e){let t=-1;for(let n=0;n<i.length;++n)if(e.constraint.equals(i[n].constraint)){t=n;break}return t}_convertPointElevation(i,e,t=e.elevationInfo,n=O){const{view:s}=this;if(!(m(i)&&e.coordinateHelper.hasZ()&&m(s)&&s.type==="3d"))return i;const r=Er(i);return r.z=oo(s,r,t,n),r}get test(){return{visualizationsActive:this.handles.has(Yt),engines:this._engines}}};var pe;h([p({constructOnly:!0})],ae.prototype,"view",void 0),h([p()],ae.prototype,"options",void 0),h([p({readOnly:!0})],ae.prototype,"updating",null),h([p()],ae.prototype,"snappingEnginesFactory",void 0),h([p()],ae.prototype,"_engines",void 0),h([p()],ae.prototype,"_squaredMouseProximityTreshold",null),h([p()],ae.prototype,"_squaredTouchProximityThreshold",null),ae=h([N("esri.views.interactive.snapping.SnappingManager")],ae),function(i){i[i.MAIN=0]="MAIN",i[i.SCENE=1]="SCENE"}(pe||(pe={}));const Yt="visualization-handle";function dl(i){return m(i.scenePoint)}function bn({coordinateHelper:i,elevationInfo:e}){return i.hasZ()?O:e}const Ut=new Map;function hl(i){if(!Ut.has(i)){const n=Ca(i,{distance:10}),s=pl(i,n.options);Ut.set(i,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const e=Ut.get(i);e.referenceCount++;const t=Wt(()=>ul(i,e));return{snappingManager:e.snappingManager,...t}}function ul(i,e){e.referenceCount--,e.referenceCount>0||Mr(()=>{e.referenceCount===0&&(e.remove(),Ut.delete(i))})}function pl(i,e){return new ae({view:i,options:e,snappingEnginesFactory:(t,n)=>[new ue({view:i,spatialReference:i.spatialReference,options:n})]})}class Os{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}}class fl{constructor(){this.next=new bi}createSnapDragEventPipelineStep({predicate:e=()=>!0,cancel:t,snappingManager:n,snappingContext:s,updatingHandles:r,useZ:o=!0}){if(y(n))return _=>_;let a=null,l=null;const c=()=>{a=wt(a),n.doneSnapping(),m(l)&&l.frameTask.remove(),l=null};t.next(_=>(c(),_)),this.next=new bi;const d=this._createSnapFunction(n,o);let u=null,f=null,g=null;return _=>{if(!e(_))return _;if(_.action==="start"){const S=this._createFrameTask(n.view);if(l=this._createSnappingInfo(s,_,S),l.context.selfSnappingZ=null,!o&&m(_.info)){const x=this._extractSelfSnappingZ(s.coordinateHelper,_.info.handle.component);m(x)&&(l.context.selfSnappingZ={value:x,elevationInfo:s.elevationInfo})}}if(m(l)){const{context:S,originalScenePos:x,originalPos:H}=l,{mapEnd:xe,mapStart:Ji,action:Rs,scenePoints:Ls}=_,ci=this._updatePosition(H,this._computeMapDelta(xe,Ji)),Ki=this._computeMapDelta(Ji,H),As={..._,action:"update"},Hs=l.context,di=this._updateScenePosition(x,Ls),Qi=n.update({point:ci,scenePoint:di,context:S});if(g=Qi,this._applySnappedUpdate(xe,Qi,Ki,o),u=ci,f=di,Rs!=="end"){const{frameTask:Ds}=l;y(a)&&(a=new AbortController),r.addPromise(Fn(d({frameTask:Ds,event:As,context:Hs,point:ci,scenePoint:di,delta:Ki,lastPos:u,lastScenePos:f,lastUpdate:g},a.signal)))}}return _.action==="end"&&c(),_}}_createSnapFunction(e,t){return Nn(async({frameTask:n,point:s,scenePoint:r,context:o,event:a,delta:l,lastPos:c,lastScenePos:d,lastUpdate:u},f)=>{const g=await n.schedule(()=>e.snap({point:s,scenePoint:r,context:o,signal:f}),f);if(g.valid){let _=await n.schedule(()=>g.apply(),f);s!==c&&m(c)&&(_=e.update({point:c,scenePoint:d,context:o})),mo(_,u)||(this._applySnappedUpdate(a.mapEnd,_,l,t),this.next.execute(a))}})}_createFrameTask(e){return e.type==="3d"?e.resourceController.scheduler.registerTask(Gn.SNAPPING):Zn}_createSnappingInfo(e,t,n){return{context:new Os({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:m(t.info)?t.info.handle:null,excludeFeature:e.excludeFeature,visualizer:e.visualizer}),originalPos:m(t.snapOrigin)?e.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:m(t.scenePoints)?t.scenePoints.sceneStart:null,frameTask:n}}_updatePosition(e,[t,n,s]){const r=Xe(e);return r.x+=t,r.y+=n,r.hasZ&&(r.z+=s),r}_updateScenePosition(e,t){return y(e)||y(t)?null:this._updatePosition(e,this._computeMapDelta(t.sceneEnd,t.sceneStart))}_computeMapDelta(e,t){const n=e.hasZ&&t.hasZ?e.z-t.z:0;return[e.x-t.x,e.y-t.y,n]}_applySnappedUpdate(e,t,[n,s,r],o){e.x=t.x+n,e.y=t.y+s,o&&e.hasZ&&t.hasZ&&(e.z=t.z+r)}_extractSelfSnappingZ(e,t){if(!e.hasZ())return null;const n=t.vertices;let s=null;for(const r of n){const o=e.getZ(r.pos);if(m(s)&&Math.abs(o-s)>1e-6)return null;y(s)&&(s=o)}return s}}let be=class extends ye{constructor(i){super(i),this.constrainResult=e=>e,this._snapPoints=null,this._abortController=null,this._stagedPoint=null,this._snap=Nn(async(e,t,n,s)=>{const r=await this._frameTask.schedule(()=>t.snap({...e,context:n,signal:s}),s);r.valid&&await this._frameTask.schedule(()=>{this.stagedPoint=r.apply(),e!==this._snapPoints&&m(this._snapPoints)&&(this.stagedPoint=t.update({...this._snapPoints,context:n}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(i){this._stagedPoint=this.constrainResult(i)}initialize(){var e,t;const i=this.view.type==="3d"?(t=(e=this.view)==null?void 0:e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=m(i)?i.registerTask(Gn.SNAPPING):Zn}destroy(){this._abortController=wt(this._abortController),this._frameTask=Yn(this._frameTask)}async snap(i,e,t){const{point:n,scenePoint:s}=i;return this.stagedPoint=e.update({point:n,scenePoint:s,context:t}),this._snapPoints=i,y(this._abortController)&&(this._abortController=new AbortController),this._snap(i,e,t,this._abortController.signal)}abort(){this._abortController=wt(this._abortController)}};h([p({constructOnly:!0})],be.prototype,"view",void 0),h([p()],be.prototype,"stagedPoint",null),h([p()],be.prototype,"constrainResult",void 0),h([p()],be.prototype,"_stagedPoint",void 0),be=h([N("esri.views.interactive.snapping.SnappingOperation")],be);let G=class extends Vi{constructor(i){super(i),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new st,this._snappingPipeline=new fl,this._snappingManagerResult=hl(i.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=Si(),this._focusedOffsetManipulatorMaterial=Si(),this._thinOffsetManipulatorMaterial=Si(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:He(2)}),this._constraintSnappingIndicator=new Ee({view:i.view,attached:!0,width:1,color:R.toUnitRGBA(T.constraint.color),renderOccluded:b.OccludeAndTransparent,stipplePattern:He(5)});const e=R.toUnitRGBA(T.disabledPointIndicator.color);e[3]*=T.disabledPointIndicator.opacity,this._stagedStartIndicator=new $a({view:i.view,attached:!1,color:e,size:2*T.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:i.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:b.OccludeAndTransparent})}initialize(){this._snappingOperation=new be({view:this.view}),this._orientationManipulatorTexture=io(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new co({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:b.Opaque});const{computations:i}=this.analysisViewData;for(const e of i)this._addComputation(e);this.addHandles([i.on("after-add",e=>this._addComputation(e.item)),i.on("after-remove",e=>this._removeComputation(e.item))]),this.addHandles([E(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:e,stagedComputation:t})=>{if(y(t)||y(e))return;const n=Xe(e,new ft);this._applyPointUpdate(t,{endPoint:n})},it),E(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(e,t)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=e;if(n===t.stagedDimension&&r===t.firstGrabbedManipulator){for(const o of[s,t.selectedComputation])if(m(o)){const a=this._computationManipulators.get(o);this._updateManipulators(o,a,e)}}else for(const[o,a]of this._computationManipulators)this._updateManipulators(o,a,e)},Y),E(()=>this.analysis.style.lineSize,e=>{this._updateManipulatorStyle(e)},Xt),E(()=>this.view.state.camera,()=>{m(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),E(()=>$r(this._stagedComputation,e=>{const t=e.elevationAlignedStartPoint,n=v();return m(t)&&this.view.renderCoordsHelper.toRenderCoords(t,n)?n:null}),e=>{m(e)?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles)}destroy(){this._snappingOperation=gt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(m(this._stagedComputation))return this._stagedComputation;const{selectedComputation:i}=this.analysisViewData;return this.hasGrabbedManipulators&&m(i)?i:null}get _stagedComputation(){const i=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return y(i)||y(e)||e.dimension!==i?null:e}get _constraintHandles(){return[Ii(()=>this.analysisViewData.selectedComputation,i=>{i.previousConstraint=Ft(i,this.view)},{...Y,equals:$i}),E(()=>{const i=this._activeComputation;if(y(i))return null;const{measureType:e,orientation:t}=i.dimension;return{measureType:e,orientation:t,computation:i}},(i,e)=>{if(m(i)&&y(e)){const{measureType:t,orientation:n,computation:s}=i;switch(s.previousConstraint){case K.Horizontal:s.preConstraintProperties={measureType:$.Horizontal,orientation:0};break;case K.Vertical:s.preConstraintProperties={measureType:$.Vertical,orientation:0};break;case K.Direct:s.preConstraintProperties={measureType:$.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:t,orientation:n}}}y(i)&&m(e)&&(e.computation.preConstraintProperties=null)},it)]}get _snappingIndicatorHandles(){const i="snapping-indicator-event-handles";return[E(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:t})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(i),y(t))n.attached=!1;else if(t===e)n.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(t),o=()=>{n.attached=s.grabbing||r.grabbing};o(),this.addHandles([s.events.on("grab-changed",o),r.events.on("grab-changed",o)],i)}}),E(()=>{const e=this._activeComputation;return m(e)?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:t})=>{const n=this._constraintSnappingIndicator;m(e)&&m(t)&&t!==K.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return!!m(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(i){const{_stagedDimension:e}=this;if(y(e)){const t=this._onUnstagedClick(i);return this.analysis.dimensions.add(t),null}return this._onStagedClick(i),e}onPointerMove({mapPoint:i,pointerType:e}){if(e==="touch")return;const t=this._snappingContext(e);this.updatingHandles.addPromise(Fn(this._snappingOperation.snap({point:i},this._snappingManager,t)))}onManipulatorSelectionChanged(){m(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:i,pointerType:e}){let t=i;if(e==="mouse"){const s=this._snappingContext(e);t=this._snappingManager.update({point:i,context:s})}const n=new Gr({startPoint:Xe(t,new ft),endPoint:null,measureType:$.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:i,pointerType:e}){const t=this._stagedComputation;if(y(t))return;let n=i;if(e==="mouse"){const r=this._snappingContext(e);n=this._snappingManager.update({point:i,context:r})}const s=Xe(n,new ft);this._applyPointUpdate(t,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(i){if(this._computationManipulators.has(i))return;const e=this._setupPointManipulator(i,{isStart:!0}),t=this._setupPointManipulator(i,{isStart:!1}),n=this._setupOffsetManipulator(i),s=this._setupHeadingManipulator(i),r=this._setupRotationManipulator(i),o=this._setupMeasureTypeManipulator(i,$.Direct),a=this._setupMeasureTypeManipulator(i,$.Horizontal),l=this._setupMeasureTypeManipulator(i,$.Vertical),c=new ko({start:e,end:t,offset:n,heading:s,rotation:r,direct:o,horizontal:a,vertical:l});this._setupComputationToManipulatorsSync(i,c),this._computationManipulators.set(i,c),this.manipulators.addMany(c.values())}_removeComputation(i){const e=this._computationManipulators.get(i);if(!y(e)){this._computationHandles.remove(i),this._computationManipulators.delete(i);for(const t of e.values())this.manipulators.remove(t)}}_setupComputationToManipulatorsSync(i,e){this._computationHandles.add([E(()=>i.geometry,()=>this._updateManipulators(i,e),{...Y,equals:$i})],i)}_setupPointManipulator(i,e){const{view:t}=this,{dimension:n}=i,s=Fo(t,{metadata:n}),r=Zo(s,{isStart:e.isStart,createSnappingPipelineStep:(o,a)=>this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(a),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles,cancel:o}),dimension:n,onUpdate:o=>{this._applyPointUpdate(i,o)},snappingPipeline:this._snappingPipeline,view:t});return this._computationHandles.add(r,i),s}_setupOffsetManipulator(i){const{view:e}=this,t=No(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:i.dimension}),n=Yo(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupHeadingManipulator(i){const{view:e}=this,t=mn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:i.dimension}),n=qo(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupRotationManipulator(i){const{view:e}=this,t=mn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:i.dimension}),n=Uo(t,{computation:i,view:e});return this._computationHandles.add(n,i),t}_setupMeasureTypeManipulator(i,e){const{view:t}=this,n=Go(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:i.dimension}),s=Wo(n,{computation:i,manipulatorMeasureType:e,view:t});return this._computationHandles.add(s,i),n}_updateManipulators(i,e,t={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=t,{start:o,end:a,offset:l,heading:c,rotation:d}=e,u=s===i,f=Pt(i),{dimension:g}=i;for(const x of e.values()){const H=f&&y(n)&&(y(r)||x===r);x===l?(x.available=H,x.selected=u):x.available=H&&u}if(!f)return;m(Ft(i,this.view))?e.forEachMeasureTypeManipulator(x=>x.available=!1):e.manipulatorForMeasureType(g.measureType).available=!1;for(const x of[c,d])g.measureType===$.Direct&&g.offset!==0||(x.available=!1);Gi(i)?d.available=!1:c.available=!1;const{geometry:_}=i;o.renderLocation=_.directSegment.startRenderSpace,a.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:S}=this.view;Bo(l,_,S),c.available&&Jo(c,i,S),d.available&&Ko(d,i,S),e.forEachMeasureTypeManipulator((x,H)=>{x.available&&ta(x,i,H,S)})}_updateManipulatorStyle(i){const e=ra(i),t=qi(i),n={lineSizePt:i,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:o}of this._computationManipulators.values())s.radius=t/2,gn(r,n),gn(o,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:t})}_snappingContext(i){return new Os({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new uo(new po("point",fo(!0,!1,this.view.spatialReference))),visualizer:new pa})}_applyPointUpdate(i,e){const{view:t}=this,n=Bt(i);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=Jt(n,t.renderCoordsHelper);if(y(s))return;const r=Ft({...n,geometry:s},t);oa(i,e,{...n,constraint:r,unconstrainedGeometry:s,view:t}),i===this._stagedComputation&&this._updateStagedDimensionOffset(i)}_updateStagedDimensionOffset(i){if(y(i.geometry))return;i.geometry.directSegment.eval(.5,Cn);const e=this.view.state.camera.computeRenderPixelSizeAt(Cn);i.dimension.offset=T.initialOffsetPx*e}get testInfo(){const i=e=>this.analysisViewData.computations.find(t=>t.dimension===e);return{getManipulatorsForDimension:e=>this._computationManipulators.get(i(e)),getComputationForDimension:e=>i(e),getConstraintForDimension:e=>{const t=i(e);return m(t)?Ft(t,this.view):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function Si(){const{color:i,opacity:e}=T.offsetManipulator;return new Re({color:[...R.toUnitRGB(i),e],width:1,renderOccluded:b.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}h([p({constructOnly:!0})],G.prototype,"analysis",void 0),h([p({constructOnly:!0})],G.prototype,"analysisViewData",void 0),h([p({constructOnly:!0})],G.prototype,"manipulators",void 0),h([p({constructOnly:!0})],G.prototype,"parentTool",void 0),h([p({constructOnly:!0,nonNullable:!0})],G.prototype,"view",void 0),h([p({readOnly:!0})],G.prototype,"updating",null),h([p()],G.prototype,"firstGrabbedManipulator",null),h([p()],G.prototype,"hasGrabbedManipulators",null),h([p()],G.prototype,"_stagedDimension",void 0),h([p()],G.prototype,"_activeComputation",null),h([p()],G.prototype,"_stagedComputation",null),G=h([N("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],G);const Cn=v(),Tn={redo:"r",undo:"z",center:"Alt",constraint:"Shift",snappingToggle:"Control",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "};var je;(function(i){i.Ready="ready",i.Creating="creating",i.Created="created"})(je||(je={}));let X=class extends Jr{constructor(i){super(i),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=T.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=br(this.view.state.viewingMode),this._intersector.options.store=Cr.MIN,this._lengthDimensionSubTool=new G({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([Ze(this._lengthDimensionSubTool),Wt(()=>this._clearPointerMoveTimeout()),E(()=>this.state,i=>{i===je.Created&&this.finishToolCreation()},Y),Ii(()=>this.firstGrabbedManipulator,i=>{this.selectedDimension=i.metadata},Y),E(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),Y)])}get state(){return this.analysis.dimensions.some(i=>i.type==="length")?m(this._activeSubTool)?je.Creating:je.Created:je.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(i){this.analysisViewData.selectedDimension=i}onInputEvent(i){switch(i.type){case"immediate-click":this._clickHandler(i);break;case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":if(Tn.cancel===i.key){if(m(this._activeSubTool)&&this._activeSubTool.removeStaged())return void i.stopPropagation();this.active||(this.selectedDimension=null)}else Tn.delete.includes(i.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){m(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(i){if(this.hasFocusedManipulators)return void i.stopPropagation();if(y(this._activeSubTool))return;const e=this._intersectScreen(i);y(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:i.pointerType}),i.stopPropagation())}_doubleClickHandler(i){this.active&&(this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(this._resetPointerMoveTimeout(),y(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(i);y(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:i.pointerType})}_deleteKeyHandler(){m(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(i){const e=Tr(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const t=this._intersector.results.min,n=M.get();return t.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){m(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Yn(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(i=>{i.manipulator.state|=fe}),this._prevPointerMoveTimeout=Or.setTimeout(()=>{this.manipulators.forEach(i=>{i.manipulator.state&=~fe})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:i=>{this._pointerMoveTimerMs=i,this._resetPointerMoveTimeout()}}}};h([p({constructOnly:!0})],X.prototype,"view",void 0),h([p({constructOnly:!0})],X.prototype,"analysis",void 0),h([p({readOnly:!0})],X.prototype,"state",null),h([p({readOnly:!0})],X.prototype,"updating",null),h([p({readOnly:!0})],X.prototype,"cursor",null),h([p({constructOnly:!0})],X.prototype,"analysisViewData",void 0),h([p()],X.prototype,"selectedDimension",null),h([p()],X.prototype,"automaticManipulatorSelection",void 0),h([p()],X.prototype,"_activeSubTool",void 0),h([p()],X.prototype,"_lengthDimensionSubTool",void 0),X=h([N("esri.views.3d.analysis.Dimension.DimensionTool")],X);class ml extends ti{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._renderOccluded=b.OccludeAndTransparent,this._width=1,this._color=jt(1,0,1,1),this._placement="end",this._textureId=null,this._material=t,this._hasExternalMaterial=m(t),this.applyProps(e)}setGeometryFromSegment(e,t){const n=e.endRenderSpace;this.transform=Rr(gl,n),this._normal=t;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return m(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,m(this._material)&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return m(this._material)?this._material.parameters.width:this._width}set width(e){this._width=e,m(this._material)&&this._material.setParameters({width:e})}get color(){return m(this._material)?this._material.parameters.color:this._color}set color(e){this._color=Hn(e),m(this._material)&&this._material.setParameters({color:this._color})}get placement(){return m(this._material)?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,m(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return m(this._material)?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,m(this._material)&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new qn({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const t of Lr(this.geometry,this.normal)){const n=Ar(t);e.addGeometry(n,re(this._material))}}forEachExternalMaterial(e){this._hasExternalMaterial||e(re(this._material))}}const gl=Di();class _l{constructor(e){this.destroyed=!1,this._handles=new st,this._messages=null,this._labelSegment=new De;const{analysis:t,computation:n,view:s,messages:r}=e;this.analysis=t,this.computation=n,this.view=s,this._messages=r;const o=e.visible,a={view:s,attached:o},{fontSize:l,textColor:c,textBackgroundColor:d}=t.style;this._visualElements=new xl({marker:new ml(a,e.markerMaterial),dimension:new Ee(a,e.dimensionLineMaterial),startOffset:new Ee(a,e.offsetLineMaterial),endOffset:new Ee(a,e.offsetLineMaterial),dimensionSmall:new Ee(a,e.smallDimensionLineMaterial),startOffsetSmall:new Ee(a,e.smallOffsetLineMaterial),endOffsetSmall:new Ee(a,e.smallOffsetLineMaterial),label:new qr({view:s,attached:o,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:ce(l),textColor:c.clone(),backgroundColor:d.clone()})}),this._handles.add([E(()=>n.geometry,u=>{this.updateCameraDependentElements(s.state.camera,u,t.style),m(n.geometry)&&this._updateLines(n.geometry)},{...Xt,equals:$i}),E(()=>n.length,u=>this._updateLabelContent(u),Xt)])}set visible(e){for(const t of this._visualElements.values())t.attached=e}destroy(){this.destroyed=!0,this._handles=gt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=fn(vl,xt.Start,e.directSegment,e.dimensionSegment),n=fn(Sl,xt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,t,n){const s=this._visualElements;if(y(t)){for(const S of s.values())S.visible=!1;return}const r=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,wl)),o=Co(t,r),a=o<(ce(n.lineSize)*T.smallScreenLengthLineSizeFactor)**2,l=!a;s.marker.visible=l,s.dimension.visible=l,s.startOffset.visible=l,s.endOffset.visible=l,s.dimensionSmall.visible=a,s.startOffsetSmall.visible=a,s.endOffsetSmall.visible=a;const c=ce(n.fontSize)*T.labels.minScreenLengthFontSizeFactor,{label:d}=s;if(o<c**2)return void(d.visible=!1);d.visible=!0;const{dimensionSegment:u,primaryOffsetAxis:f}=t,{offset:g}=this.computation.dimension,_=(Math.sign(g)>=0?1:-1)*yl(n)*r;wo(this._labelSegment,u,f,_),d.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=ce(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;y(e)||y(this._messages)?t.text="":t.text=Ur(this._messages,e,e.unit)}}function yl(i){return 1.5*ce(i.fontSize)+T.labels.marginPx+ce(i.lineSize/2)}const vl=new De,Sl=new De,wl=v();class xl{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}class Pl{constructor(e,t){this._textures=e,this._textureRepository=t,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const t=Hr(this._textures,e),n=new go(this._textureRepository,t.texture.id);return this._texturesByPrimitive.set(e,{result:t,reference:n}),t.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:t})=>{t.dispose(),e.release()}),this._texturesByPrimitive.clear()}}let Se=class extends ye{constructor(i){super(i),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new qn({width:1,anchor:Dr.Tip,color:lt,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:b.OccludeAndTransparent}),this._dimensionLineMaterial=new Re({width:1,color:lt,renderOccluded:b.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new Re({width:1,color:lt,renderOccluded:b.OccludeAndTransparent,stipplePattern:He(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new Re({width:1,color:lt,renderOccluded:b.OccludeAndTransparent}),this._smallOffsetLineMaterial=new Re({width:1,color:lt,renderOccluded:b.OccludeAndTransparent,stipplePattern:He(5),stippleScaleWithLineWidth:!0})}get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}initialize(){const{textures:i}=this.view.sharedSymbolResources;if(m(i)){const{textureRepository:t}=this.view._stage.renderView,n=new Pl(i,t),s=n.acquire("triangle");this.addHandles(Wt(()=>n.destroy())),this._markerMaterial.setParameters({textureId:s.id})}for(const t of this._lineMaterials())this.view._stage.add(t),this.addHandles(Wt(()=>{this.view._stage.remove(t),t.dispose()}));const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles([e.on("change",({added:t,removed:n})=>{for(const s of n)this._removeComputation(s);for(const s of t)this._addComputation(s)}),E(()=>R.toUnitRGBA(this.analysis.style.color),t=>{for(const n of this._lineMaterials())n.setParameters({color:t})},Y),E(()=>this.analysis.style.lineSize,t=>{const n=ce(t);this._markerMaterial.setParameters({width:n*T.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:n,markerParameters:this._markerMaterial.parameters});const s=Math.max(n*T.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:s})},Y),E(()=>({camera:this.view.state.camera,style:El(this.analysis)}),({camera:t,style:n})=>{for(const[s,r]of this._dimensionVisualizations)r.updateCameraDependentElements(t,s.geometry,n),r.updateLabelStyle(n)}),E(()=>this.visible,t=>{for(const n of this._dimensionVisualizations.values())n.visible=t})]),this.addHandles([zr(()=>this._updateMessageBundle()),Ii(()=>!this.loadingMessages,()=>{for(const t of this._dimensionVisualizations.values())t.updateUnitsMessages(this._messages)},it)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(i=>{i.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const i of this._lineMaterials())i.setParameters({renderOccluded:b.Occlude})}}}_addComputation(i){this._dimensionVisualizations.has(i)||this._dimensionVisualizations.set(i,new _l({analysis:this.analysis,computation:i,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(i){const e=this._dimensionVisualizations.get(i);y(e)||(e.destroy(),this._dimensionVisualizations.delete(i))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Vr("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function El(i){const{fontSize:e,lineSize:t,textColor:n,textBackgroundColor:s}=i.style;return{fontSize:e,lineSize:t,textBackgroundColor:s.clone(),textColor:n.clone()}}h([p({constructOnly:!0})],Se.prototype,"analysisViewData",void 0),h([p({constructOnly:!0,nonNullable:!0})],Se.prototype,"view",void 0),h([p()],Se.prototype,"analysis",null),h([p()],Se.prototype,"visible",null),h([p()],Se.prototype,"loadingMessages",void 0),Se=h([N("esri.views.3d.analysis.Dimension.DimensionVisualization")],Se);let ut=class extends ye{constructor(i){super(i),this.dimension=null,this.length=null}};h([p({constructOnly:!0,nonNullable:!0})],ut.prototype,"dimension",void 0),h([p()],ut.prototype,"length",void 0),ut=h([N("esri.views.3d.analysis.LengthDimensionResult")],ut);const Ml=ut;let J=class extends ye{constructor(i){super(i),this.geometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(i){const{dimension:e,...t}=i;return{result:new Ml({dimension:e}),...t}}initialize(){this.addHandles([E(()=>this.dimension.startPoint,i=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(i),Y),E(()=>this.dimension.endPoint,i=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(i),Y)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};h([p({constructOnly:!0,nonNullable:!0})],J.prototype,"result",void 0),h([p({constructOnly:!0,nonNullable:!0})],J.prototype,"projectAndAlignPoint",void 0),h([p()],J.prototype,"dimension",null),h([p()],J.prototype,"length",null),h([p()],J.prototype,"geometry",void 0),h([p()],J.prototype,"elevationAlignedStartPoint",void 0),h([p()],J.prototype,"elevationAlignedEndPoint",void 0),h([p()],J.prototype,"preConstraintProperties",void 0),h([p()],J.prototype,"previousConstraint",void 0),J=h([N("esri.views.3d.analysis.LengthDimensionComputation")],J);const $l=i=>{let e=class extends i{constructor(...t){super(...t),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new ot}createLengthDimensions(t){throw new Error("Method not implemented.")}};return h([p({constructOnly:!0})],e.prototype,"view",void 0),h([p({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),h([p()],e.prototype,"tool",void 0),h([p({readOnly:!0})],e.prototype,"results",null),h([p()],e.prototype,"selectedDimension",void 0),h([p()],e.prototype,"interactive",void 0),h([p()],e.prototype,"visible",void 0),e=h([N("esri.views.analysis.DimensionAnalysisView")],e),e};let Z=class extends $l(Ir(ye)){constructor(i){super(i),this.type="dimension-view-3d",this.tool=null,this.computations=new ot,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=i=>{if(y(i))return null;const{spatialReference:e,elevationProvider:t}=this.view,n=kr(i,e,t);return y(n)&&Fr(this.analysis,i.spatialReference,Ln.getLogger(this.declaredClass)),n},this.addHandles([Kr(this,X),dn(()=>this.analysis.dimensions,"after-add",i=>this._onDimensionAdd(i.item),{onListenerAdd:i=>{for(const e of i)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),dn(()=>this.analysis.dimensions,"after-remove",i=>this._onDimensionRemove(i.item))]),this._analysisVisualization=new Se({analysisViewData:this,view:this.view}),this._analysisController=new Me({analysisViewData:this,view:this.view})}destroy(){this._placementTask=wt(this._placementTask),this._analysisVisualization=gt(this._analysisVisualization),Qr(this)}get updating(){var i,e;return(e=(i=this._analysisVisualization)==null?void 0:i.loadingMessages)!=null?e:!1}get results(){return this.analysis.dimensions.map(i=>this._dimensionsToComputations.get(i).result)}get selectedComputation(){const{selectedDimension:i}=this;return y(i)?null:this._dimensionsToComputations.get(i)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(i){return this.selectedDimension=null,this._placementTask=wt(this._placementTask),this._placementTask=eo(this,i),this._placementTask.promise}_onDimensionAdd(i){const{computations:e,_dimensionsToComputations:t}=this;if(t.has(i))return;const n=new J({dimension:i,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),t.set(i,n)}_onDimensionRemove(i){const{computations:e,_dimensionsToComputations:t}=this,n=e.findIndex(r=>r.dimension===i),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),t.delete(i),gt(s)}_onDimensionsClear(){this.computations.drain(i=>i.destroy()),this._dimensionsToComputations.clear()}};h([p({readOnly:!0})],Z.prototype,"type",void 0),h([p()],Z.prototype,"tool",void 0),h([p()],Z.prototype,"updating",null),h([p({readOnly:!0})],Z.prototype,"results",null),h([p({readOnly:!0})],Z.prototype,"computations",void 0),h([p()],Z.prototype,"selectedDimension",void 0),h([p()],Z.prototype,"selectedComputation",null),h([p()],Z.prototype,"_analysisVisualization",void 0),h([p()],Z.prototype,"_analysisController",void 0),h([p()],Z.prototype,"_dimensionsToComputations",void 0),h([p()],Z.prototype,"_placementTask",void 0),Z=h([N("esri.views.3d.analysis.DimensionAnalysisView3D")],Z);const bl=Z,ql=Object.freeze(Object.defineProperty({__proto__:null,default:bl},Symbol.toStringTag,{value:"Module"}));export{ql as D,Da as N,ji as a,Ui as b,Na as e,Zl as h,Aa as j,U as l,Yl as m,$s as n,Q as s};
